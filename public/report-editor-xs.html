<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excel Report Editor</title>
  <!-- Univer Spreadsheet CDN -->
  <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/rxjs/dist/bundles/rxjs.umd.min.js"></script>
  <script src="https://unpkg.com/@univerjs/umd/lib/univer.full.umd.js"></script>
  <script src="https://unpkg.com/@univerjs/umd/lib/locale/en-US.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/umd/lib/univer.css">
  <style>
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .topbar { display:flex; align-items:center; gap:8px; padding:12px; border-bottom:1px solid #e5e7eb; }
    .topbar .title { font-weight:600; color:#111827; margin-right:auto; }
    .btn { padding:8px 12px; border-radius:6px; font-size:14px; cursor:pointer; border:1px solid transparent; }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn.secondary { background:#fff; color:#111827; border-color:#d1d5db; }
    .status { margin-left:12px; color:#6b7280; font-size:13px; }
    #sheet { position:absolute; top:54px; left:0; right:0; bottom:0; }
    .univer-container { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Excel Editor</div>
    <button id="btnSave" class="btn primary">Save</button>
    <button id="btnRecalc" class="btn secondary">Recalculate totals</button>
    <button id="btnRevert" class="btn secondary">Back to Reports</button>
    <button id="btnDownload" class="btn secondary">Download Excel</button>
    <span id="status" class="status"></span>
  </div>
  <div id="sheet"></div>

  <!-- College selection modal for saving when opened from uploads -->
  <div id="selectCollegeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:99999;">
    <div style="background:#fff; padding:16px; border-radius:8px; width:90%; max-width:420px; box-shadow:0 10px 25px rgba(0,0,0,0.15);">
      <h3 style="margin:0 0 8px; font-weight:600; color:#111827;">Select College</h3>
      <p style="margin:0 0 12px; color:#4b5563; font-size:14px;">Choose a college to save this report to.</p>
      <select id="collegePicker" style="width:100%; border:1px solid #d1d5db; border-radius:6px; padding:8px; margin-bottom:12px;"></select>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cancelCollegeSelect" class="btn secondary">Cancel</button>
        <button id="confirmCollegeSelect" class="btn primary">Continue</button>
      </div>
    </div>
  </div>

  <script>
    // Helper: status text
    const qs = new URLSearchParams(location.search);
    const collegeId = qs.get('collegeId');
    const reportId = qs.get('reportId');
    const statusEl = document.getElementById('status');
    const modal = document.getElementById('selectCollegeModal');
    const collegePicker = document.getElementById('collegePicker');

    function setStatus(msg, type = 'info') {
      statusEl.textContent = msg;
      statusEl.style.color = type === 'error' ? '#b91c1c' : (type === 'success' ? '#065f46' : '#6b7280');
    }

    // Univer instance
    let univer = null;
    let univerAPI = null;

    // Define styles for different sections (matching the dashboard)
    function getSectionColor(header) {
      const headerLower = header.toLowerCase();
      
      if (headerLower.includes('(enrichment)') || headerLower.includes('enrichment')) {
        return { bgcolor: '#bfdbfe', color: '#1e3a8a' }; // Blue
      }
      if (headerLower.includes('(employer)') || (headerLower.includes('employer') && headerLower.includes('activit'))) {
        return { bgcolor: '#f3e8ff', color: '#6b21a8' }; // Purple
      }
      if (headerLower.includes('(placements)') || headerLower.includes('placement') || headerLower.includes('placed')) {
        return { bgcolor: '#dbeafe', color: '#1e40af' }; // Light blue
      }
      if (headerLower.includes('(careers)') || headerLower.includes('career') || headerLower.includes('quiz')) {
        return { bgcolor: '#fef3c7', color: '#92400e' }; // Yellow
      }
      if (headerLower.includes('(assessments)') || headerLower.includes('assessment')) {
        return { bgcolor: '#bbf7d0', color: '#14532d' }; // Green
      }
      if (headerLower.includes('(targets)') || headerLower.includes('target')) {
        return { bgcolor: '#fce7f3', color: '#be185d' }; // Pink
      }
      if (headerLower.includes('(login)') || headerLower.includes('login')) {
        return { bgcolor: '#e0e7ff', color: '#3730a3' }; // Indigo
      }
      
      return { bgcolor: '#f3f4f6', color: '#374151' }; // Default gray
    }

    function getPercentageColor(value) {
      const numValue = parseFloat(value);
      if (isNaN(numValue)) return { bgcolor: '#ffffff', color: '#000000' };
      
      if (numValue < 0.4) {
        return { bgcolor: '#ffebee', color: '#c62828' }; // Light red background
      } else if (numValue >= 0.4 && numValue <= 0.7) {
        return { bgcolor: '#fff3e0', color: '#e65100' }; // Light orange background
      } else {
        return { bgcolor: '#e8f5e8', color: '#2e7d32' }; // Light green background
      }
    }

    function applyFormattingToSpreadsheet(headers, rows) {
      if (!spreadsheet) {
        console.log('Spreadsheet not available for formatting');
        return;
      }
      
      console.log('Applying formatting to spreadsheet...', headers.length, 'headers,', rows.length, 'rows');
      
      try {
        // Apply header formatting
        for (let c = 0; c < headers.length; c++) {
          const header = headers[c] || '';
          const sectionColor = getSectionColor(header);
          console.log(`Header ${c}: "${header}" -> ${sectionColor.bgcolor}`);
          spreadsheet.cellStyle(0, c, {
            bgcolor: sectionColor.bgcolor,
            color: sectionColor.color,
            font: { bold: true, size: 12 },
            align: 'center'
          });
        }
        
        // Apply data row formatting
        for (let r = 0; r < rows.length; r++) {
          const row = rows[r] || [];
          for (let c = 0; c < row.length; c++) {
            const val = row[c];
            const header = headers[c] || '';
            
            // Apply percentage colors for percentage columns
            if ((header.toLowerCase().includes('percent') || header.includes('%')) && 
                typeof val === 'number' && val >= 0 && val <= 1) {
              const percentColor = getPercentageColor(val);
              console.log(`Cell ${r+1},${c}: ${val} -> ${percentColor.bgcolor}`);
              spreadsheet.cellStyle(r + 1, c, {
                bgcolor: percentColor.bgcolor,
                color: percentColor.color,
                font: { size: 10 },
                align: 'center'
              });
            }
          }
        }
        console.log('Formatting applied successfully');
      } catch (e) {
        console.error('Error applying formatting:', e);
      }
    }

    function createUniverWorkbook(headers, rows) {
      const cellData = {};
      
      // Convert data to Univer format
      headers.forEach((header, c) => {
        cellData[`${c}_0`] = {
          v: header,
          t: 1, // text type
          s: `header_${c}` // style reference
        };
      });
      
      rows.forEach((row, r) => {
        row.forEach((val, c) => {
          const cellKey = `${c}_${r + 1}`;
          cellData[cellKey] = {
            v: val,
            t: typeof val === 'number' ? 2 : 1 // number or text type
          };
        });
      });
      
      return {
        id: 'report-workbook',
        appVersion: '3.0.0-alpha',
        sheets: {
          'sheet1': {
            id: 'sheet1',
            name: 'Report',
            tabColor: '',
            hidden: 0,
            rowCount: rows.length + 1,
            columnCount: headers.length,
            cellData: cellData,
            scrollTop: 0,
            scrollLeft: 0,
            offsetTop: 0,
            offsetLeft: 0,
            selection: {
              row: [0, 0],
              column: [0, 0]
            },
            rightToLeft: 0
          }
        },
        locale: 'en_US',
        styles: {}
      };
    }
    
    function applyDataBarsToUniver(headers, rows) {
      if (!univerAPI) return;
      
      console.log('Applying data bars to Univer...');
      
      try {
        const activeWorkbook = univerAPI.getActiveWorkbook();
        const worksheet = activeWorkbook.getActiveSheet();
        
        // Apply header formatting
        for (let c = 0; c < headers.length; c++) {
          const header = headers[c] || '';
          const sectionColor = getSectionColor(header);
          const range = worksheet.getRange(0, c);
          
          range.setBackgroundColor(sectionColor.bgcolor);
          range.setFontColor(sectionColor.color);
          range.setFontWeight('bold');
          range.setHorizontalAlignment(1); // center
        }
        
        // Apply data bars for percentage columns
        for (let c = 0; c < headers.length; c++) {
          const header = headers[c] || '';
          if (header.toLowerCase().includes('percent') || header.includes('%')) {
            const range = worksheet.getRange(1, c, rows.length, 1);
            
            // Create data bar conditional formatting
            const rule = worksheet.newConditionalFormattingRule()
              .setRanges([range])
              .whenCellNotEmpty();
              
            // Apply data bar
            rule.setDataBar('#3B82F6'); // Blue data bars
            rule.build();
          }
        }
        
        console.log('Data bars applied successfully');
      } catch (e) {
        console.error('Error applying data bars:', e);
      }
    }

    function fromUniver() {
      if (!univerAPI) return { headers: [], rows: [] };
      
      try {
        const activeWorkbook = univerAPI.getActiveWorkbook();
        const worksheet = activeWorkbook.getActiveSheet();
        const sheetData = worksheet.getSheetData();
        
        // Extract data from Univer format
        const maxRow = Math.max(...Object.keys(sheetData.cellData).map(key => parseInt(key.split('_')[1])));
        const maxCol = Math.max(...Object.keys(sheetData.cellData).map(key => parseInt(key.split('_')[0])));
        
        const allRows = [];
        for (let r = 0; r <= maxRow; r++) {
          const row = [];
          for (let c = 0; c <= maxCol; c++) {
            const cellKey = `${c}_${r}`;
            const cell = sheetData.cellData[cellKey];
            row[c] = cell ? cell.v : '';
          }
          allRows.push(row);
        }
        
        const headers = allRows[0] || [];
        const rows = allRows.slice(1);
        return { headers, rows };
      } catch (e) {
        console.error('Error extracting data from Univer:', e);
        return { headers: [], rows: [] };
      }
    }

    async function loadReport() {
      // Initialize Univer
      const { Univer, UniverInstanceType, LocaleType } = window.UniverCore;
      
      univer = new Univer({
        theme: window.UniverDesign.defaultTheme,
        locale: LocaleType.EN_US,
        locales: {
          [LocaleType.EN_US]: window.UniverPresetSheetsCore.UniverSheetsUIEnUS,
        },
      });

      univer.registerPlugin(window.UniverRenderEngine.UniverRenderEnginePlugin);
      univer.registerPlugin(window.UniverUI.UniverUIPlugin, {
        container: 'sheet',
      });
      univer.registerPlugin(window.UniverSheets.UniverSheetsPlugin);
      univer.registerPlugin(window.UniverSheetsUI.UniverSheetsUIPlugin);
      univer.registerPlugin(window.UniverSheetsFormula.UniverSheetsFormulaPlugin);

      // 1) Load by IDs if provided
      if (collegeId && reportId) {
        try {
          setStatus('Loading report...');
          const res = await fetch(`/api/colleges/${collegeId}/reports/${reportId}`, { credentials: 'include' });
          const json = await res.json();
          if (!json.success || !json.report || !json.report.data) throw new Error('Report not found');
          const { headers = [], rows = [] } = json.report.data;
          const workbookData = createUniverWorkbook(headers, rows);
          
          univer.createUnit(UniverInstanceType.UNIVER_SHEET, workbookData);
          univerAPI = window.FUniver.newAPI(univer);
          
          // Apply data bars after loading
          setTimeout(() => {
            applyDataBarsToUniver(headers, rows);
          }, 500);
          
          setStatus('Loaded');
          return;
        } catch (e) {
          console.error(e);
          setStatus(`Load failed: ${e.message}`, 'error');
          return;
        }
      }

      // 2) Fallback: load from localStorage (Generate Report flow)
      const cached = localStorage.getItem('excelEditorData');
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          const headers = parsed.headers || [];
          const rows = parsed.rows || [];
          
          // Store template metadata globally for use in save operations
          window.__currentTemplate = {
            id: parsed.templateId || null,
            name: parsed.templateName || null,
            description: parsed.templateDescription || null,
            isTemplate: parsed.isTemplate === true
          };
          const workbookData = createUniverWorkbook(headers, rows);
          univer.createUnit(UniverInstanceType.UNIVER_SHEET, workbookData);
          univerAPI = window.FUniver.newAPI(univer);
          
          setTimeout(() => {
            applyDataBarsToUniver(headers, rows);
          }, 500);
          
          setStatus('Loaded from upload');
          return;
        } catch (e) {
          console.error(e);
        }
      }
      
      // Initialize empty template state for new/empty editors
      window.__currentTemplate = {
        id: null,
        name: null,
        description: null,
        isTemplate: false
      };
      
      // Initialize empty Univer instance
      const { Univer, UniverInstanceType } = window.UniverCore;
      
      if (!univer) {
        univer = new Univer({
          theme: window.UniverDesign.defaultTheme,
          locale: 'en_US',
        });

        univer.registerPlugin(window.UniverRenderEngine.UniverRenderEnginePlugin);
        univer.registerPlugin(window.UniverUI.UniverUIPlugin, {
          container: 'sheet',
        });
        univer.registerPlugin(window.UniverSheets.UniverSheetsPlugin);
        univer.registerPlugin(window.UniverSheetsUI.UniverSheetsUIPlugin);
        univer.registerPlugin(window.UniverSheetsFormula.UniverSheetsFormulaPlugin);
        
        // Create empty workbook
        const emptyWorkbook = createUniverWorkbook(['Column 1'], [['']]);
        univer.createUnit(UniverInstanceType.UNIVER_SHEET, emptyWorkbook);
        univerAPI = window.FUniver.newAPI(univer);
      }
      
      setStatus('Ready - No source data provided');
    }

    async function saveReport() {
      try {
        setStatus('Saving...');
        const { headers, rows } = fromUniver();
        let targetCollegeId = collegeId;
        if (!targetCollegeId) {
          await populateCollegePicker();
          modal.style.display = 'flex';
          const chosen = await awaitCollegeSelection();
          modal.style.display = 'none';
          if (!chosen) {
            setStatus('Save cancelled', 'error');
            return;
          }
          targetCollegeId = chosen;
        }
        const payload = { reportData: { headers, rows }, reportName: 'Edited Report', summary: 'Edited in Excel editor (x-sheet)' };
        const res = await fetch(`/api/colleges/${targetCollegeId}/reports`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Save failed');
        await fetch(`/api/reports/${targetCollegeId}/recalculate`, { method: 'POST', credentials: 'include' });
        setStatus('Saved and recalculated', 'success');
        localStorage.removeItem('excelEditorData');
        try { showPostSaveOptions(targetCollegeId); } catch (_) {}
      } catch (e) {
        console.error(e);
        setStatus(`Save failed: ${e.message}`, 'error');
      }
    }

    function revertToClassic() {
      try {
        const { headers, rows } = fromUniver();
        localStorage.setItem('excelEditorData', JSON.stringify({ headers, rows }));
      } catch (_) { /* ignore */ }
      window.location.href = 'index.html?tab=reports';
    }

    async function populateCollegePicker() {
      try {
        collegePicker.innerHTML = '<option value="">Loading colleges...</option>';
        const res = await fetch('/api/colleges', { credentials: 'include' });
        const json = await res.json();
        const colleges = Array.isArray(json.colleges) ? json.colleges : json;
        collegePicker.innerHTML = '<option value="">Select a college...</option>' +
          colleges.map(c => `<option value="${c.id}">${c.name || c.collegename || ('College ' + c.id)}</option>`).join('');
      } catch (e) {
        collegePicker.innerHTML = '<option value="">Failed to load colleges</option>';
      }
    }

    function awaitCollegeSelection() {
      return new Promise(resolve => {
        const confirmBtn = document.getElementById('confirmCollegeSelect');
        const cancelBtn = document.getElementById('cancelCollegeSelect');
        function cleanup(value) {
          confirmBtn.removeEventListener('click', onConfirm);
          cancelBtn.removeEventListener('click', onCancel);
          resolve(value);
        }
        function onConfirm() {
          const val = collegePicker.value;
          cleanup(val || null);
        }
        function onCancel() { cleanup(null); }
        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
      });
    }

    document.getElementById('btnSave').addEventListener('click', saveReport);
    document.getElementById('btnRecalc').addEventListener('click', async () => {
      try {
        setStatus('Recalculating...');
        const idForRecalc = collegeId || (localStorage.getItem('currentCollegeId') || '').trim();
        if (!idForRecalc) throw new Error('Select a college first');
        await fetch(`/api/reports/${idForRecalc}/recalculate`, { method: 'POST', credentials: 'include' });
        setStatus('Recalculated', 'success');
      } catch (e) {
        console.error(e);
        setStatus(`Recalc failed: ${e.message}`, 'error');
      }
    });
    document.getElementById('btnRevert').addEventListener('click', revertToClassic);

    // Inject Save as Template button
    (function addSaveTemplateBtn(){
      const topbar = document.querySelector('.topbar');
      if (!topbar) return;
      const btn = document.createElement('button');
      btn.textContent = 'Save as Template';
      btn.className = 'btn secondary';
      btn.id = 'btnSaveTemplate';
      btn.style.marginLeft = '8px';
      btn.onclick = async () => {
        try {
          const { headers, rows } = fromUniver();
          
          // Check if we're updating an existing template
          const isUpdatingTemplate = window.__currentTemplate && window.__currentTemplate.isTemplate && window.__currentTemplate.id;
          
          let name, description, templateId;
          
          if (isUpdatingTemplate) {
            // Updating existing template - pre-populate with current values
            name = prompt('Enter template name:', window.__currentTemplate.name || '');
            if (!name) return;
            description = prompt('Optional description:', window.__currentTemplate.description || '') || '';
            templateId = window.__currentTemplate.id;
          } else {
            // Creating new template
            name = prompt('Enter template name:');
            if (!name) return;
            description = prompt('Optional description:') || '';
            templateId = null;
          }
          
          const payload = { 
            name, 
            description, 
            headers, 
            tableData: rows
          };
          
          // Include template ID if updating
          if (templateId) {
            payload.id = templateId;
            payload.createdAt = window.__currentTemplate.createdAt; // Preserve creation date
          }
          
          const res = await fetch('/api/save-template', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          const json = await res.json();
          if (!json.success) throw new Error(json.error || 'Template save failed');
          
          // Use the action from backend response, fallback to frontend detection
          const action = json.action === 'updated' ? 'updated' : 
                        json.action === 'created' ? 'created' : 
                        (isUpdatingTemplate ? 'updated' : 'saved');
          
          setStatus(`Template ${action} successfully`, 'success');
          
          // Update the current template state with the saved template info
          if (json.template) {
            window.__currentTemplate = {
              id: json.template.id,
              name: json.template.name,
              description: json.template.description || '',
              isTemplate: true,
              createdAt: json.template.createdAt,
              updatedAt: json.template.updatedAt
            };
          }
        } catch (e) {
          console.error(e);
          setStatus(`Template save failed: ${e.message}`, 'error');
        }
      };
      const status = document.getElementById('status');
      topbar.insertBefore(btn, status);
    })();

    // Post-save options modal
    function showPostSaveOptions(collegeId) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:999999;';
      const collegeBtn = collegeId ? '<button id="goCollege" class="btn secondary">Open College Dashboard</button>' : '';
      modal.innerHTML = `
        <div style="background:#fff; padding:16px; border-radius:8px; width:90%; max-width:420px; box-shadow:0 10px 25px rgba(0,0,0,0.15);">
          <h3 style="margin:0 0 8px; font-weight:600; color:#111827;">Report saved</h3>
          <p style="margin:0 0 12px; color:#4b5563; font-size:14px;">What would you like to do next?</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="goReports" class="btn secondary">Go to Reports</button>
            ${collegeBtn}
            <button id="closePostSave" class="btn primary">Close</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.querySelector('#closePostSave').onclick = () => modal.remove();
      modal.querySelector('#goReports').onclick = () => { window.location.href = 'index.html?tab=reports'; };
      if (collegeId) {
        const btn = modal.querySelector('#goCollege');
        if (btn) btn.onclick = () => { window.location.href = `college-dashboard.html?id=${collegeId}&tab=reports`; };
      }
    }

    // Download button - export via backend to preserve formatting
    document.getElementById('btnDownload').addEventListener('click', async () => {
      try {
        setStatus('Preparing Excel...', 'info');
        const { headers, rows } = fromUniver();
        const payload = { headers, rows, name: 'Edited Report', createdAt: new Date().toISOString() };
        const res = await fetch('/api/export-excel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Export failed');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'report.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus('Downloaded', 'success');
      } catch (e) {
        console.error(e);
        setStatus(`Download failed: ${e.message}`, 'error');
      }
    });

    loadReport();
  </script>
</body>
</html>


