<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shared Reports - View Only</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:#f7f9fc; color:#111; }
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; background:#fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
    h1 { font-size: 20px; margin: 0; }
    .meta { color:#555; font-size: 14px; }
    /* banner removed per requirement */
    .controls { display:flex; gap:8px; margin: 12px 0; }
    .controls input, .controls select { padding: 8px 10px; border:1px solid #d0d7de; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eef2f7; font-size: 14px; }
    th { background:#fafbfc; font-weight: 600; color:#333; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#f1f5f9; color:#334155; }
    .btn { appearance:none; border:1px solid #cbd5e1; background:#fff; color:#111; padding:8px 12px; border-radius:8px; cursor:pointer; font-size:14px; }
    .btn:hover { background:#f8fafc; }
    .btn.primary { background:#2563eb; border-color:#1d4ed8; color:#fff; }
    .btn.primary:hover { background:#1d4ed8; }
    .muted { color:#64748b; font-size: 12px; }
    .hidden { display:none; }
    .pill { padding: 2px 8px; border-radius: 999px; background: #eef2ff; color:#3730a3; font-size: 12px; border:1px solid #e0e7ff; }
    .error { background:#fff1f2; border:1px solid #fecdd3; color:#9f1239; padding: 10px 12px; border-radius:8px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function init() {
      const token = getQueryParam('token');
      const collegeId = getQueryParam('collegeId');
      const statusEl = document.getElementById('status');
      const tableBody = document.getElementById('reports-body');
      const filterInput = document.getElementById('filter');
      const collegeNameEl = document.getElementById('college-name');
      const reportView = document.getElementById('report-view');

      if (!token || !collegeId) {
        statusEl.innerHTML = '<div class="error">Missing token or collegeId.</div>';
        return;
      }

      try {
        const v = await axios.get(`/api/shared/validate`, { params: { token } });
        const payload = v.data?.payload;
        if (!v.data.success || !payload) throw new Error('Invalid token');
        // Fetch the actual college name for display
        try {
          const c = await axios.get(`/api/shared/colleges/${collegeId}`, { params: { token } });
          if (c.data?.success && c.data.college?.name) {
            collegeNameEl.textContent = c.data.college.name;
          } else {
            collegeNameEl.textContent = `College`;
          }
        } catch (_) {
          collegeNameEl.textContent = `College`;
        }
      } catch (e) {
        statusEl.innerHTML = '<div class="error">This link is invalid or has expired.</div>';
        return;
      }

      let allReports = [];
      async function loadReports() {
        statusEl.textContent = 'Loading reports...';
        const res = await axios.get(`/api/shared/colleges/${collegeId}/reports`, { params: { token, _t: Date.now() } });
        if (!res.data.success) throw new Error('Failed');
        allReports = res.data.reports || [];
        render(allReports);
        statusEl.textContent = '';
      }

      function render(list) {
        tableBody.innerHTML = '';
        const filtered = list;
        for (const r of filtered) {
          const tr = document.createElement('tr');
          const created = new Date(r.createdAt).toLocaleString();
          tr.innerHTML = `
            <td>${r.name || 'Report'}</td>
            <td><span class="tag">${created}</span></td>
            <td>${r.summary ? r.summary : '<span class="muted">No summary</span>'}</td>
            <td style="text-align:right;">
              <button class="btn" data-id="${r.id}">View</button>
              <a class="btn" href="/api/shared/colleges/${collegeId}/reports/${r.id}/excel?token=${encodeURIComponent(getQueryParam('token'))}">Download Excel</a>
            </td>
          `;
          tableBody.appendChild(tr);
        }

        // Attach view handlers
        Array.from(tableBody.querySelectorAll('button.btn[data-id]')).forEach(btn => {
          btn.addEventListener('click', () => openReport(btn.dataset.id));
        });
      }

      async function openReport(reportId) {
        try {
          statusEl.textContent = 'Loading report...';
          const res = await axios.get(`/api/shared/colleges/${collegeId}/reports/${reportId}`, { params: { token } });
          const json = res.data;
          if (!json.success || !json.report || !json.report.data) throw new Error('Report not found');
          await loadSharedPreviousReport(collegeId, json.report.createdAt, token);
          renderReport(json.report);
          statusEl.textContent = '';
        } catch (e) {
          statusEl.innerHTML = '<div class="error">Failed to load report.</div>';
        }
      }

      function renderReport(report) {
        const created = new Date(report.createdAt).toLocaleString();
        const html = `
          <div style="padding:16px;margin-top:16px;background:#fff;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px;flex-wrap:wrap;">
              <div>
                <h2 style="font-size:20px;margin:0;">${report.name || 'Report'}</h2>
                <div class="muted" style="margin-top:4px;">Created: ${created}</div>
                ${report.summary ? `<div class="muted">Summary: ${report.summary}</div>` : ''}
              </div>
              <div>
                <a class="btn" href="/api/shared/colleges/${encodeURIComponent(getQueryParam('collegeId'))}/reports/${encodeURIComponent(report.id)}/excel?token=${encodeURIComponent(getQueryParam('token'))}">Download Excel</a>
              </div>
            </div>
            <div id="reportDataContainer"></div>
          </div>`;
        reportView.innerHTML = html;
        displayReportData(report);
        reportView.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      async function loadSharedPreviousReport(collegeId, currentReportDate, token) {
        try {
          const res = await axios.get(`/api/shared/colleges/${collegeId}/reports`, { params: { token, _t: Date.now() } });
          const list = res.data?.reports || [];
          const sorted = list.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
          const idx = sorted.findIndex(r => new Date(r.createdAt).getTime() === new Date(currentReportDate).getTime());
          if (idx >= 0 && idx < sorted.length - 1) {
            const prev = await axios.get(`/api/shared/colleges/${collegeId}/reports/${sorted[idx+1].id}`, { params: { token } });
            if (prev.data?.success && prev.data.report?.data) {
              window.previousReportData = prev.data.report.data;
            } else { window.previousReportData = null; }
          } else { window.previousReportData = null; }
        } catch (_) { window.previousReportData = null; }
      }

      function getColumnSection(header) {
        const headerLower = (header || '').toLowerCase();
        const colors = { placements: '#dbeafe', enrichment: '#bfdbfe', employment: '#f3e8ff', careers: '#fef3c7', activities: '#fef3c7', assessments: '#bbf7d0', targets: '#fce7f3', login: '#e0e7ff', default: '#f3f4f6' };
        let type = 'default';
        if (headerLower.includes('enrichment')) type = 'enrichment';
        else if (headerLower.includes('employer') || headerLower.includes('employment')) type = 'employment';
        else if (headerLower.includes('career')) type = 'careers';
        else if (headerLower.includes('activity')) type = 'activities';
        else if (headerLower.includes('assessment')) type = 'assessments';
        else if (headerLower.includes('target')) type = 'targets';
        else if (headerLower.includes('login')) type = 'login';
        else if (headerLower.includes('placement')) type = 'placements';
        return { inlineColor: `background-color: ${colors[type]}; border-color: ${colors[type]};` };
      }

      function displayReportData(reportData) {
        const container = document.getElementById('reportDataContainer');
        if (!reportData || !reportData.data) { container.innerHTML = '<div class="muted">No data available in this report</div>'; return; }
        const { headers = [], rows = [] } = reportData.data;
        if (!headers.length || !rows.length) { container.innerHTML = '<div class="muted">No data available in this report</div>'; return; }

        // Build headers including change columns
        let completeHeaders = [];
        headers.forEach(h => { completeHeaders.push(h); if (h !== 'Department') completeHeaders.push(`${h} +/-`); });
        const headerCells = completeHeaders.map(h => { const isChange = h.endsWith(' +/-'); const base = isChange ? h.slice(0,-4) : h; const section = getColumnSection(base); return `<th style="padding:10px;text-align:left;border-bottom:1px solid #eef2f7;${section.inlineColor}">${h}</th>`; }).join('');

        // Totals
        const totals = {}; headers.forEach((header, colIndex) => { if (colIndex === 0 || header.toLowerCase().includes('department')) { totals[colIndex] = ''; } else { let total = 0; let has=false; rows.forEach(row => { if (row[colIndex] !== '' && row[colIndex] !== null && !isNaN(parseFloat(row[colIndex]))) { total += parseFloat(row[colIndex]); has=true; } }); if (has) { if (header.toLowerCase().includes('percent') || header.includes('%')) { const validRows = rows.filter(r => r[colIndex] !== '' && r[colIndex] !== null && !isNaN(parseFloat(r[colIndex]))); totals[colIndex] = validRows.length > 0 ? total / validRows.length : 0; } else { totals[colIndex] = total; } } else { totals[colIndex] = ''; } } });

        const bodyRows = rows.map((row, rowIdx) => { let cells = []; headers.forEach((header, originalColIdx) => { const cell = row[originalColIdx]; let displayValue = cell; let percentageBar=''; let align='left'; if (header && (header.toLowerCase().includes('percent') || header.includes('%'))) { if (typeof cell === 'number' || !isNaN(parseFloat(cell))) { let percentage = parseFloat(cell) <= 1 ? parseFloat(cell) * 100 : parseFloat(cell); displayValue = percentage.toFixed(1) + '%'; align='right'; const width = Math.min(percentage, 100); let barColor = '#22c55e'; if (percentage < 40) barColor = '#ef4444'; else if (percentage >= 40 && percentage <= 70) barColor = '#f59e0b'; percentageBar = `<div style=\"margin-top:4px;width:100%;background:#e5e7eb;border-radius:999px;height:8px;\"><div style=\"height:8px;border-radius:999px;width:${width}%;background:${barColor};\"></div></div>`; } } else if (typeof cell === 'number' || (!isNaN(parseFloat(cell)) && cell !== '')) { displayValue = parseFloat(cell).toLocaleString(); align='right'; } cells.push(`<td style=\"padding:10px;border-bottom:1px solid #eef2f7;text-align:${align};\"><div>${displayValue ?? ''}</div>${percentageBar}</td>`);
          const prev = window.previousReportData; let changeIndicator = '<span style="display:inline-block;padding:2px 8px;border-radius:6px;background:#f3f4f6;color:#4b5563;font-size:12px;">N/A</span>'; if (prev && prev.rows) { const previousRow = prev.rows.find(r => r[0] === row[0]); if (previousRow && previousRow[originalColIdx] !== undefined) { const currentValue = parseFloat(cell) || 0; const previousValue = parseFloat(previousRow[originalColIdx]) || 0; const change = currentValue - previousValue; if (!isNaN(change)) { const changeText = (change > 0 ? '+' : '') + change.toFixed(1); const bg = change > 0 ? '#dcfce7' : '#fee2e2'; const fg = change > 0 ? '#16a34a' : '#dc2626'; changeIndicator = `<span style=\\\"display:inline-block;padding:2px 8px;border-radius:6px;background:${bg};color:${fg};font-size:12px;\\\">${changeText}</span>`; } } } cells.push(`<td style=\"padding:10px;border-bottom:1px solid #eef2f7;text-align:center;\">${changeIndicator}</td>`); }); const bg = rowIdx % 2 === 0 ? '#ffffff' : '#f9fafb'; return `<tr style=\"background:${bg}\">${cells.join('')}</tr>`; }).join('');

        // Totals row
        let totalsRowCells = []; headers.forEach((header, originalColIdx) => { const totalValue = totals[originalColIdx]; let displayTotal=''; let align='left'; let percentageBar=''; if (originalColIdx === 0) { displayTotal='TOTAL'; } else if (header.toLowerCase().includes('department')) { displayTotal=''; } else if (totalValue !== '') { if (header.toLowerCase().includes('percent') || header.includes('%')) { displayTotal = totalValue.toFixed(1) + '%'; align='right'; const width = Math.min(totalValue, 100); let barColor = '#22c55e'; if (totalValue < 40) barColor = '#ef4444'; else if (totalValue >= 40 && totalValue <= 70) barColor = '#f59e0b'; percentageBar = `<div style=\\\"margin-top:4px;width:100%;background:#e5e7eb;border-radius:999px;height:8px;\\\"><div style=\\\"height:8px;border-radius:999px;width:${width}%;background:${barColor};\\\"></div></div>`; } else { displayTotal = Number(totalValue).toLocaleString(); align='right'; } } totalsRowCells.push(`<td style=\"padding:10px;border-top:2px solid #e5e7eb;border-bottom:1px solid #eef2f7;background:#f9fafb;text-align:${align};font-weight:600;color:#475569;\">${displayTotal}${percentageBar}</td>`); totalsRowCells.push(`<td style=\"padding:10px;border-top:2px solid #e5e7eb;border-bottom:1px solid #eef2f7;background:#f9fafb;text-align:center;font-weight:600;color:#2563eb;\"></td>`); });

        const tableHTML = `<div style=\"overflow:auto;border:1px solid #e5e7eb;border-radius:10px;\"><table style=\"width:100%;border-collapse:collapse;\"><thead><tr>${headerCells}</tr></thead><tbody>${bodyRows}<tr>${totalsRowCells.join('')}</tr></tbody></table></div>`;
        container.innerHTML = tableHTML;
      }

      filterInput.addEventListener('input', () => {
        const q = filterInput.value.toLowerCase().trim();
        if (!q) return render(allReports);
        const filtered = allReports.filter(r =>
          (r.name || '').toLowerCase().includes(q) ||
          (r.summary || '').toLowerCase().includes(q)
        );
        render(filtered);
      });

      try {
        await loadReports();
      } catch (e) {
        statusEl.innerHTML = '<div class="error">Failed to load reports. The link may be invalid or expired.</div>';
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="college-name">College</h1>
      <div class="pill">View-only access</div>
    </header>

    <div class="meta"></div>
    <div id="status" class="muted" style="margin-top:8px;">Loading...</div>

    <div class="controls">
      <input id="filter" type="search" placeholder="Filter reports by name or summary" />
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:30%">Name</th>
          <th style="width:20%">Created</th>
          <th>Summary</th>
          <th style="width:220px; text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody id="reports-body"></tbody>
    </table>

    <div id="report-view"></div>
  </div>
</body>
</html>


