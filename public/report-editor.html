<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excel Report Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css" />
  <style>
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .topbar { display:flex; align-items:center; gap:8px; padding:12px; border-bottom:1px solid #e5e7eb; }
    .topbar .title { font-weight:600; color:#111827; margin-right:auto; }
    .btn { padding:8px 12px; border-radius:6px; font-size:14px; cursor:pointer; border:1px solid transparent; }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn.secondary { background:#fff; color:#111827; border-color:#d1d5db; }
    .status { margin-left:12px; color:#6b7280; font-size:13px; }
    #luckysheet { position:absolute; top:54px; left:0; right:0; bottom:0; }
    /* Improve readability: force dark text throughout grid */
    #luckysheet, #luckysheet * { color:#111 !important; }
    .luckysheet-cell-input, .luckysheet-input-box * { color:#111 !important; }
    .luckysheet-cell-main, .luckysheet-rows, .luckysheet-cols { background:#fff !important; }
    /* Force toolbar/menu text and icons to dark */
    .luckysheet-wa-toolbar-container *,
    .luckysheet-toolbar-menu *,
    .luckysheet-titlebar *,
    .luckysheet-bottom-controll *,
    .luckysheet-sheet-area * {
      color:#111 !important;
      fill:#111 !important;
    }
    .luckysheet-wa-editor * { color:#111 !important; }
    .luckysheet-toolbar-button, .luckysheet-toolbar-button * { color:#111 !important; fill:#111 !important; }
    .luckysheet-toolbar-select .selectbox div, .luckysheet-toolbar-select .selectbox span { color:#111 !important; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Excel Editor</div>
    <button id="btnSave" class="btn primary">Save</button>
    <button id="btnRecalc" class="btn secondary">Recalculate totals</button>
    <button id="btnRevert" class="btn secondary">Back to Reports</button>
    <span id="status" class="status"></span>
  </div>
  <div id="luckysheet"></div>

  <!-- College selection modal for saving when opened from uploads -->
  <div id="selectCollegeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center; z-index:99999;">
    <div style="background:#fff; padding:16px; border-radius:8px; width:90%; max-width:420px; box-shadow:0 10px 25px rgba(0,0,0,0.15);">
      <h3 style="margin:0 0 8px; font-weight:600; color:#111827;">Select College</h3>
      <p style="margin:0 0 12px; color:#4b5563; font-size:14px;">Choose a college to save this report to.</p>
      <select id="collegePicker" style="width:100%; border:1px solid #d1d5db; border-radius:6px; padding:8px; margin-bottom:12px;"></select>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button id="cancelCollegeSelect" class="btn secondary">Cancel</button>
        <button id="confirmCollegeSelect" class="btn primary">Continue</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>
  <script>
    // Inject late CSS with very high specificity to override theme/inline classes
    (function injectToolbarFixStyles() {
      try {
        const style = document.createElement('style');
        style.id = 'luckysheet-readable-style';
        style.textContent = `
          /* Force readable toolbar/title/menu text and light backgrounds */
          .luckysheet-wa-toolbar-container, .luckysheet-toolbar, .luckysheet-titlebar, .luckysheet-toolbar-menu, .luckysheet-bottom-controll, .luckysheet-wa-editor, .luckysheet-formula-bar, .luckysheet-input-box { background:#ffffff !important; color:#111111 !important; }
          .luckysheet-wa-toolbar-container *, .luckysheet-toolbar *, .luckysheet-titlebar *, .luckysheet-toolbar-menu *, .luckysheet-bottom-controll *, .luckysheet-wa-editor *, .luckysheet-formula-bar *, .luckysheet-input-box * { color:#111111 !important; fill:#111111 !important; }
          /* Popover/dropdown menus */
          .luckysheet-menuButton-menu, .luckysheet-colorSelectBox, .luckysheet-dynamic-tool, .luckysheet-insertFormula-cache, .luckysheet-cols-menu, .luckysheet-rows-menu, .luckysheet-sheetArea-c { background:#ffffff !important; color:#111111 !important; }
          .luckysheet-toolbar-button, .luckysheet-toolbar-button *, .luckysheet-button, .luckysheet-button * { color:#111111 !important; fill:#111111 !important; }
          /* Ensure grid areas remain light */
          #luckysheet, #luckysheet * { color:#111111 !important; }
          .luckysheet-cell-main, .luckysheet-rows, .luckysheet-cols, .luckysheet-grid-window, .luckysheet-grid-container { background:#ffffff !important; }
        `;
        document.head.appendChild(style);
      } catch (_) {}
    })();

    // As some Luckysheet components apply inline styles dynamically, also set inline styles programmatically
    function forceToolbarReadableColors() {
      try {
        const containers = document.querySelectorAll([
          '.luckysheet-wa-toolbar-container',
          '.luckysheet-toolbar',
          '.luckysheet-titlebar',
          '.luckysheet-toolbar-menu',
          '.luckysheet-bottom-controll',
          '.luckysheet-wa-editor',
          '.luckysheet-formula-bar',
          '.luckysheet-input-box',
        ].join(','));
        containers.forEach(el => {
          el.style.backgroundColor = '#ffffff';
          el.style.color = '#111111';
        });
        const all = document.querySelectorAll([
          '.luckysheet-wa-toolbar-container *',
          '.luckysheet-toolbar *',
          '.luckysheet-titlebar *',
          '.luckysheet-toolbar-menu *',
          '.luckysheet-bottom-controll *',
          '.luckysheet-wa-editor *',
          '.luckysheet-formula-bar *',
          '.luckysheet-input-box *',
          '.luckysheet-toolbar-button',
          '.luckysheet-toolbar-button *',
          '.luckysheet-toolbar-select',
          '.luckysheet-toolbar-select *',
          '.luckysheet-title',
          '.luckysheet-title *',
          'svg', 'path', 'rect', 'text'
        ].join(','));
        all.forEach(el => {
          el.style.color = '#111111';
          el.style.fill = '#111111';
        });
        const menus = document.querySelectorAll('.luckysheet-menuButton-menu, .luckysheet-colorSelectBox, .luckysheet-dynamic-tool, .luckysheet-insertFormula-cache');
        menus.forEach(el => {
          el.style.backgroundColor = '#ffffff';
          el.style.color = '#111111';
        });
        // Inputs/selects in toolbar
        const inputs = document.querySelectorAll('.luckysheet-wa-toolbar-container input, .luckysheet-wa-toolbar-container select, .luckysheet-wa-toolbar-container .selectbox span, .luckysheet-wa-toolbar-container .selectbox div');
        inputs.forEach(el => {
          el.style.backgroundColor = '#ffffff';
          el.style.color = '#111111';
          el.style.borderColor = '#d1d5db';
        });
      } catch (_) {}
    }

    // Map headers to section colours similar to the Process Files view
    function getSectionInfo(header) {
      const h = String(header || '').toLowerCase();
      if (header === 'Department') return { name: 'Department', bg: '#fef3c7' };
      if (h.includes('placement')) return { name: 'Placements', bg: '#dbeafe' };
      if (h.includes('(enrichment)') || h.includes('enrichment') || h.includes('activity') && !h.includes('scheduled')) return { name: 'Enrichment/Activities', bg: '#bfdbfe' };
      if (h.includes('(employer)') || h.includes('employment') || h.includes('employer')) return { name: 'Employment', bg: '#f3e8ff' };
      if (h.includes('career') || h.includes('job profile')) return { name: 'Careers', bg: '#fef3c7' };
      if (h.includes('assessment') || h.includes('score')) return { name: 'Assessments', bg: '#bbf7d0' };
      if (h.includes('target')) return { name: 'Targets', bg: '#fce7f3' };
      if (h.includes('login')) return { name: 'Login', bg: '#e0e7ff' };
      return { name: 'Other', bg: '#f3f4f6' };
    }

    function forceReadableStyles(headers, rows) {
      try {
        const api = window.luckysheet;
        if (!api || !api.setRangeStyle) return;
        const endRow = rows.length; // includes header row at 0
        const endCol = Math.max(0, headers.length - 1);
        const apply = () => {
          try {
            api.setRangeStyle({
              range: [{ row: [0, endRow], column: [0, endCol] }],
              style: { fc: '#111111' }
            });
            // Explicitly target header row again for good measure
            api.setRangeStyle({
              range: [{ row: [0, 0], column: [0, endCol] }],
              style: { fc: '#111111', bl: 1 }
            });
          } catch (_) { /* ignore */ }
        };
        // Apply now and after render ticks to override late paints
        apply();
        setTimeout(apply, 50);
        setTimeout(apply, 300);
        // Observe grid mutations and re-apply to override late paints
        try {
          const root = document.getElementById('luckysheet');
          const observer = new MutationObserver(() => apply());
          observer.observe(root, { childList: true, subtree: true });
        } catch (_) { /* ignore */ }
      } catch (_) { /* ignore */ }
    }
    const qs = new URLSearchParams(location.search);
    const collegeId = qs.get('collegeId');
    const reportId = qs.get('reportId');
    const statusEl = document.getElementById('status');
    const modal = document.getElementById('selectCollegeModal');
    const collegePicker = document.getElementById('collegePicker');

    function setStatus(msg, type = 'info') {
      statusEl.textContent = msg;
      statusEl.style.color = type === 'error' ? '#b91c1c' : (type === 'success' ? '#065f46' : '#6b7280');
    }

    function toLuckySheetData(headers, rows) {
      const tableHeaders = Array.isArray(headers) ? headers : [];
      const bodyRows = Array.isArray(rows) ? rows : [];
      const data = [tableHeaders, ...bodyRows];
      const percentCols = new Set();
      const headerInfos = tableHeaders.map(h => getSectionInfo(h));

      const cellData = data.map((row, rowIdx) => row.map((value, colIdx) => {
        const cell = { v: value };
        // Force readable text
        cell.fc = '#111111';
        if (rowIdx === 0) {
          // Header styling with section background
          const info = headerInfos[colIdx] || { bg: '#ffffff' };
          cell.bg = info.bg;
          cell.bl = 1; // bold header
          cell.fs = 12;
        } else {
          // Basic number formatting
          const headerText = String(tableHeaders[colIdx] || '').toLowerCase();
          const isPercent = headerText.includes('percent') || headerText.includes('%');
          if (isPercent) {
            percentCols.add(colIdx);
            const num = value === '' || value == null ? '' : Number(value);
            if (!Number.isNaN(num)) {
              // Keep as 0..1 or 0..100; normalise to 0..1 for display
              const normalised = num > 1 ? num / 100 : num;
              cell.v = normalised;
              cell.ct = { t: 'n', fa: '0.0%' };
            } else {
              cell.ct = { t: 'n', fa: '0.0%' };
            }
          } else if (typeof value === 'number' || (!isNaN(parseFloat(value)) && value !== '')) {
            const num = Number(value);
            if (!Number.isNaN(num)) {
              cell.v = num;
              cell.ct = { t: 'n', fa: '#,##0' };
            }
          }
        }
        return cell;
      }));
      // Append a totals row with formulas where appropriate (average for percent, sum for numbers)
      const totalsRowIndex = cellData.length; // 0-based index for new row
      const toCol = (n) => {
        let s = '';
        let x = n + 1; // 1-based
        while (x > 0) {
          const m = (x - 1) % 26;
          s = String.fromCharCode(65 + m) + s;
          x = Math.floor((x - 1) / 26);
        }
        return s;
      };
      const numBodyRows = bodyRows.length;
      if (numBodyRows > 0 && tableHeaders.length > 1) {
        const totalsRow = new Array(tableHeaders.length).fill(null).map(() => ({}));
        totalsRow[0] = { v: 'TOTAL', bl: 1, fc: '#111111' };
        for (let c = 1; c < tableHeaders.length; c++) {
          const colLetter = toCol(c);
          const fromA1 = `${colLetter}2`;
          const toA1 = `${colLetter}${1 + numBodyRows}`;
          const isPercent = percentCols.has(c) || String(tableHeaders[c] || '').includes('%') || String(tableHeaders[c] || '').toLowerCase().includes('percent');
          totalsRow[c] = {
            f: isPercent ? `AVERAGE(${fromA1}:${toA1})` : `SUM(${fromA1}:${toA1})`,
            bl: 1,
            fc: '#111111',
            ct: isPercent ? { t: 'n', fa: '0.0%' } : { t: 'n', fa: '#,##0' }
          };
        }
        cellData.push(totalsRow);
      }

      return [{ name: 'Report', data: cellData, index: 0, status: 1, order: 0, column: tableHeaders.length, row: cellData.length }];
    }

    function fromLuckySheet() {
      const sheet = luckysheet.getSheet();
      const first = Array.isArray(sheet) ? sheet[0] : sheet;
      const flowdata = first && first.data ? first.data : [];
      const values = (flowdata || []).map(row => (row || []).map(c => (c && c.v) ?? ''));
      const headers = values[0] || [];
      let rows = values.slice(1);
      // Drop the last row if it's our totals row
      if (rows.length && String(rows[rows.length - 1][0]).toUpperCase() === 'TOTAL') {
        rows = rows.slice(0, -1);
      }
      return { headers, rows };
    }

    async function loadReport() {
      // 1) Load by IDs if provided
      if (collegeId && reportId) {
        try {
          setStatus('Loading report...');
          const res = await fetch(`/api/colleges/${collegeId}/reports/${reportId}`, { credentials: 'include' });
          const json = await res.json();
          if (!json.success || !json.report || !json.report.data) throw new Error('Report not found');
          const { headers = [], rows = [] } = json.report.data;
          const sheets = toLuckySheetData(headers, rows);
          window.luckysheet.create({
            container: 'luckysheet',
            showinfobar: false,
            showsheetbar: true,
            showtoolbar: true,
            enableAddRow: true,
            enableAddCol: true,
            forceCalculation: true,
            data: sheets
          });
          // Ensure toolbar/menu text is readable now and on later mutations
          forceToolbarReadableColors();
          try {
            const root = document.getElementById('luckysheet')?.parentElement || document.body;
            const obs = new MutationObserver(() => forceToolbarReadableColors());
            obs.observe(root, { childList: true, subtree: true, attributes: true });
          } catch (_) {}
          // Timed re-apply in case of async toolbar paints
          try { let n=0; const id=setInterval(()=>{forceToolbarReadableColors(); if(++n>20) clearInterval(id);}, 250); } catch(_) {}
          forceReadableStyles(headers, rows);
          setStatus('Loaded');
          return;
        } catch (e) {
          console.error(e);
          setStatus(`Load failed: ${e.message}`, 'error');
          return;
        }
      }
      // 2) Fallback: load from localStorage (Generate Report flow)
      const cached = localStorage.getItem('excelEditorData');
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          const headers = parsed.headers || [];
          const rows = parsed.rows || [];
          const sheets = toLuckySheetData(headers, rows);
          window.luckysheet.create({
            container: 'luckysheet',
            showinfobar: false,
            showsheetbar: true,
            showtoolbar: true,
            enableAddRow: true,
            enableAddCol: true,
            forceCalculation: true,
            data: sheets
          });
          // Ensure toolbar/menu text is readable now and on later mutations
          forceToolbarReadableColors();
          try {
            const root = document.getElementById('luckysheet')?.parentElement || document.body;
            const obs = new MutationObserver(() => forceToolbarReadableColors());
            obs.observe(root, { childList: true, subtree: true, attributes: true });
          } catch (_) {}
          // Timed re-apply in case of async toolbar paints
          try { let n=0; const id=setInterval(()=>{forceToolbarReadableColors(); if(++n>20) clearInterval(id);}, 250); } catch(_) {}
          forceReadableStyles(headers, rows);
          setStatus('Loaded from upload');
          return;
        } catch (e) {
          console.error(e);
        }
      }
      setStatus('No source data provided', 'error');
    }

    async function saveReport() {
      try {
        setStatus('Saving...');
        const { headers, rows } = fromLuckySheet();
        let targetCollegeId = collegeId;
        if (!targetCollegeId) {
          await populateCollegePicker();
          modal.style.display = 'flex';
          const chosen = await awaitCollegeSelection();
          modal.style.display = 'none';
          if (!chosen) {
            setStatus('Save cancelled', 'error');
            return;
          }
          targetCollegeId = chosen;
        }
        const payload = { reportData: { headers, rows }, reportName: 'Edited Report', summary: 'Edited in Excel editor' };
        const res = await fetch(`/api/colleges/${targetCollegeId}/reports`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (!json.success) throw new Error(json.error || 'Save failed');
        await fetch(`/api/reports/${targetCollegeId}/recalculate`, { method: 'POST', credentials: 'include' });
        setStatus('Saved and recalculated', 'success');
        try {
          localStorage.setItem('excelEditorData', JSON.stringify({ headers, rows }));
        } catch (_) {}
        // Notify opener to refresh its table immediately without re-uploading
        try { if (window.opener) window.opener.postMessage({ type: 'excel-editor-saved' }, '*'); } catch (_) {}
      } catch (e) {
        console.error(e);
        setStatus(`Save failed: ${e.message}`, 'error');
      }
    }

    function revertToClassic() {
      try {
        const { headers, rows } = fromLuckySheet();
        localStorage.setItem('excelEditorData', JSON.stringify({ headers, rows }));
      } catch (_) { /* ignore */ }
      try { if (window.opener) window.opener.postMessage({ type: 'excel-editor-saved' }, '*'); } catch (_) {}
      window.location.href = '/generate-report.html?fromExcel=1';
    }

    async function populateCollegePicker() {
      try {
        collegePicker.innerHTML = '<option value="">Loading colleges...</option>';
        const res = await fetch('/api/colleges', { credentials: 'include' });
        const json = await res.json();
        const colleges = Array.isArray(json.colleges) ? json.colleges : json;
        collegePicker.innerHTML = '<option value="">Select a college...</option>' +
          colleges.map(c => `<option value="${c.id}">${c.name || c.collegename || ('College ' + c.id)}</option>`).join('');
      } catch (e) {
        collegePicker.innerHTML = '<option value="">Failed to load colleges</option>';
      }
    }

    function awaitCollegeSelection() {
      return new Promise(resolve => {
        const confirmBtn = document.getElementById('confirmCollegeSelect');
        const cancelBtn = document.getElementById('cancelCollegeSelect');
        function cleanup(value) {
          confirmBtn.removeEventListener('click', onConfirm);
          cancelBtn.removeEventListener('click', onCancel);
          resolve(value);
        }
        function onConfirm() {
          const val = collegePicker.value;
          cleanup(val || null);
        }
        function onCancel() { cleanup(null); }
        confirmBtn.addEventListener('click', onConfirm);
        cancelBtn.addEventListener('click', onCancel);
      });
    }

    document.getElementById('btnSave').addEventListener('click', saveReport);
    document.getElementById('btnRecalc').addEventListener('click', async () => {
      try {
        setStatus('Recalculating...');
        const idForRecalc = collegeId || (localStorage.getItem('currentCollegeId') || '').trim();
        if (!idForRecalc) throw new Error('Select a college first');
        await fetch(`/api/reports/${idForRecalc}/recalculate`, { method: 'POST', credentials: 'include' });
        setStatus('Recalculated', 'success');
      } catch (e) {
        console.error(e);
        setStatus(`Recalc failed: ${e.message}`, 'error');
      }
    });
    document.getElementById('btnRevert').addEventListener('click', revertToClassic);

    loadReport();
  </script>
</body>
</html>

