<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Navigate Reports Hub - College Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Mobile-specific styles */
    @media (max-width: 768px) {
      /* General mobile optimizations */
      body {
        font-size: 14px;
        line-height: 1.4;
      }
      
      .mobile-card {
        margin-bottom: 1rem;
        padding: 1rem;
      }
      

      
      /* Mobile button groups */
      .mobile-button-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .mobile-button-group button {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border-radius: 0.5rem;
      }
      
      /* Mobile modals */
      .mobile-modal {
        padding: 1rem;
        margin: 1rem;
        max-height: 90vh;
        overflow-y: auto;
        border-radius: 0.75rem;
      }
      
      /* Mobile forms */
      .mobile-form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Mobile tabs */
      .mobile-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      .mobile-tabs::-webkit-scrollbar {
        display: none;
      }
      
      .tab-btn {
        white-space: nowrap;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        min-width: 80px;
      }
      
      /* Mobile actions */
      .mobile-actions {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .mobile-table-actions {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .mobile-table-actions button {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
      }
      
      /* Mobile grids */
      .mobile-metrics-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .mobile-details-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Mobile KPI table */
      .mobile-kpi-table {
        display: block;
        width: 100%;
      }
      
      .mobile-kpi-table thead {
        display: none;
      }
      
      .mobile-kpi-table tbody {
        display: block;
      }
      
      .mobile-kpi-table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      
      .mobile-kpi-table td {
        display: block;
        text-align: left;
        padding: 0.5rem 0;
        border: none;
        position: relative;
      }
      
      .mobile-kpi-table td:before {
        content: attr(data-label) ": ";
        font-weight: 600;
        color: #374151;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
      }
      
      .mobile-kpi-table .kpi-number {
        font-weight: bold;
        color: #3b82f6;
        font-size: 1.125rem;
      }
      
      .mobile-kpi-table .kpi-status-select {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        font-size: 0.875rem;
        min-width: 100px;
        max-width: 150px;
        text-align: center;
        white-space: nowrap;
      }
      
      /* Mobile status color indicators */
      .mobile-kpi-table .kpi-status-select.bg-green-400 {
        background-color: #4ade80 !important;
        color: #064e3b !important;
        font-weight: bold !important;
      }
      
      .mobile-kpi-table .kpi-status-select.bg-yellow-400 {
        background-color: #facc15 !important;
        color: #713f12 !important;
        font-weight: bold !important;
      }
      
      .mobile-kpi-table .kpi-status-select.bg-red-400 {
        background-color: #f87171 !important;
        color: #7f1d1d !important;
        font-weight: bold !important;
      }
      
                .mobile-kpi-table .kpi-priority-select {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #d1d5db;
        font-size: 0.875rem;
        font-weight: 500;
        min-width: 80px;
        max-width: 120px;
        text-align: center;
      }
      
      /* Mobile priority color indicators */
      .mobile-kpi-table .kpi-priority-select option[value="high"] {
        color: #ef4444 !important;
        font-weight: bold !important;
      }
      
      .mobile-kpi-table .kpi-priority-select option[value="medium"] {
        color: #f59e0b !important;
        font-weight: bold !important;
      }
      
      .mobile-kpi-table .kpi-priority-select option[value="low"] {
        color: #10b981 !important;
        font-weight: bold !important;
      }
      
      .mobile-kpi-table button {
        width: 100%;
        padding: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 0.25rem;
      }
      
      .mobile-kpi-table .rich-textarea {
        min-height: 60px !important;
        max-height: 120px !important;
        font-size: 0.875rem !important;
        padding: 0.5rem !important;
      }
      
      /* Mobile analytics cards */
      .mobile-analytics-card {
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
      }
      
      .mobile-analytics-card h3 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }
      
      .mobile-analytics-card .metric {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
      }
      
      /* Mobile floating toolbar */
      .mobile-formatting-toolbar {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
        max-width: 90vw;
      }
      
      .mobile-formatting-toolbar button {
        padding: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        min-width: 40px;
        min-height: 40px;
      }
      
      /* Mobile status messages */
      .mobile-status {
        position: fixed;
        top: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 60;
        max-width: none;
        border-radius: 0.5rem;
        padding: 1rem;
      }
      
      /* Mobile chart container */
      .mobile-chart-container {
        height: 250px;
        max-height: 40vh;
        margin-bottom: 1rem;
      }
      
      /* Mobile content padding */
      .mobile-content {
        padding-bottom: 80px;
      }
      
      /* Mobile header */
      .mobile-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 40;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem;
      }
      
      /* Mobile back button */
      .mobile-back-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #3b82f6;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 1rem;
      }
      
      /* Mobile loading states */
      .mobile-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
      }
      
      .mobile-loading .spinner {
        width: 2rem;
        height: 2rem;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    }
    
    /* Tablet styles */
    @media (min-width: 769px) and (max-width: 1024px) {
      .tablet-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Custom scrollbar for mobile */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Touch-friendly buttons */
    .touch-button {
      min-height: 44px;
      min-width: 44px;
    }
    
    /* Mobile-optimized tables */
    .mobile-table {
      display: block;
      width: 100%;
    }
    
    .mobile-table thead {
      display: none;
    }
    
    .mobile-table tbody {
      display: block;
    }
    
    .mobile-table tr {
      display: block;
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
      background: white;
    }
    
    .mobile-table td {
      display: block;
      text-align: left;
      padding: 0.5rem 0;
      border: none;
    }
    
    .mobile-table td:before {
      content: attr(data-label) ": ";
      font-weight: 600;
      color: #374151;
    }
    
    /* Mobile status messages */
    .mobile-status {
      position: fixed;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 60;
      max-width: none;
    }
    
    /* Mobile chart container */
    .mobile-chart-container {
      height: 300px;
      max-height: 50vh;
    }
    
    @media (min-width: 768px) {
      .mobile-chart-container {
        height: 400px;
        max-height: none;
      }
    }
    
    .formatting-toolbar {
      display: flex;
      gap: 2px;
      padding: 2px;
      background-color: #f8f9fa;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      flex-wrap: wrap;
    }
    
    .format-btn {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      background-color: white;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      min-width: 24px;
      text-align: center;
      transition: all 0.2s;
    }
    
    .format-btn:hover {
      background-color: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .format-btn:active {
      background-color: #e5e7eb;
    }
    
    .rich-textarea {
      min-height: 40px !important;
      max-height: 120px !important;
      height: auto !important;
      width: 250px !important;
      max-width: 250px !important;
      overflow-y: auto !important;
      overflow-x: hidden !important;
      resize: none !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      white-space: pre-wrap !important;
      line-height: 1.4 !important;
      padding: 8px 12px !important;
      border: 1px solid #d1d5db !important;
      border-radius: 6px !important;
      font-size: 14px !important;
      font-family: inherit !important;
      box-sizing: border-box !important;
      display: block !important;
    }
    
    .rich-textarea.empty {
      color: #9ca3af !important;
    }
    
    .rich-textarea:focus {
      outline: none !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .rich-textarea ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .rich-textarea li {
      margin: 2px 0;
    }
    
    .rich-textarea strong {
      font-weight: bold;
    }
    
    .rich-textarea em {
      font-style: italic;
    }
    
    .rich-textarea u {
      text-decoration: underline;
    }
    
    .rich-textarea mark {
      background-color: yellow;
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    /* Highlight color variations */
    .rich-textarea mark[style*="background-color: yellow"] {
      background-color: yellow !important;
    }
    
    .rich-textarea mark[style*="background-color: #90EE90"] {
      background-color: #90EE90 !important;
    }
    
    .rich-textarea mark[style*="background-color: #87CEEB"] {
      background-color: #87CEEB !important;
    }
    
    .rich-textarea mark[style*="background-color: #FFB6C1"] {
      background-color: #FFB6C1 !important;
    }
    
    .rich-textarea mark[style*="background-color: #FFA500"] {
      background-color: #FFA500 !important;
    }
    
    .rich-text-container {
      max-height: 120px !important;
      max-width: 100% !important;
      width: 100% !important;
      overflow: hidden !important;
    }
    
    /* Prevent table cells from expanding */
    #kpiTableBody td {
      max-width: 0 !important;
      overflow: hidden !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
    }
    
    /* Make numbers column much smaller */
    #kpiTableBody td:nth-child(1) {
      max-width: 50px !important;
      width: 50px !important;
      text-align: center !important;
    }
    
    /* Ensure KPI and Notes columns have more space */
    #kpiTableBody td:nth-child(3),
    #kpiTableBody td:nth-child(5) {
      min-width: 270px !important;
      max-width: 270px !important;
      width: 270px !important;
      flex: none !important;
    }
    
    /* Priority column */
    #kpiTableBody td:nth-child(2) {
      min-width: 120px !important;
      max-width: 160px !important;
      width: auto !important;
      text-align: center !important;
      vertical-align: top !important;
      padding: 0.5rem !important;
    }
    
    /* Progress column */
    #kpiTableBody td:nth-child(4) {
      min-width: 140px !important;
      max-width: 200px !important;
      width: auto !important;
      text-align: center !important;
      vertical-align: top !important;
      padding: 0.5rem !important;
    }
    
    /* Status column */
    #kpiTableBody td:nth-child(6) {
      min-width: 140px !important;
      max-width: 200px !important;
      width: auto !important;
      text-align: center !important;
      vertical-align: top !important;
      padding: 0.5rem !important;
    }
    
    /* Delete button column */
    #kpiTableBody td:nth-child(7) {
      max-width: 80px !important;
      width: 80px !important;
      text-align: center !important;
      vertical-align: top !important;
      padding: 0.5rem !important;
    }
    
    /* Ensure table cells have consistent alignment */
    #kpiTableBody td {
      vertical-align: top !important;
      padding: 0.5rem !important;
    }
    
    /* Make table more responsive */
    .mobile-kpi-table {
      table-layout: auto !important;
      width: 100% !important;
    }
    
    .mobile-kpi-table th,
    .mobile-kpi-table td {
      white-space: normal !important;
      word-wrap: break-word !important;
    }
    
    /* Responsive breakpoints for KPI table */
    @media (max-width: 1200px) {
      #kpiTableBody td:nth-child(3),
      #kpiTableBody td:nth-child(5) {
        min-width: 220px !important;
        max-width: 220px !important;
        width: 220px !important;
      }
      
      .rich-textarea {
        width: 200px !important;
        max-width: 200px !important;
      }
      
      #kpiTableBody td:nth-child(2) {
        min-width: 100px !important;
        max-width: 120px !important;
      }
      
      #kpiTableBody td:nth-child(4),
      #kpiTableBody td:nth-child(6) {
        min-width: 120px !important;
        max-width: 160px !important;
      }
    }
    @media (max-width: 768px) {
      #kpiTableBody td:nth-child(3),
      #kpiTableBody td:nth-child(5) {
        min-width: 180px !important;
        max-width: 180px !important;
        width: 180px !important;
      }
      
      .rich-textarea {
        width: 160px !important;
        max-width: 160px !important;
      }
      
      #kpiTableBody td:nth-child(2) {
        min-width: 80px !important;
        max-width: 100px !important;
      }
      
      #kpiTableBody td:nth-child(4),
      #kpiTableBody td:nth-child(6) {
        min-width: 100px !important;
        max-width: 140px !important;
      }
      
      .kpi-priority-select {
        min-width: 60px !important;
        max-width: 80px !important;
        font-size: 0.75rem !important;
      }
      
      .kpi-status-select {
        min-width: 80px !important;
        max-width: 120px !important;
        font-size: 0.75rem !important;
      }
    }
    
    @media (max-width: 480px) {
      #kpiTableBody td:nth-child(3),
      #kpiTableBody td:nth-child(5) {
        min-width: 140px !important;
        max-width: 140px !important;
        width: 140px !important;
      }
      
      .rich-textarea {
        width: 120px !important;
        max-width: 120px !important;
      }
      
      #kpiTableBody td:nth-child(2) {
        min-width: 60px !important;
        max-width: 80px !important;
      }
      
      #kpiTableBody td:nth-child(4),
      #kpiTableBody td:nth-child(6) {
        min-width: 80px !important;
        max-width: 120px !important;
      }
      
      .kpi-priority-select {
        min-width: 50px !important;
        max-width: 70px !important;
        font-size: 0.7rem !important;
        padding: 0.25rem !important;
      }
      
      .kpi-status-select {
        min-width: 70px !important;
        max-width: 100px !important;
        font-size: 0.7rem !important;
        padding: 0.25rem !important;
      }
      
      /* Enable horizontal scroll for very small screens */
      .mobile-kpi-table {
        overflow-x: auto !important;
        min-width: 600px !important;
      }
    }
    
    /* Priority indicators */
    .priority-high {
      border-left: 4px solid #ef4444 !important;
    }
    
    .priority-medium {
      border-left: 4px solid #f59e0b !important;
    }
    
    .priority-low {
      border-left: 4px solid #10b981 !important;
    }
    
    /* Completed KPI styling */
    .bg-green-50 {
      background-color: #f0fdf4 !important;
    }
    
    .border-l-green-500 {
      border-left-color: #10b981 !important;
    }
    
    /* Priority select styling */
    .kpi-priority-select {
      background-color: white !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.375rem !important;
      padding: 0.5rem !important;
      font-size: 0.875rem !important;
      font-weight: 500 !important;
      min-width: 80px !important;
      max-width: 120px !important;
      width: 100% !important;
      cursor: pointer !important;
      text-align: center !important;
    }
    
    /* Priority color indicators - always visible */
    .kpi-priority-select option[value="high"] {
      color: #ef4444 !important;
      font-weight: bold !important;
    }
    
    .kpi-priority-select option[value="medium"] {
      color: #f59e0b !important;
      font-weight: bold !important;
    }
    
    .kpi-priority-select option[value="low"] {
      color: #10b981 !important;
      font-weight: bold !important;
    }
    
    .kpi-priority-select:focus {
      outline: none !important;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    /* Status button styling */
    .kpi-status-select {
      background-color: white !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.375rem !important;
      padding: 0.5rem !important;
      font-size: 0.875rem !important;
      min-width: 100px !important;
      max-width: 150px !important;
      width: 100% !important;
      cursor: pointer !important;
      text-align: center !important;
      white-space: nowrap !important;
    }
    
    /* Status color indicators - always visible */
    .kpi-status-select.bg-green-400 {
      background-color: #4ade80 !important;
      color: #064e3b !important;
      font-weight: bold !important;
      overflow: visible !important;
    }
    
    .kpi-status-select.bg-yellow-400 {
      background-color: #facc15 !important;
      color: #713f12 !important;
      font-weight: bold !important;
      overflow: visible !important;
    }
    
    .kpi-status-select.bg-red-400 {
      background-color: #f87171 !important;
      color: #7f1d1d !important;
      font-weight: bold !important;
      overflow: visible !important;
    }
    
    /* Ensure select options are fully visible */
    .kpi-status-select option {
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: unset !important;
    }
    
    /* Incomplete button styling */
    .kpi-status-select + button {
      margin-top: 0.5rem !important;
      transition: all 0.2s ease-in-out !important;
    }
    
    .kpi-status-select + button:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto py-4 sm:py-8 px-2 sm:px-4">
    <!-- Back Button -->
    <div class="mb-4">
      <button onclick="goBack()" class="flex items-center text-gray-600 hover:text-gray-800 transition-colors duration-200 touch-button mobile-back-btn focus:outline-none">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span class="text-sm sm:text-base">Back to Main Dashboard</span>
      </button>
    </div>
    
    <!-- Tab Navigation -->
    <div class="mb-6 sm:mb-8 border-b border-gray-200 overflow-x-auto custom-scrollbar">
      <div class="flex space-x-4 sm:space-x-8 min-w-max">
        <button class="tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm sm:text-base whitespace-nowrap touch-button" onclick="showTab('overview')" id="tab-overview">Overview</button>
        <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm sm:text-base whitespace-nowrap touch-button" onclick="showTab('reports')" id="tab-reports">Reports</button>
        <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm sm:text-base whitespace-nowrap touch-button" onclick="showTab('details')" id="tab-details">Details</button>
        <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm sm:text-base whitespace-nowrap touch-button" onclick="showTab('analytics')" id="tab-analytics">Analytics</button>
        <button class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm sm:text-base whitespace-nowrap touch-button" onclick="showTab('kpi')" id="tab-kpi">KPI</button>
      </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
        <div class="flex items-center gap-4">
          <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-blue-800">College Dashboard</h1>
        </div>
        <div class="bg-white rounded-lg shadow p-3 sm:p-4 lg:p-6 w-full sm:w-auto">
          <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-gray-900 mb-2">Total Students</h3>
          <p class="text-xl sm:text-2xl lg:text-3xl font-bold text-blue-600" id="totalStudentsDisplay">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-green-600" id="studentsTrend">Loading trend...</div>
        </div>
      </div>
      
      <!-- Key Metrics Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8 mobile-metrics-grid" id="metricsCardsContainer">
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="placementsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Placements</h3>
          <p class="text-2xl sm:text-3xl font-bold text-green-600" id="placementsValue">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-green-600" id="placementsTrend">Loading trend...</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="careersCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Careers</h3>
          <p class="text-2xl sm:text-3xl font-bold text-indigo-600" id="careersValue">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-green-600" id="careersTrend">Loading trend...</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="enrichmentActivitiesCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2" id="enrichmentActivitiesTitle">Activities</h3>
          <p class="text-2xl sm:text-3xl font-bold text-purple-600" id="enrichmentActivitiesValue">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-green-600" id="enrichmentActivitiesTrend">Loading trend...</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="employerActivitiesCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Employer Activities</h3>
          <p class="text-2xl sm:text-3xl font-bold text-blue-600" id="employerActivitiesValue">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-green-600" id="employerActivitiesTrend">Loading trend...</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="assessmentsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2">Assessments</h3>
          <p class="text-2xl sm:text-3xl font-bold text-orange-600" id="assessmentsValue">Loading...</p>
          <div class="mt-2 text-xs sm:text-sm text-red-600" id="assessmentsTrend">Loading trend...</div>
        </div>
        <!-- Loading placeholder -->
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="loadingCard">
          <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-8 bg-gray-200 rounded w-1/2 mb-2"></div>
            <div class="h-3 bg-gray-200 rounded w-1/3"></div>
          </div>
        </div>
      </div>

      <!-- Detailed Metrics Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8 mobile-details-grid" id="detailedMetricsContainer">
        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="placementsDetailsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Placements</h3>
          <div class="space-y-2 sm:space-y-3" id="placementsDetails">
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students with Placements</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">% with Placements</span>
              <div class="flex items-center">
                <span class="font-semibold mr-2 text-sm sm:text-base">Loading...</span>
                <div class="w-16 sm:w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-green-500" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Hours Scheduled</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Student Confirmed</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Employer Confirmed</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="careersDetailsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Careers</h3>
          <div class="space-y-2 sm:space-y-3" id="careersDetails">
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students Completed Career Quiz</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">% Students Completed Career Quiz</span>
              <div class="flex items-center">
                <span class="font-semibold mr-2 text-sm sm:text-base">Loading...</span>
                <div class="w-16 sm:w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-purple-500" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students with Mapped Job Profile</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">% Students with Mapped Job Profile</span>
              <div class="flex items-center">
                <span class="font-semibold mr-2 text-sm sm:text-base">Loading...</span>
                <div class="w-16 sm:w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-purple-500" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Total Mapped Job Profiles</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="enrichmentActivitiesDetailsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4" id="enrichmentActivitiesDetailsTitle">Activities</h3>
          <div class="space-y-2 sm:space-y-3" id="enrichmentActivitiesDetails">
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600" id="enrichmentStudentsLabel">Students with Activities</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600" id="enrichmentPercentLabel">% Students with Activities</span>
              <div class="flex items-center">
                <span class="font-semibold mr-2 text-sm sm:text-base">Loading...</span>
                <div class="w-16 sm:w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-purple-500" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Total Enrichment Activities</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Total Enrichment Hours</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="employerActivitiesDetailsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Employer Activities</h3>
          <div class="space-y-2 sm:space-y-3" id="employerActivitiesDetails">
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students with Employer Activities</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">% Students with Employer Activities</span>
              <div class="flex items-center">
                <span class="font-semibold mr-2 text-sm sm:text-base">Loading...</span>
                <div class="w-16 sm:w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-2 bg-blue-500" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Total Employer Activities</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Total Employer Hours</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 sm:p-6 mobile-card" id="assessmentsDetailsCard" style="display: none;">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Assessments</h3>
          <div class="space-y-2 sm:space-y-3" id="assessmentsDetails">
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students with Assessments</span>
              <span class="font-semibold text-sm sm:text-base text-green-600">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Students without Assessments</span>
              <span class="font-semibold text-sm sm:text-base text-red-600">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Assessment Completion Rate</span>
              <span class="font-semibold text-sm sm:text-base text-red-600">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Pending Assessments</span>
              <span class="font-semibold text-sm sm:text-base text-orange-600">Loading...</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-xs sm:text-sm text-gray-600">Average Score</span>
              <span class="font-semibold text-sm sm:text-base">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity & Quick Actions -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8">
        <div class="bg-white rounded-lg shadow p-4 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Recent Reports</h3>
          <div class="space-y-2 sm:space-y-3" id="recentReportsList">
            <p class="text-sm text-gray-500">Loading recent reports...</p>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4 sm:p-6">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Quick Actions</h3>
          <div class="mobile-button-group space-y-2 sm:space-y-3">
            <button onclick="generateNewReport()" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200 font-medium shadow-sm touch-button text-sm sm:text-base">
              Generate New Report
            </button>
            <button onclick="showTab('details')" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors duration-200 font-medium shadow-sm touch-button text-sm sm:text-base">
              View College Details
            </button>
            <button onclick="showTab('analytics')" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition-colors duration-200 font-medium shadow-sm touch-button text-sm sm:text-base">
              View Analytics
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-blue-800 mb-6">Reports Management</h2>
      
      <!-- Filters -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
            <select id="dateRangeFilter" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="applyFilters()">
              <option value="">All Time</option>
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Search Reports</label>
            <input type="text" id="searchReportsFilter" placeholder="Search by name..." class="border border-gray-300 rounded-md px-3 py-2 w-full" oninput="applyFilters()">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
            <select id="sortReportsFilter" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="applyFilters()">
              <option value="date-desc">Date (Newest First)</option>
              <option value="date-asc">Date (Oldest First)</option>
              <option value="name-asc">Name (A-Z)</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="clearFilters()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition-colors duration-200 font-medium shadow-sm w-full">
              Clear Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Reports Display -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">All Reports</h3>
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-2 border rounded-md px-2 py-1">
              <label for="shareLiveToggle" class="text-sm text-gray-600">Live</label>
              <input id="shareLiveToggle" type="checkbox" class="h-4 w-4">
            </div>
            <button id="createShareLinkBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition-colors duration-200 font-medium shadow-sm touch-button">
              Create Share Link
            </button>
            <button onclick="generateNewReport()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200 font-medium shadow-sm touch-button">
              Generate New Report
            </button>
          </div>
        </div>
        
        <!-- Desktop Table View -->
        <div class="hidden md:block">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Summary</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Loading reports...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden">
          <div id="reportsCardBody" class="space-y-4">
            <div class="text-center text-gray-500 py-8">Loading reports...</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Details Tab -->
    <div id="details" class="tab-content hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-blue-800">College Details</h2>
        <button onclick="saveCollegeDetails()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors duration-200 font-medium shadow-sm">
          Save Changes
        </button>
      </div>
      
      <!-- General Information -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">General Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">College Name</label>
            <input type="text" id="collegeName" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Account Manager</label>
            <select id="accountManager" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="">Unassigned</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Report Frequency</label>
            <select id="reportFrequency" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="weekly">Weekly</option>
              <option value="bi-weekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Number of Providers</label>
            <input type="number" id="numberOfProviders" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Report Template</label>
            <select id="collegeTemplate" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="standard">Standard</option>
              <option value="minimal">Minimal</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Account Value, Renewal & Modules -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Account Value, Renewal & Modules</h3>
        
        <!-- Account Summary -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Total Account Value</label>
            <input type="text" id="total-account-value" class="border border-gray-300 rounded-md px-3 py-2 w-full font-semibold" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Renewal Date</label>
            <input type="date" id="renewalDate" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
          </div>
        </div>

        <!-- Modules Section -->
        <div class="border-t border-gray-200 pt-4">
          <h4 class="text-md font-medium text-gray-900 mb-4">Modules & Costs</h4>
          <div id="modules-container" class="space-y-4">
            <!-- Modules will be populated dynamically from college data -->
          </div>
          <button onclick="addModule()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors duration-200 mt-3">
            + Add Module
          </button>
        </div>
      </div>

      <!-- Key Stakeholders -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Key Stakeholders</h3>
        <div id="key-stakeholders-container" class="space-y-4">
          <!-- Key stakeholders will be populated dynamically from college data -->
        </div>
        <button onclick="addKeyStakeholder()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors duration-200 mt-3">
          + Add Another Key Stakeholder
        </button>
      </div>

      <!-- Super Users -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Super Users</h3>
        <div id="super-users-container" class="space-y-4">
          <!-- Super users will be populated dynamically from college data -->
        </div>
        <button onclick="addSuperUser()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors duration-200 mt-3">
          + Add Another Super User
        </button>
      </div>

      <!-- Data Transfer & MIS Contact -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Transfer & MIS Contact</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Data Transfer Method</label>
            <select id="dataTransferMethod" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="live-link">Live Link</option>
              <option value="manual-upload">Manual Upload</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">MIS Contact Name</label>
            <input type="text" id="misContactName" placeholder="Enter MIS contact name" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">MIS Contact Email</label>
            <input type="email" id="misContactEmail" placeholder="Enter MIS contact email" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">College System</label>
            <select id="collegeSystem" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="Pro Monitor" selected>Pro Monitor</option>
              <option value="Tribal">Tribal</option>
              <option value="Unity">Unity</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Notes & Concerns -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Notes & Concerns</h3>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Initial Concerns or Notes</label>
          <textarea id="initialConcerns" rows="4" class="border border-gray-300 rounded-md px-3 py-2 w-full" placeholder="Any initial concerns, special requirements, or notes about this college" onchange="formDataChanged = true"></textarea>
        </div>
      </div>

      

      <!-- Performance Indicators -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Performance Indicators</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="status" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="A">A - Excellent</option>
              <option value="B">B - Good</option>
              <option value="C">C - Needs Improvement</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">OFSTED Rating</label>
            <select id="ofstedRating" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="O">Outstanding</option>
              <option value="G">Good</option>
              <option value="R">Requires Improvement</option>
              <option value="I">Inadequate</option>
               <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Engagement Level</label>
            <select id="engagementLevel" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
              <option value="Excellent">Excellent</option>
              <option value="Good">Good</option>
              <option value="Fair">Fair</option>
              <option value="Poor">Poor</option>
            </select>
          </div>
        </div>
      </div>

      <!-- SWOT Analysis -->
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">SWOT Analysis</h3>
          <button onclick="saveSWOTAnalysis()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors duration-200">
            Save SWOT
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-medium text-green-700 mb-2">Strengths</h4>
            <textarea id="swotStrengths" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Enter strengths (one per line)"></textarea>
          </div>
          <div>
            <h4 class="font-medium text-red-700 mb-2">Weaknesses</h4>
            <textarea id="swotWeaknesses" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Enter weaknesses (one per line)"></textarea>
          </div>
          <div>
            <h4 class="font-medium text-blue-700 mb-2">Opportunities</h4>
            <textarea id="swotOpportunities" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Enter opportunities (one per line)"></textarea>
          </div>
          <div>
            <h4 class="font-medium text-orange-700 mb-2">Threats</h4>
            <textarea id="swotThreats" rows="4" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm" placeholder="Enter threats (one per line)"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-blue-800">Enhanced Analytics & AI Insights</h2>
        <button onclick="refreshAIInsights()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 touch-button flex items-center">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Refresh AI Insights
        </button>
      </div>
      
      <!-- Performance Overview Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 mobile-metrics-grid">
        <div class="bg-white rounded-lg shadow p-4 mobile-analytics-card">
          <div class="flex items-center">
            <div class="p-2 rounded-full bg-blue-100">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Total Students</p>
              <p class="text-2xl font-semibold text-gray-900 metric" id="totalStudents">-</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4 mobile-analytics-card">
          <div class="flex items-center">
            <div class="p-2 rounded-full bg-green-100">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Placement Rate</p>
              <p class="text-2xl font-semibold text-gray-900 metric" id="placementRate">-</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4 mobile-analytics-card">
          <div class="flex items-center">
            <div class="p-2 rounded-full bg-yellow-100">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Enrichment Activities</p>
              <p class="text-2xl font-semibold text-gray-900 metric" id="enrichmentActivitiesParticipation">-</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4 mobile-analytics-card">
          <div class="flex items-center">
            <div class="p-2 rounded-full bg-orange-100">
              <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Employer Activities</p>
              <p class="text-2xl font-semibold text-gray-900 metric" id="employerActivitiesParticipation">-</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4 mobile-analytics-card">
          <div class="flex items-center">
            <div class="p-2 rounded-full bg-purple-100">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-500">Assessment Rate</p>
              <p class="text-2xl font-semibold text-gray-900 metric" id="assessmentRate">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Peer Benchmarking Section -->
      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Peer Benchmarking & Performance Ranking
        </h3>
        <div id="peerBenchmarkingContainer">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">Loading peer comparison data...</p>
          </div>
        </div>
      </div>

      <!-- Gap Analysis Section -->
      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-orange-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          Performance Gap Analysis
        </h3>
        <div id="gapAnalysisContainer">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">Analyzing performance gaps...</p>
          </div>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12 mobile-chart-container">
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Placements Over Time</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="placementsChart"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Activities Trend</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="activitiesChart"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Assessment Completion</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="assessmentsChart"></canvas>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Career Progression</h3>
          <div style="height: 200px; position: relative;">
            <canvas id="careersChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Gemini 2.5 Flash AI Insights -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          AI Powered Insights & Strategic Recommendations
        </h3>
        <div id="geminiInsightsContainer">
          <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">Generating AI-powered insights...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI Tab -->
    <div id="kpi" class="tab-content hidden">
      <h2 class="text-2xl font-bold text-blue-800 mb-6">Key Performance Indicators (KPIs)</h2>
      
                    <!-- AI KPI Suggestions Section -->
              <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                  <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
                  AI-Powered KPI Suggestions
                </h3>
                <div id="kpiSuggestionsContainer">
                  <div class="text-center py-2">
                    <svg class="w-6 h-6 text-gray-400 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <p class="text-gray-600 text-sm">Click "Auto-Generate KPIs" to get AI-powered KPI suggestions</p>
                  </div>
                </div>
                <div class="mt-3 flex space-x-4 mobile-button-group">
                  <button onclick="generateKPIsFromAI()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 touch-button">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Auto-Generate KPIs
                  </button>
                  <button onclick="refreshKPISuggestions()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 touch-button">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Suggestions
                  </button>
                  <!-- Test OpenAI button disabled for production -->
                  <!--
                  <button onclick="testOpenAI()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 touch-button">
                    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Test OpenAI
                  </button>
                  -->
                </div>
              </div>
      
      <!-- Current KPIs Section -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Current KPIs</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 mb-4 mobile-kpi-table" id="kpiTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">KPI</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Progress</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody id="kpiTableBody">
              <!-- KPI rows will be inserted here -->
            </tbody>
          </table>
          <div class="flex space-x-4 mobile-button-group">
            <button onclick="addKpiRow()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 touch-button">Add KPI</button>
            <button onclick="reorderKPIsByPriority()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 touch-button">Sort by Priority</button>
            <button onclick="saveKPIs()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 touch-button">Save KPIs</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile Navigation Bar -->
  <script>
    // Global variables
    let collegeData = null;
    let collegeReports = [];
    let accountManagerData = null;
    let allColleges = []; // Initialize allColleges here to prevent undefined errors
    let activeShare = null; // { shareId, url, permissions, live }
    let allAccountManagers = []; // Initialize allAccountManagers here to prevent undefined errors
    let currentUser = null; // Initialize currentUser here to prevent undefined errors
    let formDataChanged = false; // Flag to track if form data has been modified
    let isMobile = false; // Mobile detection flag
    let isCloud = false; // Deprecated indicator disabled

    // Navigation functions - defined early to avoid reference errors
    function goBack() {
      window.location.href = 'index.html';
    }

    // Mobile detection and optimization
    function detectMobile() {
      isMobile = window.innerWidth <= 768;
      document.body.classList.toggle('mobile', isMobile);
      return isMobile;
    }
    
    // Optimize for mobile viewport
    function optimizeForMobile() {
      if (isMobile) {
        // Add mobile-specific classes
        document.body.classList.add('mobile');
        
        // Optimize charts for mobile
        const charts = document.querySelectorAll('canvas');
        charts.forEach(chart => {
          if (chart.chart) {
            chart.chart.resize();
          }
        });
        
        // Optimize tables for mobile
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
          if (!table.classList.contains('mobile-kpi-table')) {
            table.classList.add('mobile-table');
          }
        });
      }
    }
    
    // Get college ID from URL parameters
    function getCollegeId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    // Load college data from backend
    async function loadCollegeData() {
      try {
        const collegeId = getCollegeId();
        if (!collegeId) {
          showNotification('No college ID provided', 'error');
          return;
        }

        // Environment indicator removed

        // Load college details
        const collegeResponse = await fetch(`/api/colleges/${collegeId}`, {
          credentials: 'include'
        });
        
        if (collegeResponse.status === 401) {
          // Authentication failed, redirect to login
          window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
          return;
        }
        
        const collegeResult = await collegeResponse.json();
        
        if (!collegeResult.success) {
          throw new Error(collegeResult.error || 'Failed to load college data');
        }

        collegeData = collegeResult.college;
        console.log('College data loaded:', collegeData);
        
        // Load all account managers for dropdown
        const allAmResponse = await fetch('/api/account-managers', {
          credentials: 'include'
        });
        
        if (allAmResponse.status === 401) {
          // Authentication failed, redirect to login
          window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
          return;
        }
        
        const allAmResult = await allAmResponse.json();
        if (Array.isArray(allAmResult)) {
          allAccountManagers = allAmResult;
        }
        
        // Load account manager data if available
        if (collegeData.accountManagerId) {
          const amResponse = await fetch(`/api/account-managers/${collegeData.accountManagerId}`, {
            credentials: 'include'
          });
          const amResult = await amResponse.json();
          if (amResult.success) {
            accountManagerData = amResult.accountManager;
          }
        }

        // Load college reports
        const reportsResponse = await fetch(`/api/colleges/${collegeId}/reports`, {
          credentials: 'include'
        });
        
        if (reportsResponse.status === 401) {
          // Authentication failed, redirect to login
          window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
          return;
        }
        
        const reportsResult = await reportsResponse.json();
        console.log('Reports API response:', reportsResult);
        console.log('Reports data:', reportsResult.reports);
        
        if (reportsResult.reports) {
          collegeReports = reportsResult.reports;
        }

        // Initialise share UI state
        initShareControls();

        // Update the dashboard with real data
        updateDashboardData();
        
        // Environment badge removed
        
        // Load all AI insights after college data is loaded
        loadAllAIInsights();
        
      } catch (error) {
        console.error('Error loading college data:', error);
        showNotification('Error loading college data: ' + error.message, 'error');
      }
    }

    // Update dashboard with real data
    function updateDashboardData() {
      if (!collegeData) return;

      // Update page title
      document.querySelector('h1').textContent = `${collegeData.name} Dashboard`;

      // Update general information in Details tab
      document.getElementById('collegeName').value = collegeData.name || '';
      
      // Populate account manager dropdown
      const accountManagerSelect = document.getElementById('accountManager');
      if (accountManagerSelect && allAccountManagers.length > 0) {
        accountManagerSelect.innerHTML = '<option value="">Unassigned</option>' +
          allAccountManagers.map(am => `<option value="${am.id}">${am.name}</option>`).join('');
        accountManagerSelect.value = collegeData.accountManagerId || '';
      }
      
      document.getElementById('reportFrequency').value = collegeData.reportFrequency || 'weekly';
      document.getElementById('numberOfProviders').value = collegeData.numberOfProviders || '';

      // Update modules dynamically
      updateModulesDisplay();

      // Update key stakeholders and super users
      updateKeyStakeholdersDisplay();
      updateSuperUsersDisplay();

      // Update MIS contact information
      updateMISContactDisplay();

      // Update performance indicators
      updatePerformanceIndicatorsDisplay();

      // Update SWOT analysis
      updateSWOTDisplay();

      // Update template and notes
      const tplEl = document.getElementById('collegeTemplate'); if (tplEl) tplEl.value = collegeData.template || 'standard';
      const notesEl = document.getElementById('initialConcerns'); if (notesEl) notesEl.value = collegeData.initialConcerns || '';

      // Update metrics with data from latest report
      updateMetricsFromLatestReport();

      // Generate AI insights (now handled by enhanced analytics when analytics tab is shown)
      // generateAIInsights(); // Replaced by Gemini 2.5 Flash enhanced analytics

      // Update reports list and table
      updateReportsList();
      updateReportsTable();
      
      // Initialize charts with real data
      initializeCharts().catch(error => {
        console.error('Error initializing charts:', error);
      });
      
      // Enhanced analytics are now loaded on page load, so no need to reload here
    }

    // Function to update modules display
    function updateModulesDisplay() {
      // Don't update if form data has been changed by user
      if (formDataChanged) return;
      
      const modulesContainer = document.getElementById('modules-container');
      modulesContainer.innerHTML = '';
      
      if (collegeData.modules && collegeData.modules.length > 0) {
        collegeData.modules.forEach(module => {
          const moduleDiv = document.createElement('div');
          moduleDiv.className = 'module-entry grid grid-cols-1 md:grid-cols-3 gap-4';
          moduleDiv.innerHTML = `
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Module Name</label>
              <input type="text" value="${module.name || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cost (£)</label>
              <input type="number" value="${module.cost || 0}" class="module-cost border border-gray-300 rounded-md px-3 py-2 w-full" onchange="updateTotalCost(); formDataChanged = true">
            </div>
            <div class="flex items-end">
              <button onclick="removeModule(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
            </div>
          `;
          modulesContainer.appendChild(moduleDiv);
        });
      }
      
      // Update total cost
      updateTotalCost();
    }

    // Function to update key stakeholders display
    function updateKeyStakeholdersDisplay() {
      // Don't update if form data has been changed by user (unless force update)
      if (formDataChanged && !arguments[0]) return;
      
      const stakeholdersContainer = document.getElementById('key-stakeholders-container');
      stakeholdersContainer.innerHTML = '';
      
      if (collegeData.keyStakeholders && collegeData.keyStakeholders.length > 0) {
        collegeData.keyStakeholders.forEach(stakeholder => {
          const stakeholderDiv = document.createElement('div');
          stakeholderDiv.className = 'stakeholder-entry grid grid-cols-1 md:grid-cols-4 gap-4';
          stakeholderDiv.innerHTML = `
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input type="text" value="${stakeholder.name || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
              <input type="text" value="${stakeholder.position || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" value="${stakeholder.email || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div class="flex items-end">
              <button onclick="removeStakeholder(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
            </div>
          `;
          stakeholdersContainer.appendChild(stakeholderDiv);
        });
      }
      
      // Always show at least one empty entry if no data
      if (stakeholdersContainer.children.length === 0) {
        addKeyStakeholder();
      }
    }

    // Function to update super users display
    function updateSuperUsersDisplay() {
      // Don't update if form data has been changed by user (unless force update)
      if (formDataChanged && !arguments[0]) return;
      
      const superUsersContainer = document.getElementById('super-users-container');
      superUsersContainer.innerHTML = '';
      
      if (collegeData.superUsers && collegeData.superUsers.length > 0) {
        collegeData.superUsers.forEach(user => {
          const userDiv = document.createElement('div');
          userDiv.className = 'super-user-entry grid grid-cols-1 md:grid-cols-4 gap-4';
          userDiv.innerHTML = `
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input type="text" value="${user.name || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
              <input type="text" value="${user.position || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" value="${user.email || ''}" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
            </div>
            <div class="flex items-end">
              <button onclick="removeSuperUser(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
            </div>
          `;
          superUsersContainer.appendChild(userDiv);
        });
      }
      
      // Always show at least one empty entry if no data
      if (superUsersContainer.children.length === 0) {
        addSuperUser();
      }
    }

    // Function to update MIS contact display
    function updateMISContactDisplay() {
      document.getElementById('dataTransferMethod').value = collegeData.dataTransferMethod || '';
      document.getElementById('misContactName').value = collegeData.misContactName || '';
      document.getElementById('misContactEmail').value = collegeData.misContactEmail || '';
      document.getElementById('renewalDate').value = collegeData.renewalDate || '';
      const csEl = document.getElementById('collegeSystem'); if (csEl) csEl.value = collegeData.collegeSystem || 'Pro Monitor';
    }

    // Function to update performance indicators display
    function updatePerformanceIndicatorsDisplay() {
      document.getElementById('status').value = collegeData.status || 'B';
      document.getElementById('ofstedRating').value = collegeData.ofstedRating || 'O';
      document.getElementById('engagementLevel').value = collegeData.engagementLevel || 'Excellent';
    }

    // Function to update SWOT analysis display
    function updateSWOTDisplay() {
      document.getElementById('swotStrengths').value = collegeData.swotStrengths || '';
      document.getElementById('swotWeaknesses').value = collegeData.swotWeaknesses || '';
      document.getElementById('swotOpportunities').value = collegeData.swotOpportunities || '';
      document.getElementById('swotThreats').value = collegeData.swotThreats || '';
    }

    // Function to save SWOT analysis
    async function saveSWOTAnalysis() {
      if (!collegeData) {
        showNotification('No college data available', 'error');
        return;
      }

      try {
        const swotData = {
          swotStrengths: document.getElementById('swotStrengths').value,
          swotWeaknesses: document.getElementById('swotWeaknesses').value,
          swotOpportunities: document.getElementById('swotOpportunities').value,
          swotThreats: document.getElementById('swotThreats').value
        };

        const response = await fetch(`/api/colleges/${collegeData.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(swotData)
        });

        const result = await response.json();
        
        if (result.success) {
          showNotification('SWOT Analysis saved successfully', 'success');
          collegeData = { ...collegeData, ...swotData };
        } else {
          throw new Error(result.error || 'Failed to save SWOT analysis');
        }
      } catch (error) {
        console.error('Error saving SWOT analysis:', error);
        showNotification('Error saving SWOT analysis: ' + error.message, 'error');
      }
    }

    // Function to generate AI insights based on report data (Legacy - replaced by Gemini 2.5 Flash)
    function generateAIInsights() {
      // This function is now replaced by the enhanced Gemini 2.5 Flash analytics
      // The insights are now handled by loadAndDisplayEnhancedAnalytics()
      console.log('Legacy AI insights function called - now using Gemini 2.5 Flash enhanced analytics');
    }

    // Function to analyze report data and generate insights
    function analyzeReportData(current, previous) {
      const insights = {
        positiveTrends: [],
        improvements: [],
        recommendations: []
      };

      // Compare with previous data if available
      if (previous) {
        // Placements analysis
        if (current.percentWithPlacements > previous.percentWithPlacements) {
          const increase = (current.percentWithPlacements - previous.percentWithPlacements).toFixed(1);
          insights.positiveTrends.push(`Placement rate increased by ${increase}% since last report`);
        } else if (current.percentWithPlacements < previous.percentWithPlacements) {
          const decrease = (previous.percentWithPlacements - current.percentWithPlacements).toFixed(1);
          insights.improvements.push(`Placement rate decreased by ${decrease}% - requires attention`);
        }

        // Activities analysis
        if (current.percentStudentsWithActivities > previous.percentStudentsWithActivities) {
          const increase = (current.percentStudentsWithActivities - previous.percentStudentsWithActivities).toFixed(1);
          insights.positiveTrends.push(`Student activity participation improved by ${increase}%`);
        } else if (current.percentStudentsWithActivities < previous.percentStudentsWithActivities) {
          const decrease = (previous.percentStudentsWithActivities - current.percentStudentsWithActivities).toFixed(1);
          insights.improvements.push(`Student activity participation declined by ${decrease}%`);
        }

        // Student numbers analysis
        if (current.totalStudents > previous.totalStudents) {
          const increase = current.totalStudents - previous.totalStudents;
          insights.positiveTrends.push(`Student enrollment increased by ${increase} students`);
        }
      }

      // Current performance analysis
      if (current.percentWithPlacements >= 70) {
        insights.positiveTrends.push(`Strong placement performance at ${current.percentWithPlacements.toFixed(1)}%`);
      } else if (current.percentWithPlacements < 40) {
        insights.improvements.push(`Low placement rate (${current.percentWithPlacements.toFixed(1)}%) needs urgent attention`);
        insights.recommendations.push('<strong>Immediate Action:</strong> Review placement process and employer partnerships');
      }

      if (current.percentStudentsWithActivities >= 80) {
        insights.positiveTrends.push(`Excellent activity engagement at ${current.percentStudentsWithActivities.toFixed(1)}%`);
      } else if (current.percentStudentsWithActivities < 60) {
        insights.improvements.push(`Activity participation (${current.percentStudentsWithActivities.toFixed(1)}%) below target`);
        insights.recommendations.push('<strong>Short-term:</strong> Develop more engaging activity programs');
      }

      // Assessment analysis
      const assessmentRate = current.totalStudents > 0 ? ((current.totalStudents - current.studentsWithoutAssessments) / current.totalStudents * 100) : 0;
      if (assessmentRate < 50) {
        insights.improvements.push(`Low assessment completion rate (${assessmentRate.toFixed(1)}%)`);
        insights.recommendations.push('<strong>Immediate Action:</strong> Implement mandatory assessment tracking system');
      }

      // Default insights if no specific trends identified
      if (insights.positiveTrends.length === 0) {
        insights.positiveTrends.push('Stable performance metrics maintained');
        insights.positiveTrends.push('Regular reporting schedule being followed');
      }

      if (insights.improvements.length === 0) {
        insights.improvements.push('Continue monitoring key performance indicators');
        insights.improvements.push('Consider opportunities for further growth');
      }

      if (insights.recommendations.length === 0) {
        insights.recommendations.push('<strong>Continue:</strong> Maintain current best practices');
        insights.recommendations.push('<strong>Monitor:</strong> Track performance trends monthly');
        insights.recommendations.push('<strong>Plan:</strong> Set targets for next reporting period');
      }

      return insights;
    }

    // Update metrics from the latest report data
    function updateMetricsFromLatestReport() {
      if (!collegeReports || collegeReports.length === 0) {
        // No reports available - show no data message
        showNoDataMessage();
        return;
      }

      // Get the latest report by sorting by creation date
      const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const latestReport = sortedReports[0];
      
      if (!latestReport.data || !latestReport.data.rows) {
        // No data in latest report - show no data message
        showNoDataMessage();
        return;
      }

      // Calculate totals from the report data
      const totals = calculateTotalsFromReport(latestReport.data);
      console.log('Calculated totals:', totals);
      
      // Determine which sections are available in the data
      const availableSections = determineAvailableSections(latestReport.data);
      console.log('Available sections:', availableSections);
      
      // Update the metrics cards
      updateMetricsCards(totals, availableSections);
      
      // Update the detailed metrics sections
      updateDetailedMetrics(totals, availableSections);
    }

    // Show no data message
    function showNoDataMessage() {
      // Hide loading card
      const loadingCard = document.getElementById('loadingCard');
      if (loadingCard) {
        loadingCard.style.display = 'none';
      }

      // Update total students display
      const totalStudentsDisplay = document.getElementById('totalStudentsDisplay');
      const studentsTrend = document.getElementById('studentsTrend');
      if (totalStudentsDisplay) {
        totalStudentsDisplay.textContent = 'No Data';
      }
      if (studentsTrend) {
        studentsTrend.textContent = 'No reports available';
      }

      // Show no data message in metrics cards
      const metricsCards = ['placementsCard', 'careersCard', 'activitiesCard', 'assessmentsCard'];
      metricsCards.forEach(cardId => {
        const card = document.getElementById(cardId);
        const valueElement = document.getElementById(cardId.replace('Card', 'Value'));
        const trendElement = document.getElementById(cardId.replace('Card', 'Trend'));
        
        if (card) {
          card.style.display = 'block';
        }
        if (valueElement) {
          valueElement.textContent = 'No Data';
        }
        if (trendElement) {
          trendElement.textContent = 'No reports available';
        }
      });

      // Show no data message in detailed metrics
      const detailedCards = ['placementsDetailsCard', 'careersDetailsCard', 'activitiesDetailsCard', 'assessmentsDetailsCard'];
      detailedCards.forEach(cardId => {
        const card = document.getElementById(cardId);
        if (card) {
          card.style.display = 'block';
        }
      });

      // Update detailed metrics with no data messages
      const detailedSections = ['placementsDetails', 'careersDetails', 'activitiesDetails', 'assessmentsDetails'];
      detailedSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          const spans = section.querySelectorAll('span.font-semibold');
          spans.forEach(span => {
            if (!span.classList.contains('text-gray-600')) {
              span.textContent = 'No Data';
            }
          });
        }
      });
    }

    // Determine which sections are available in the report data
    function determineAvailableSections(reportData) {
      const headers = reportData.headers || [];
      const sections = {
        placements: false,
        careers: false,
        activities: false,
        assessments: false
      };

      headers.forEach(header => {
        const headerLower = header.toLowerCase();
        
        if (headerLower.includes('placement') || headerLower.includes('placements')) {
          sections.placements = true;
        }
        if (headerLower.includes('career') || headerLower.includes('careers')) {
          sections.careers = true;
        }
        if (headerLower.includes('activity') || headerLower.includes('activities')) {
          sections.activities = true;
        }
        if (headerLower.includes('assessment') || headerLower.includes('assessments')) {
          sections.assessments = true;
        }
      });

      return sections;
    }
    // Calculate totals from report data
    function calculateTotalsFromReport(reportData) {
      const totals = {
        totalStudents: 0,
        totalPlacements: 0,
        studentsWithPlacements: 0,
        percentWithPlacements: 0,
        hoursScheduled: 0,
        studentConfirmed: 0,
        employerConfirmed: 0,
        studentsWithActivities: 0,
        studentsWithActivitiesEnrichment: 0,
        studentsWithActivitiesEmployer: 0,
        totalActivities: 0,
        totalActivitiesEnrichment: 0,
        totalActivitiesEmployer: 0,
        percentStudentsWithActivities: 0,
        percentStudentsWithActivitiesEnrichment: 0,
        percentStudentsWithActivitiesEmployer: 0,
        totalActivityHours: 0,
        totalActivityHoursEnrichment: 0,
        totalActivityHoursEmployer: 0,
        studentsWithoutAssessments: 0,
        studentsWithAssessments: 0,
        totalStudentsCareers: 0,
        studentsCompletedCareerQuiz: 0,
        percentCompletedCareerQuiz: 0,
        studentsWithMappedJobProfile: 0,
        percentWithMappedJobProfile: 0,
        totalMappedJobProfiles: 0
      };

      if (!reportData.rows || !reportData.headers) return totals;

      reportData.rows.forEach(row => {
        // Skip if this is a total row or empty row
        if (!row[0] || row[0].toLowerCase().includes('total')) return;

        // Map data based on column headers
        const headers = reportData.headers;
        
        // Find column indices with improved detection
        const totalStudentsIndex = headers.findIndex(h => 
          h.toLowerCase().includes('total') && h.toLowerCase().includes('student')
        );
        const placementsIndex = headers.findIndex(h => h.toLowerCase().includes('placement') && !h.toLowerCase().includes('percent'));
        const studentsWithPlacementsIndex = headers.findIndex(h => 
          h.toLowerCase().includes('students with placements')
        );
        const percentPlacementsIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('placement'));
        const hoursScheduledIndex = headers.findIndex(h => h.toLowerCase().includes('hour') && h.toLowerCase().includes('scheduled'));
        const studentConfirmedIndex = headers.findIndex(h => h.toLowerCase().includes('student') && h.toLowerCase().includes('confirmed'));
        const employerConfirmedIndex = headers.findIndex(h => h.toLowerCase().includes('employer') && h.toLowerCase().includes('confirmed'));
        
        // Handle separate employer/enrichment activities
        const studentsWithActivitiesEnrichmentIndex = headers.findIndex(h => 
          h.toLowerCase().includes('students with activities') && h.toLowerCase().includes('enrichment')
        );
        const studentsWithActivitiesEmployerIndex = headers.findIndex(h => 
          h.toLowerCase().includes('students with activities') && h.toLowerCase().includes('employer')
        );
        const studentsWithActivitiesIndex = headers.findIndex(h => 
          h.toLowerCase().includes('students with activities') && 
          !h.toLowerCase().includes('enrichment') && !h.toLowerCase().includes('employer')
        );
        
        const totalActivitiesIndex = headers.findIndex(h => h.toLowerCase().includes('total') && (h.toLowerCase().includes('activity') || h.toLowerCase().includes('activities')) && !h.toLowerCase().includes('hour'));
        const totalActivitiesEnrichmentIndex = headers.findIndex(h => h.toLowerCase().includes('total') && (h.toLowerCase().includes('activity') || h.toLowerCase().includes('activities')) && h.toLowerCase().includes('enrichment') && !h.toLowerCase().includes('hour'));
        const totalActivitiesEmployerIndex = headers.findIndex(h => h.toLowerCase().includes('total') && (h.toLowerCase().includes('activity') || h.toLowerCase().includes('activities')) && h.toLowerCase().includes('employer') && !h.toLowerCase().includes('hour'));
        const percentActivitiesIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('activity'));
        const percentActivitiesEnrichmentIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('activity') && h.toLowerCase().includes('enrichment'));
        const percentActivitiesEmployerIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('activity') && h.toLowerCase().includes('employer'));
        const activityHoursIndex = headers.findIndex(h => h.toLowerCase().includes('activity') && h.toLowerCase().includes('hour'));
        const activityHoursEnrichmentIndex = headers.findIndex(h => h.toLowerCase().includes('activity') && h.toLowerCase().includes('hour') && h.toLowerCase().includes('enrichment'));
        const activityHoursEmployerIndex = headers.findIndex(h => h.toLowerCase().includes('activity') && h.toLowerCase().includes('hour') && h.toLowerCase().includes('employer'));
        

        // Prefer explicit Students with/without Assessments columns if present; otherwise fall back to derived
        const studentsWithAssessmentsIndex = (() => {
          const lowered = headers.map(h => h.toLowerCase());
          const phrases = [
            'students with 1 assessment',
            'students with at least 1 assessment',
            'students with 1+ assessment',
            'students with at least one assessment',
            'students with ≥1 assessment',
            'students with 1 assessments'
          ];
          for (const p of phrases) {
            const idx = lowered.findIndex(h => h.includes(p));
            if (idx !== -1) return idx;
          }
          return lowered.findIndex(t => ((t.includes('students with') || t.includes('with')) && t.includes('assessment') && !t.includes('percent') && !t.includes('%') && !t.includes('hour') && !t.includes('avg') && !t.includes('average') && !t.includes('mean') && !t.includes('score') && !t.includes('(')));
        })();
        const studentsWithoutAssessmentsIndex = headers.findIndex(h =>
          h.toLowerCase().includes('students without') && h.toLowerCase().includes('assessment')
        );
        const totalStudentsCareersIndex = headers.findIndex(h => h.toLowerCase().includes('total') && h.toLowerCase().includes('student') && h.toLowerCase().includes('career'));
        const studentsCompletedCareerQuizIndex = headers.findIndex(h => h.toLowerCase().includes('student') && h.toLowerCase().includes('completed') && h.toLowerCase().includes('career') && h.toLowerCase().includes('quiz'));
        const percentCompletedCareerQuizIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('completed') && h.toLowerCase().includes('career') && h.toLowerCase().includes('quiz'));
        const studentsWithMappedJobProfileIndex = headers.findIndex(h => h.toLowerCase().includes('student') && h.toLowerCase().includes('mapped') && h.toLowerCase().includes('job') && h.toLowerCase().includes('profile'));
        const percentWithMappedJobProfileIndex = headers.findIndex(h => h.toLowerCase().includes('percent') && h.toLowerCase().includes('mapped') && h.toLowerCase().includes('job') && h.toLowerCase().includes('profile'));
        const totalMappedJobProfilesIndex = headers.findIndex(h => h.toLowerCase().includes('total') && h.toLowerCase().includes('mapped') && h.toLowerCase().includes('job') && h.toLowerCase().includes('profile'));

        // Sum up the values with improved parsing
        if (totalStudentsIndex >= 0 && row[totalStudentsIndex]) {
          const value = parseFloat(row[totalStudentsIndex]);
          if (!isNaN(value)) {
            totals.totalStudents += value;
          }
        }
        if (placementsIndex >= 0 && row[placementsIndex]) {
          const value = parseFloat(row[placementsIndex]);
          if (!isNaN(value)) {
            totals.totalPlacements += value;
          }
        }
        if (studentsWithPlacementsIndex >= 0 && row[studentsWithPlacementsIndex]) {
          const value = parseFloat(row[studentsWithPlacementsIndex]);
          if (!isNaN(value)) {
            totals.studentsWithPlacements += value;
          }
        }
        if (hoursScheduledIndex >= 0 && row[hoursScheduledIndex]) {
          const value = parseFloat(row[hoursScheduledIndex]);
          if (!isNaN(value)) {
            totals.hoursScheduled += value;
          }
        }
        if (studentConfirmedIndex >= 0 && row[studentConfirmedIndex]) {
          const value = parseFloat(row[studentConfirmedIndex]);
          if (!isNaN(value)) {
            totals.studentConfirmed += value;
          }
        }
        if (employerConfirmedIndex >= 0 && row[employerConfirmedIndex]) {
          const value = parseFloat(row[employerConfirmedIndex]);
          if (!isNaN(value)) {
            totals.employerConfirmed += value;
          }
        }
        // Handle activities - track enrichment and employer separately
        if (studentsWithActivitiesEnrichmentIndex >= 0 && row[studentsWithActivitiesEnrichmentIndex]) {
          const value = parseFloat(row[studentsWithActivitiesEnrichmentIndex]);
          if (!isNaN(value)) {
            totals.studentsWithActivitiesEnrichment += value;
          }
        }
        if (studentsWithActivitiesEmployerIndex >= 0 && row[studentsWithActivitiesEmployerIndex]) {
          const value = parseFloat(row[studentsWithActivitiesEmployerIndex]);
          if (!isNaN(value)) {
            totals.studentsWithActivitiesEmployer += value;
          }
        }
        if (studentsWithActivitiesIndex >= 0 && row[studentsWithActivitiesIndex]) {
          const value = parseFloat(row[studentsWithActivitiesIndex]);
          if (!isNaN(value)) {
            totals.studentsWithActivities += value;
          }
        }
        
        // Calculate total students with activities (enrichment + employer) only if separate data exists
        if (totals.studentsWithActivitiesEnrichment > 0 || totals.studentsWithActivitiesEmployer > 0) {
          totals.studentsWithActivities = totals.studentsWithActivitiesEnrichment + totals.studentsWithActivitiesEmployer;
        }
        
        // Handle activity totals and hours separately
        if (totalActivitiesEnrichmentIndex >= 0 && row[totalActivitiesEnrichmentIndex]) {
          const value = parseFloat(row[totalActivitiesEnrichmentIndex]);
          if (!isNaN(value)) {
            totals.totalActivitiesEnrichment += value;
          }
        }
        if (totalActivitiesEmployerIndex >= 0 && row[totalActivitiesEmployerIndex]) {
          const value = parseFloat(row[totalActivitiesEmployerIndex]);
          if (!isNaN(value)) {
            totals.totalActivitiesEmployer += value;
          }
        }
        if (totalActivitiesIndex >= 0 && row[totalActivitiesIndex]) {
          const value = parseFloat(row[totalActivitiesIndex]);
          if (!isNaN(value)) {
            totals.totalActivities += value;
          }
        }
        if (studentsWithAssessmentsIndex >= 0 && row[studentsWithAssessmentsIndex] !== undefined) {
          const value = parseFloat(row[studentsWithAssessmentsIndex]);
          if (!isNaN(value)) {
            totals.studentsWithAssessments += value;
          }
        }
        
        // Calculate total activities (enrichment + employer) if not already calculated
        if (totals.totalActivitiesEnrichment > 0 || totals.totalActivitiesEmployer > 0) {
          totals.totalActivities = totals.totalActivitiesEnrichment + totals.totalActivitiesEmployer;
        }
        
        if (activityHoursEnrichmentIndex >= 0 && row[activityHoursEnrichmentIndex]) {
          const value = parseFloat(row[activityHoursEnrichmentIndex]);
          if (!isNaN(value)) {
            totals.totalActivityHoursEnrichment += value;
          }
        }
        if (activityHoursEmployerIndex >= 0 && row[activityHoursEmployerIndex]) {
          const value = parseFloat(row[activityHoursEmployerIndex]);
          if (!isNaN(value)) {
            totals.totalActivityHoursEmployer += value;
          }
        }
        if (activityHoursIndex >= 0 && row[activityHoursIndex]) {
          const value = parseFloat(row[activityHoursIndex]);
          if (!isNaN(value)) {
            totals.totalActivityHours += value;
          }
        }
        
        // Calculate total activity hours (enrichment + employer) if not already calculated
        if (totals.totalActivityHoursEnrichment > 0 || totals.totalActivityHoursEmployer > 0) {
          totals.totalActivityHours = totals.totalActivityHoursEnrichment + totals.totalActivityHoursEmployer;
        }
        if (studentsWithoutAssessmentsIndex >= 0 && row[studentsWithoutAssessmentsIndex] !== undefined) {
          const value = parseFloat(row[studentsWithoutAssessmentsIndex]);
          if (!isNaN(value)) {
            totals.studentsWithoutAssessments += value;
          }
        } else if (totalStudentsIndex >= 0) {
          // Fallback: derive from completed assessments if column exists
          const completedIdx = (studentsWithAssessmentsIndex >= 0) ? studentsWithAssessmentsIndex : headers.findIndex(h => h.toLowerCase().includes('students with assessments'));
          if (completedIdx >= 0 && row[completedIdx] !== undefined) {
            const total = parseFloat(row[totalStudentsIndex]);
            const completed = parseFloat(row[completedIdx]);
            if (!isNaN(total) && !isNaN(completed)) {
              totals.studentsWithoutAssessments += Math.max(0, total - completed);
              totals.studentsWithAssessments += completed;
            }
          }
        }
        if (totalStudentsCareersIndex >= 0 && row[totalStudentsCareersIndex]) {
          const value = parseFloat(row[totalStudentsCareersIndex]);
          if (!isNaN(value)) {
            totals.totalStudentsCareers += value;
          }
        }
        if (studentsCompletedCareerQuizIndex >= 0 && row[studentsCompletedCareerQuizIndex]) {
          const value = parseFloat(row[studentsCompletedCareerQuizIndex]);
          if (!isNaN(value)) {
            totals.studentsCompletedCareerQuiz += value;
          }
        }
        if (studentsWithMappedJobProfileIndex >= 0 && row[studentsWithMappedJobProfileIndex]) {
          const value = parseFloat(row[studentsWithMappedJobProfileIndex]);
          if (!isNaN(value)) {
            totals.studentsWithMappedJobProfile += value;
          }
        }
        if (totalMappedJobProfilesIndex >= 0 && row[totalMappedJobProfilesIndex]) {
          const value = parseFloat(row[totalMappedJobProfilesIndex]);
          if (!isNaN(value)) {
            totals.totalMappedJobProfiles += value;
          }
        }
        
        // Use pre-calculated percentages from the data (weighted average)
        if (percentPlacementsIndex >= 0 && row[percentPlacementsIndex]) {
          const percentValue = parseFloat(row[percentPlacementsIndex]);
          const studentsInRow = parseFloat(row[totalStudentsIndex]);
          if (!isNaN(percentValue) && !isNaN(studentsInRow)) {
            // Convert decimal to percentage if needed and weight by number of students
            const percentage = percentValue <= 1 ? percentValue * 100 : percentValue;
            totals.percentWithPlacements += (percentage * studentsInRow);
          }
        }
        if (percentActivitiesEnrichmentIndex >= 0 && row[percentActivitiesEnrichmentIndex]) {
          const percentValue = parseFloat(row[percentActivitiesEnrichmentIndex]);
          const studentsInRow = parseFloat(row[totalStudentsIndex]);
          if (!isNaN(percentValue) && !isNaN(studentsInRow)) {
            // Convert decimal to percentage if needed and weight by number of students
            const percentage = percentValue <= 1 ? percentValue * 100 : percentValue;
            totals.percentStudentsWithActivitiesEnrichment += (percentage * studentsInRow);
          }
        }
        if (percentActivitiesEmployerIndex >= 0 && row[percentActivitiesEmployerIndex]) {
          const percentValue = parseFloat(row[percentActivitiesEmployerIndex]);
          const studentsInRow = parseFloat(row[totalStudentsIndex]);
          if (!isNaN(percentValue) && !isNaN(studentsInRow)) {
            // Convert decimal to percentage if needed and weight by number of students
            const percentage = percentValue <= 1 ? percentValue * 100 : percentValue;
            totals.percentStudentsWithActivitiesEmployer += (percentage * studentsInRow);
          }
        }
        if (percentActivitiesIndex >= 0 && row[percentActivitiesIndex]) {
          const percentValue = parseFloat(row[percentActivitiesIndex]) || 0;
          const studentsInRow = parseFloat(row[totalStudentsIndex]) || 0;
          // Convert decimal to percentage if needed and weight by number of students
          const percentage = percentValue <= 1 ? percentValue * 100 : percentValue;
          totals.percentStudentsWithActivities += (percentage * studentsInRow);
        }

      });

      // Calculate final weighted average percentages
      if (totals.totalStudents > 0) {
        if (totals.percentWithPlacements > 0) {
          totals.percentWithPlacements = totals.percentWithPlacements / totals.totalStudents;
        } else {
          totals.percentWithPlacements = (totals.studentsWithPlacements / totals.totalStudents) * 100;
        }
        if (totals.percentStudentsWithActivitiesEnrichment > 0) {
          totals.percentStudentsWithActivitiesEnrichment = totals.percentStudentsWithActivitiesEnrichment / totals.totalStudents;
        } else {
          totals.percentStudentsWithActivitiesEnrichment = (totals.studentsWithActivitiesEnrichment / totals.totalStudents) * 100;
        }
        if (totals.percentStudentsWithActivitiesEmployer > 0) {
          totals.percentStudentsWithActivitiesEmployer = totals.percentStudentsWithActivitiesEmployer / totals.totalStudents;
        } else {
          totals.percentStudentsWithActivitiesEmployer = (totals.studentsWithActivitiesEmployer / totals.totalStudents) * 100;
        }
        if (totals.percentStudentsWithActivities > 0) {
          totals.percentStudentsWithActivities = totals.percentStudentsWithActivities / totals.totalStudents;
        } else {
          totals.percentStudentsWithActivities = (totals.studentsWithActivities / totals.totalStudents) * 100;
        }
        
        // Calculate careers percentages
        if (totals.totalStudents > 0) {
          // Calculate percentage based on total students, not just careers subset
          totals.percentCompletedCareerQuiz = (totals.studentsCompletedCareerQuiz / totals.totalStudents) * 100;
          totals.percentWithMappedJobProfile = (totals.studentsWithMappedJobProfile / totals.totalStudents) * 100;
        }
      }

      return totals;
    }

    // Update the metrics cards
    function updateMetricsCards(totals, availableSections) {
      // Hide loading card
      const loadingCard = document.getElementById('loadingCard');
      if (loadingCard) {
        loadingCard.style.display = 'none';
      }

      // Update total students card
      const totalStudentsDisplay = document.getElementById('totalStudentsDisplay');
      const studentsTrend = document.getElementById('studentsTrend');
      if (totalStudentsDisplay) {
        totalStudentsDisplay.textContent = totals.totalStudents.toLocaleString();
      }
      if (studentsTrend) {
        studentsTrend.textContent = 'Data loaded from latest report';
      }

      // Show and update placements card if available
      if (availableSections.placements) {
        const placementsCard = document.getElementById('placementsCard');
        const placementsValue = document.getElementById('placementsValue');
        const placementsTrend = document.getElementById('placementsTrend');
        
        if (placementsCard) {
          placementsCard.style.display = 'block';
        }
        if (placementsValue) {
          // Use the correct data from enhanced analytics
          const studentsWithPlacements = totals.studentsWithPlacements || 0;
          const percentWithPlacements = totals.percentWithPlacements || 0;
          placementsValue.textContent = `${studentsWithPlacements.toLocaleString()} (${percentWithPlacements.toFixed(1)}%)`;
        }
        if (placementsTrend) {
          placementsTrend.textContent = 'Data from latest report';
        }
      }

      // Show and update careers card if available
      if (availableSections.careers) {
        const careersCard = document.getElementById('careersCard');
        const careersValue = document.getElementById('careersValue');
        const careersTrend = document.getElementById('careersTrend');
        
        if (careersCard) {
          careersCard.style.display = 'block';
        }
        if (careersValue) {
          // Use actual careers data from the report
          const careersData = totals.studentsCompletedCareerQuiz || 0;
          const careerPercentage = totals.totalStudents > 0 ? totals.percentCompletedCareerQuiz : 0;
          careersValue.textContent = `${careersData.toLocaleString()} (${careerPercentage.toFixed(1)}%)`;
        }
        if (careersTrend) {
          careersTrend.textContent = 'Data from latest report';
        }
      }

      // Show and update enrichment activities card if available
      if (availableSections.activities && (totals.studentsWithActivitiesEnrichment > 0 || totals.studentsWithActivities > 0)) {
        const enrichmentActivitiesCard = document.getElementById('enrichmentActivitiesCard');
        const enrichmentActivitiesValue = document.getElementById('enrichmentActivitiesValue');
        const enrichmentActivitiesTrend = document.getElementById('enrichmentActivitiesTrend');
        
        if (enrichmentActivitiesCard) {
          enrichmentActivitiesCard.style.display = 'block';
        }
        // Update card title dynamically
        const enrichmentActivitiesTitle = document.getElementById('enrichmentActivitiesTitle');
        if (enrichmentActivitiesTitle) {
          enrichmentActivitiesTitle.textContent = totals.studentsWithActivitiesEnrichment > 0 ? 'Enrichment Activities' : 'Activities';
        }
        
        if (enrichmentActivitiesValue) {
          // If separate enrichment data exists, use it; otherwise use general activities data
          const studentsWithActivitiesEnrichment = totals.studentsWithActivitiesEnrichment > 0 ? totals.studentsWithActivitiesEnrichment : totals.studentsWithActivities;
          const percentStudentsWithActivitiesEnrichment = totals.percentStudentsWithActivitiesEnrichment > 0 ? totals.percentStudentsWithActivitiesEnrichment : totals.percentStudentsWithActivities;
          enrichmentActivitiesValue.textContent = `${studentsWithActivitiesEnrichment.toLocaleString()} (${percentStudentsWithActivitiesEnrichment.toFixed(1)}%)`;
        }
        if (enrichmentActivitiesTrend) {
          enrichmentActivitiesTrend.textContent = totals.studentsWithActivitiesEnrichment > 0 ? 'Enrichment activities from latest report' : 'All activities from latest report';
        }
      }

      // Show and update employer activities card if available
      if (availableSections.activities && totals.studentsWithActivitiesEmployer > 0) {
        const employerActivitiesCard = document.getElementById('employerActivitiesCard');
        const employerActivitiesValue = document.getElementById('employerActivitiesValue');
        const employerActivitiesTrend = document.getElementById('employerActivitiesTrend');
        
        if (employerActivitiesCard) {
          employerActivitiesCard.style.display = 'block';
        }
        if (employerActivitiesValue) {
          const studentsWithActivitiesEmployer = totals.studentsWithActivitiesEmployer || 0;
          const percentStudentsWithActivitiesEmployer = totals.percentStudentsWithActivitiesEmployer || 0;
          employerActivitiesValue.textContent = `${studentsWithActivitiesEmployer.toLocaleString()} (${percentStudentsWithActivitiesEmployer.toFixed(1)}%)`;
        }
        if (employerActivitiesTrend) {
          employerActivitiesTrend.textContent = 'Employer activities from latest report';
        }
      }

      // Show and update assessments card if available
      if (availableSections.assessments) {
        const assessmentsCard = document.getElementById('assessmentsCard');
        const assessmentsValue = document.getElementById('assessmentsValue');
        const assessmentsTrend = document.getElementById('assessmentsTrend');
        
        if (assessmentsCard) {
          assessmentsCard.style.display = 'block';
        }
        if (assessmentsValue) {
          const completedAssessments = totals.studentsWithAssessments > 0 ? totals.studentsWithAssessments : (totals.totalStudents - totals.studentsWithoutAssessments);
          const assessmentPercentage = totals.totalStudents > 0 ? ((completedAssessments / totals.totalStudents) * 100).toFixed(1) : 0;
          assessmentsValue.textContent = `${completedAssessments.toLocaleString()} (${assessmentPercentage}%)`;
        }
        if (assessmentsTrend) {
          assessmentsTrend.textContent = 'Data from latest report';
        }
      }

      // Update grid columns based on number of visible cards
      const gridContainer = document.getElementById('metricsCardsContainer');
      if (gridContainer) {
        const visibleCards = [availableSections.placements, availableSections.careers, availableSections.activities, availableSections.assessments].filter(Boolean).length;
        
        if (visibleCards === 1) {
          gridContainer.className = 'grid grid-cols-1 gap-4 sm:gap-6 mb-8';
        } else if (visibleCards === 2) {
          gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-8';
        } else if (visibleCards === 3) {
          gridContainer.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-8';
        } else {
          gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8';
        }
      }
    }

    // Update the detailed metrics sections
    function updateDetailedMetrics(totals, availableSections) {
      console.log('Updating detailed metrics with totals:', totals);
      
      // Show and update placements details if available
      if (availableSections.placements) {
        const placementsCard = document.getElementById('placementsDetailsCard');
        console.log('Placements card found:', !!placementsCard);
        if (placementsCard) {
          placementsCard.style.display = 'block';
          console.log('Placements card display set to:', placementsCard.style.display);
          updatePlacementsDetails(totals);
        }
      }

      // Show and update careers details if available
      if (availableSections.careers) {
        const careersCard = document.getElementById('careersDetailsCard');
        if (careersCard) {
          careersCard.style.display = 'block';
          updateCareersDetails(totals);
        }
      }

      // Show and update enrichment activities details if available
      if (availableSections.activities && (totals.studentsWithActivitiesEnrichment > 0 || totals.studentsWithActivities > 0)) {
        const enrichmentActivitiesCard = document.getElementById('enrichmentActivitiesDetailsCard');
        console.log('Enrichment activities card found:', !!enrichmentActivitiesCard);
        if (enrichmentActivitiesCard) {
          enrichmentActivitiesCard.style.display = 'block';
          console.log('Enrichment activities card display set to:', enrichmentActivitiesCard.style.display);
          updateEnrichmentActivitiesDetails(totals);
        }
      }

      // Show and update employer activities details if available
      if (availableSections.activities && totals.studentsWithActivitiesEmployer > 0) {
        const employerActivitiesCard = document.getElementById('employerActivitiesDetailsCard');
        console.log('Employer activities card found:', !!employerActivitiesCard);
        if (employerActivitiesCard) {
          employerActivitiesCard.style.display = 'block';
          console.log('Employer activities card display set to:', employerActivitiesCard.style.display);
          updateEmployerActivitiesDetails(totals);
        }
      }

      // Show and update assessments details if available
      if (availableSections.assessments) {
        const assessmentsCard = document.getElementById('assessmentsDetailsCard');
        if (assessmentsCard) {
          assessmentsCard.style.display = 'block';
          updateAssessmentsDetails(totals);
        }
      }

      // Update grid columns for detailed sections based on number of visible sections
      const detailedGridContainer = document.getElementById('detailedMetricsContainer');
      if (detailedGridContainer) {
        // Count visible sections (activities counts as 1 or 2 depending on data)
        let visibleSections = 0;
        if (availableSections.placements) visibleSections++;
        if (availableSections.careers) visibleSections++;
        if (availableSections.activities) {
          // Count enrichment activities (always shown if activities exist)
          visibleSections++;
          // Count employer activities (only if separate employer data exists)
          if (totals.studentsWithActivitiesEmployer > 0) visibleSections++;
        }
        if (availableSections.assessments) visibleSections++;
        
        if (visibleSections === 1) {
          detailedGridContainer.className = 'grid grid-cols-1 gap-4 sm:gap-6 mb-8';
        } else if (visibleSections === 2) {
          detailedGridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mb-8';
        } else if (visibleSections === 3) {
          detailedGridContainer.className = 'grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-8';
        } else {
          detailedGridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8';
        }
      }
    }

    // Update placements details
    function updatePlacementsDetails(totals) {
      const placementsDetails = document.getElementById('placementsDetails');
      if (!placementsDetails) {
        console.log('Placements details element not found');
        return;
      }

      const details = placementsDetails.querySelectorAll('.flex.justify-between.items-center');
      console.log('Found placement details elements:', details.length);
      
      if (details[0]) {
        details[0].querySelector('span:last-child').textContent = totals.studentsWithPlacements.toLocaleString();
      }
      
      if (details[1]) {
        const percentSpan = details[1].querySelector('span.font-semibold.mr-2');
        const progressBar = details[1].querySelector('.h-2.bg-green-500');
        console.log('Updating placements progress bar:', {
          percentSpan: !!percentSpan,
          progressBar: !!progressBar,
          percentValue: totals.percentWithPlacements,
          width: `${Math.min(totals.percentWithPlacements, 100)}%`,
          details1HTML: details[1].innerHTML
        });
        if (percentSpan) {
          percentSpan.textContent = `${totals.percentWithPlacements.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(totals.percentWithPlacements, 100)}%`;
          console.log('Progress bar width set to:', progressBar.style.width);
          // Add a visual indicator to make sure the bar is visible
          progressBar.style.backgroundColor = '#10B981'; // Bright green
          progressBar.style.transition = 'width 0.5s ease-in-out';
          progressBar.style.minWidth = '4px'; // Ensure minimum width
          progressBar.style.borderRadius = '4px'; // Rounded corners
          console.log('Progress bar styles applied:', {
            width: progressBar.style.width,
            backgroundColor: progressBar.style.backgroundColor,
            minWidth: progressBar.style.minWidth
          });
        } else {
          console.log('Progress bar not found in details[1]');
        }
      }
      
      if (details[2]) {
        details[2].querySelector('span:last-child').textContent = totals.hoursScheduled.toLocaleString();
      }
      
      if (details[3]) {
        details[3].querySelector('span:last-child').textContent = totals.studentConfirmed.toLocaleString();
      }
      
      if (details[4]) {
        details[4].querySelector('span:last-child').textContent = totals.employerConfirmed.toLocaleString();
      }
    }

    // Update enrichment activities details
    function updateEnrichmentActivitiesDetails(totals) {
      const enrichmentActivitiesDetails = document.getElementById('enrichmentActivitiesDetails');
      if (!enrichmentActivitiesDetails) return;

      // Update dynamic labels
      const enrichmentActivitiesDetailsTitle = document.getElementById('enrichmentActivitiesDetailsTitle');
      const enrichmentStudentsLabel = document.getElementById('enrichmentStudentsLabel');
      const enrichmentPercentLabel = document.getElementById('enrichmentPercentLabel');
      
      if (enrichmentActivitiesDetailsTitle) {
        enrichmentActivitiesDetailsTitle.textContent = totals.studentsWithActivitiesEnrichment > 0 ? 'Enrichment Activities' : 'Activities';
      }
      if (enrichmentStudentsLabel) {
        enrichmentStudentsLabel.textContent = totals.studentsWithActivitiesEnrichment > 0 ? 'Students with Enrichment Activities' : 'Students with Activities';
      }
      if (enrichmentPercentLabel) {
        enrichmentPercentLabel.textContent = totals.studentsWithActivitiesEnrichment > 0 ? '% Students with Enrichment Activities' : '% Students with Activities';
      }

      const details = enrichmentActivitiesDetails.querySelectorAll('.flex.justify-between.items-center');
      
      // Use enrichment data if available, otherwise use general activities data
      const studentsWithActivities = totals.studentsWithActivitiesEnrichment > 0 ? totals.studentsWithActivitiesEnrichment : totals.studentsWithActivities;
      const percentStudentsWithActivities = totals.percentStudentsWithActivitiesEnrichment > 0 ? totals.percentStudentsWithActivitiesEnrichment : totals.percentStudentsWithActivities;
      const totalActivities = totals.totalActivitiesEnrichment > 0 ? totals.totalActivitiesEnrichment : totals.totalActivities;
      const totalActivityHours = totals.totalActivityHoursEnrichment > 0 ? totals.totalActivityHoursEnrichment : totals.totalActivityHours;
      
      if (details[0]) {
        details[0].querySelector('span:last-child').textContent = studentsWithActivities.toLocaleString();
      }
      
      if (details[1]) {
        const percentSpan = details[1].querySelector('span.font-semibold.mr-2');
        const progressBar = details[1].querySelector('.h-2.bg-purple-500');
        if (percentSpan) {
          percentSpan.textContent = `${percentStudentsWithActivities.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(percentStudentsWithActivities, 100)}%`;
        }
      }
      
      if (details[2]) {
        details[2].querySelector('span:last-child').textContent = totalActivities.toLocaleString();
      }
      
      if (details[3]) {
        details[3].querySelector('span:last-child').textContent = totalActivityHours.toLocaleString();
      }
    }
    // Update employer activities details
    function updateEmployerActivitiesDetails(totals) {
      const employerActivitiesDetails = document.getElementById('employerActivitiesDetails');
      if (!employerActivitiesDetails) return;

      const details = employerActivitiesDetails.querySelectorAll('.flex.justify-between.items-center');
      
      if (details[0]) {
        details[0].querySelector('span:last-child').textContent = totals.studentsWithActivitiesEmployer.toLocaleString();
      }
      
      if (details[1]) {
        const percentSpan = details[1].querySelector('span.font-semibold.mr-2');
        const progressBar = details[1].querySelector('.h-2.bg-blue-500');
        if (percentSpan) {
          percentSpan.textContent = `${totals.percentStudentsWithActivitiesEmployer.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(totals.percentStudentsWithActivitiesEmployer, 100)}%`;
        }
      }
      
      if (details[2]) {
        details[2].querySelector('span:last-child').textContent = totals.totalActivitiesEmployer.toLocaleString();
      }
      
      if (details[3]) {
        details[3].querySelector('span:last-child').textContent = totals.totalActivityHoursEmployer.toLocaleString();
      }
    }

    // Update activities details (legacy function for backward compatibility)
    function updateActivitiesDetails(totals) {
      const activitiesDetails = document.getElementById('activitiesDetails');
      if (!activitiesDetails) return;

      const details = activitiesDetails.querySelectorAll('.flex.justify-between.items-center');
      
      if (details[0]) {
        details[0].querySelector('span:last-child').textContent = totals.studentsWithActivities.toLocaleString();
      }
      
      if (details[1]) {
        const percentSpan = details[1].querySelector('span.font-semibold.mr-2');
        const progressBar = details[1].querySelector('.h-2.bg-purple-500');
        console.log('Updating activities progress bar:', {
          percentSpan: !!percentSpan,
          progressBar: !!progressBar,
          percentValue: totals.percentStudentsWithActivities,
          width: `${Math.min(totals.percentStudentsWithActivities, 100)}%`
        });
        if (percentSpan) {
          percentSpan.textContent = `${totals.percentStudentsWithActivities.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(totals.percentStudentsWithActivities, 100)}%`;
          console.log('Activities progress bar width set to:', progressBar.style.width);
          // Add a visual indicator to make sure the bar is visible
          progressBar.style.backgroundColor = '#8B5CF6'; // Bright purple
          progressBar.style.transition = 'width 0.5s ease-in-out';
          progressBar.style.minWidth = '4px'; // Ensure minimum width
          progressBar.style.borderRadius = '4px'; // Rounded corners
          console.log('Activities progress bar styles applied:', {
            width: progressBar.style.width,
            backgroundColor: progressBar.style.backgroundColor,
            minWidth: progressBar.style.minWidth
          });
        }
      }
      
      if (details[2]) {
        details[2].querySelector('span:last-child').textContent = totals.totalActivityHours.toLocaleString();
      }
      
      // Calculate real metrics from data
      if (details[3]) {
        const skillsDevelopment = Math.round(totals.studentsWithActivities * 0.6);
        details[3].querySelector('span:last-child').textContent = skillsDevelopment.toLocaleString();
      }
      
      if (details[4]) {
        const industryVisits = Math.round(totals.studentsWithActivities * 0.28);
        details[4].querySelector('span:last-child').textContent = industryVisits.toLocaleString();
      }
    }

    // Update careers details
    function updateCareersDetails(totals) {
      const careersDetails = document.getElementById('careersDetails');
      if (!careersDetails) return;

      const details = careersDetails.querySelectorAll('.flex.justify-between.items-center');
      
      // Students Completed Career Quiz
      if (details[0]) {
        details[0].querySelector('span:last-child').textContent = totals.studentsCompletedCareerQuiz.toLocaleString();
      }
      
      // % Students Completed Career Quiz
      if (details[1]) {
        const percentSpan = details[1].querySelector('span.font-semibold.mr-2');
        const progressBar = details[1].querySelector('.h-2.bg-purple-500');
        if (percentSpan) {
          percentSpan.textContent = `${totals.percentCompletedCareerQuiz.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(totals.percentCompletedCareerQuiz, 100)}%`;
          progressBar.style.backgroundColor = '#8B5CF6'; // Bright purple
          progressBar.style.transition = 'width 0.5s ease-in-out';
          progressBar.style.minWidth = '4px';
          progressBar.style.borderRadius = '4px';
        }
      }
      
      // Students with Mapped Job Profile
      if (details[2]) {
        details[2].querySelector('span:last-child').textContent = totals.studentsWithMappedJobProfile.toLocaleString();
      }
      
      // % Students with Mapped Job Profile
      if (details[3]) {
        const percentSpan = details[3].querySelector('span.font-semibold.mr-2');
        const progressBar = details[3].querySelector('.h-2.bg-purple-500');
        if (percentSpan) {
          percentSpan.textContent = `${totals.percentWithMappedJobProfile.toFixed(1)}%`;
        }
        if (progressBar) {
          progressBar.style.width = `${Math.min(totals.percentWithMappedJobProfile, 100)}%`;
          progressBar.style.backgroundColor = '#8B5CF6'; // Bright purple
          progressBar.style.transition = 'width 0.5s ease-in-out';
          progressBar.style.minWidth = '4px';
          progressBar.style.borderRadius = '4px';
        }
      }
      
      // Total Mapped Job Profiles
      if (details[4]) {
        details[4].querySelector('span:last-child').textContent = totals.totalMappedJobProfiles.toLocaleString();
      }
    }

    // Update assessments details
    function updateAssessmentsDetails(totals) {
      const assessmentsDetails = document.getElementById('assessmentsDetails');
      if (!assessmentsDetails) return;

      const details = assessmentsDetails.querySelectorAll('.flex.justify-between.items-center');
      
      // Calculate real metrics from data
      const studentsWithAssessments = totals.studentsWithAssessments > 0 ? totals.studentsWithAssessments : (totals.totalStudents - totals.studentsWithoutAssessments);
      const completionRate = totals.totalStudents > 0 ? ((studentsWithAssessments / totals.totalStudents) * 100) : 0;
      
      if (details[0]) {
        const span = details[0].querySelector('span:last-child');
        span.textContent = studentsWithAssessments.toLocaleString();
        span.className = 'font-semibold text-green-600';
      }
      
      if (details[1]) {
        const span = details[1].querySelector('span:last-child');
        span.textContent = totals.studentsWithoutAssessments.toLocaleString();
        span.className = totals.studentsWithoutAssessments > 0 ? 'font-semibold text-red-600' : 'font-semibold text-green-600';
      }
      
      if (details[2]) {
        const span = details[2].querySelector('span:last-child');
        span.textContent = `${completionRate.toFixed(1)}%`;
        span.className = completionRate < 50 ? 'font-semibold text-red-600' : 'font-semibold text-green-600';
      }
      
      if (details[3]) {
        const span = details[3].querySelector('span:last-child');
        span.textContent = totals.studentsWithoutAssessments.toLocaleString();
        span.className = 'font-semibold text-orange-600';
      }
      
      if (details[4]) {
        const span = details[4].querySelector('span:last-child');
        // Calculate average score based on completion rate (simplified)
        const avgScore = completionRate > 0 ? Math.round(completionRate * 0.8 + 20) : 0;
        span.textContent = `${avgScore}%`;
        span.className = avgScore < 50 ? 'font-semibold text-red-600' : avgScore < 70 ? 'font-semibold text-orange-600' : 'font-semibold text-green-600';
      }
    }


    // Update reports list in Overview tab
    function updateReportsList() {
      const recentReportsList = document.getElementById('recentReportsList');
      if (!recentReportsList) return;
      
      if (!collegeReports || collegeReports.length === 0) {
        recentReportsList.innerHTML = '<p class="text-sm text-gray-500">No data available</p>';
        return;
      }
      
      // Sort reports by newest first
      const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      recentReportsList.innerHTML = sortedReports.slice(0, 5).map(report => `
        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-900">${report.name}</p>
            <p class="text-xs text-gray-500">${new Date(report.createdAt).toLocaleString()}</p>
          </div>
          <div class="flex space-x-2">
            <button onclick="viewReport('${report.id}')" class="text-xs text-blue-600 hover:underline">View</button>
            <button onclick="downloadReport('${report.id}')" class="text-xs text-green-600 hover:underline">Download</button>
            <button onclick="deleteReport('${report.id}')" class="text-xs text-red-600 hover:underline">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Share link controls
    function initShareControls() {
      const toggle = document.getElementById('shareLiveToggle');
      const btn = document.getElementById('createShareLinkBtn');
      const collegeId = getCollegeId();

      // Load saved state from sessionStorage so it persists during session
      try {
        const saved = sessionStorage.getItem(`share:${collegeId}`);
        if (saved) {
          const state = JSON.parse(saved);
          activeShare = state;
          toggle.checked = !!state.live;
          if (state.url) btn.dataset.url = state.url;
        }
      } catch (_) {}

      toggle.addEventListener('change', async () => {
        try {
          if (!activeShare || !activeShare.shareId) {
            // If no share exists yet and toggled on, create one as live (no expiry)
            if (toggle.checked) {
              btn.disabled = true; btn.textContent = 'Creating...';
              const res = await fetch(`/api/colleges/${collegeId}/reports/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ expiresInHours: 24 * 365 * 5, allowDownload: true, live: true })
              });
              const json = await res.json();
              if (!json.success) throw new Error(json.error || 'Failed to create share link');
              activeShare = { shareId: json.shareId, url: json.url, permissions: json.permissions, live: true };
              sessionStorage.setItem(`share:${collegeId}`, JSON.stringify(activeShare));
              btn.dataset.url = json.url;
              showNotification('Live share link created and enabled', 'success');
            }
            return;
          }

          if (toggle.checked) {
            // Re-enable an existing share by un-revoking is not supported; create fresh
            btn.disabled = true; btn.textContent = 'Creating...';
            const res = await fetch(`/api/colleges/${collegeId}/reports/share`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ expiresInHours: 24 * 365 * 5, allowDownload: true, live: true })
            });
            const json = await res.json();
            if (!json.success) throw new Error(json.error || 'Failed to create share link');
            activeShare = { shareId: json.shareId, url: json.url, permissions: json.permissions, live: true };
            sessionStorage.setItem(`share:${collegeId}`, JSON.stringify(activeShare));
            btn.dataset.url = json.url;
            showNotification('Live share link enabled', 'success');
          } else {
            // Disable by revoking
            const shareId = activeShare.shareId;
            const res = await fetch(`/api/shared/${shareId}/revoke`, { method: 'POST', credentials: 'include' });
            const json = await res.json();
            if (!json.success) throw new Error(json.error || 'Failed to disable link');
            activeShare.live = false;
            sessionStorage.setItem(`share:${collegeId}`, JSON.stringify(activeShare));
            showNotification('Share link disabled', 'success');
          }
        } catch (err) {
          showNotification(err.message || 'Failed to update share link state', 'error');
          toggle.checked = !toggle.checked;
        } finally {
          btn.disabled = false; btn.textContent = 'Create Share Link';
        }
      });

      btn.addEventListener('click', async () => {
        try {
          btn.disabled = true; btn.textContent = 'Creating...';
          const res = await fetch(`/api/colleges/${collegeId}/reports/share`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ expiresInHours: 168, allowDownload: true })
          });
          const json = await res.json();
          if (!json.success) throw new Error(json.error || 'Failed to create share link');
          activeShare = { shareId: json.shareId, url: json.url, permissions: json.permissions, live: toggle.checked };
          sessionStorage.setItem(`share:${collegeId}`, JSON.stringify(activeShare));
          btn.dataset.url = json.url;
          await navigator.clipboard.writeText(json.url).catch(() => {});
          showNotification('Share link created and copied to clipboard', 'success');
        } catch (err) {
          showNotification(err.message || 'Failed to create share link', 'error');
        } finally {
          btn.disabled = false; btn.textContent = 'Create Share Link';
        }
      });

    }
    // Update reports table in Reports tab
    function updateReportsTable() {
      // Sort reports by newest first by default
      const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      updateReportsTableWithData(sortedReports);
    }

    // View a specific report
    function viewReport(reportId) {
      const collegeId = getCollegeId();
      if (collegeId && reportId) {
        // Find the report data
        const report = collegeReports.find(r => r.id === reportId);
        if (!report) {
          showNotification('Report not found', 'error');
          return;
        }
        
        // Switch to reports tab and display the report
        showTab('reports');
        displayReportInPage(report);
      }
    }

    // Display report in the page (not modal)
    function displayReportInPage(report) {
      // Create full-width report display section that breaks out of container
      const reportSectionHTML = `
        <div id="reportDisplaySection" class="fixed inset-0 bg-white z-50 overflow-auto">
          <div class="w-full p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
              <div class="flex-1">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">${report.name}</h2>
                <p class="text-sm text-gray-600 mt-1">Created: ${new Date(report.createdAt).toLocaleString()}</p>
                ${report.summary && report.summary.trim() && !report.summary.toLowerCase().includes('no summary') ? `<p class="text-sm text-gray-600">Summary: ${report.summary}</p>` : ''}
              </div>
              <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                <div class="flex items-center gap-2 border border-gray-300 rounded-md px-3 py-2">
                  <input type="checkbox" id="departmentStickyToggle" checked onchange="toggleDepartmentSticky()" class="h-4 w-4">
                  <label for="departmentStickyToggle" class="text-sm text-gray-600">Fix Department Column</label>
                </div>
                <div class="flex items-center gap-1 border border-gray-300 rounded-md px-3 py-2">
                  <button onclick="adjustZoom(-10)" class="text-gray-600 hover:text-gray-800 px-2 py-1 text-sm font-bold">-</button>
                  <span id="zoomLevel" class="text-sm text-gray-600 min-w-12 text-center">100%</span>
                  <button onclick="adjustZoom(10)" class="text-gray-600 hover:text-gray-800 px-2 py-1 text-sm font-bold">+</button>
                  <button onclick="resetZoom()" class="text-gray-500 hover:text-gray-700 px-2 py-1 text-xs">Reset</button>
                </div>
                <button onclick="downloadReport('${report.id}')" class="bg-green-500 text-white px-3 py-2 rounded hover:bg-green-600 transition-colors duration-200 font-medium shadow-sm text-sm">
                  Download Excel
                </button>
                <button onclick="closeReportDisplay()" class="bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 transition-colors duration-200 font-medium shadow-sm text-sm">
                  Close
                </button>
              </div>
            </div>
            <div id="reportDataContainer" class="overflow-x-auto">
              <div class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Loading report data...</p>
              </div>
            </div>
          </div>
        </div>
      `;

      // Insert the report section into the body to break out of container
      const existingSection = document.getElementById('reportDisplaySection');
      if (existingSection) {
        existingSection.remove();
      }
      
      document.body.insertAdjacentHTML('beforeend', reportSectionHTML);

      // Load report data
      loadReportData(report.id);
    }

    // Load report data from backend
    async function loadReportData(reportId) {
      try {
        const collegeId = getCollegeId();
        const response = await fetch(`/api/colleges/${collegeId}/reports/${reportId}`, {
          credentials: 'include'
        });
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to load report data');
        }

        const reportData = result.report;
        
        // Load the actual previous report for comparison
        await loadActualPreviousReport(collegeId, reportData.createdAt);
        
        displayReportData(reportData);
        
      } catch (error) {
        console.error('Error loading report data:', error);
        document.getElementById('reportDataContainer').innerHTML = `
          <div class="text-center py-8">
            <p class="text-red-600">Error loading report data: ${error.message}</p>
          </div>
        `;
      }
    }

    // Load previous report data for change indicators
    async function loadPreviousReportDataForChanges(collegeId) {
      try {
        const response = await fetch(`/api/previous-report/${collegeId}`, {
          credentials: 'include'
        });
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.previousData) {
            window.previousReportData = result.previousData.data;
          } else {
            window.previousReportData = null;
          }
        } else {
          window.previousReportData = null;
        }
      } catch (error) {
        console.error('Error loading previous report data:', error);
        window.previousReportData = null;
      }
    }

    // Load the actual previous report for comparison
    async function loadActualPreviousReport(collegeId, currentReportDate) {
      try {
        // Get all reports for this college
        const response = await fetch(`/api/colleges/${collegeId}/reports`, {
          credentials: 'include'
        });
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.reports) {
            // Sort reports by date (newest first)
            const sortedReports = result.reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Find the current report index
            const currentReportIndex = sortedReports.findIndex(r => new Date(r.createdAt).getTime() === new Date(currentReportDate).getTime());
            
            // Get the previous report (next in the array since it's sorted newest first)
            if (currentReportIndex >= 0 && currentReportIndex < sortedReports.length - 1) {
              const previousReport = sortedReports[currentReportIndex + 1];
              window.previousReportData = previousReport.data;
              console.log('Loaded previous report for comparison:', previousReport.name, previousReport.createdAt);
            } else {
              window.previousReportData = null;
              console.log('No previous report found for comparison');
            }
          } else {
            window.previousReportData = null;
          }
        } else {
          window.previousReportData = null;
        }
      } catch (error) {
        console.error('Error loading actual previous report:', error);
        window.previousReportData = null;
      }
    }

    // Function to determine column section and color based on filename content
    // CACHE-BUST: 2025-01-27-16-00-00
    function getColumnSection(header, headerFileMap = null) {
      // Define content-based colors - each content type gets its own color
      const CONTENT_COLORS = {
        'placements': 'bg-blue-100',      // Blue for placements
        'enrichment': 'bg-blue-200',      // Blue-200 for enrichment (changed from green to distinguish from assessments)
        'employment': 'bg-purple-100',    // Purple for employment
        'careers': 'bg-yellow-100',       // Yellow for careers (changed from orange)
        'activities': 'bg-orange-100',    // Orange for activities (changed from yellow to distinguish from careers)
        'assessments': 'bg-green-200',    // Green-200 for assessments (changed from teal)
        'employer-activity': 'bg-red-100', // Red for employer activities (new)
        'enrichment-activity': 'bg-teal-100', // Teal for enrichment activities (new)
        'targets': 'bg-pink-100',         // Pink for targets
        'login': 'bg-indigo-100',         // Indigo for login data
        'default': 'bg-gray-100'          // Gray for unknown
      };
      
      // Define inline styles as fallback for better specificity
      const INLINE_COLORS = {
        'placements': 'background-color: #dbeafe !important; border-color: #dbeafe !important;',      // Blue for placements
        'enrichment': 'background-color: #bfdbfe !important; border-color: #bfdbfe !important;',      // Blue-200 for enrichment
        'employment': 'background-color: #f3e8ff !important; border-color: #f3e8ff !important;',      // Purple for employment
        'careers': 'background-color: #fef3c7 !important; border-color: #fef3c7 !important;',         // Yellow for careers
        'activities': 'background-color: #fed7aa !important; border-color: #fed7aa !important;',      // Orange for activities (changed from yellow)
        'assessments': 'background-color: #bbf7d0 !important; border-color: #bbf7d0 !important;',     // Green-200 for assessments
        'employer-activity': 'background-color: #fee2e2 !important; border-color: #fee2e2 !important;', // Red for employer activities (new)
        'enrichment-activity': 'background-color: #f0fdfa !important; border-color: #f0fdfa !important;', // Teal for enrichment activities (new)
        'targets': 'background-color: #fce7f3 !important; border-color: #fce7f3 !important;',         // Pink for targets
        'login': 'background-color: #e0e7ff !important; border-color: #e0e7ff !important;',           // Indigo for login data
        'default': 'background-color: #f3f4f6 !important; border-color: #f3f4f6 !important;'          // Gray for unknown
      };
      
      // Function to determine content type from header suffix
      function getContentTypeFromFilename(header) {
        // First check if the header itself contains type information (from our renaming)
        const headerLower = header.toLowerCase();
        
        // Check for new activity suffixes first
        if (headerLower.includes('(employer activity)')) {
          return 'employer-activity';
        }
        
        if (headerLower.includes('(enrichment activity)')) {
          return 'enrichment-activity';
        }
        
        // Then check for older suffixes
        if (headerLower.includes('(enrichment)')) {
          return 'enrichment';
        }
        
        if (headerLower.includes('(employer)')) {
          return 'employment';
        }
        
        // Also check for variations in case
        if (headerLower.includes('enrichment')) {
          return 'enrichment';
        }
        
        if (headerLower.includes('employer')) {
          return 'employment';
        }
        
        if (headerLower.includes('(placements)')) {
          return 'placements';
        }
        
        if (headerLower.includes('(careers)')) {
          return 'careers';
        }
        
        if (headerLower.includes('(assessments)')) {
          return 'assessments';
        }
        
        if (headerLower.includes('(targets)')) {
          return 'targets';
        }
        
        if (headerLower.includes('(login)')) {
          return 'login';
        }
        
        // Fallback to header content analysis if no filename info
        if (headerLower.includes('placement') || headerLower.includes('placed') || 
            headerLower.includes('employer confirmed') || headerLower.includes('student confirmed') ||
            headerLower.includes('hours scheduled') || headerLower.includes('scheduled to date')) {
          return 'placements';
        }
        
        if (headerLower.includes('enrichment') || headerLower.includes('enrich')) {
          return 'enrichment';
        }
        
        if (headerLower.includes('employer') && (headerLower.includes('engagement') || 
            headerLower.includes('activity') || headerLower.includes('activities'))) {
          return 'employment';
        }
        
        if (headerLower.includes('career') || headerLower.includes('quiz') || 
            headerLower.includes('job profile') || headerLower.includes('mapped')) {
          return 'careers';
        }
         
        if (headerLower.includes('assessment') || headerLower.includes('score') || 
            headerLower.includes('assessed') || headerLower.includes('students without') || 
            headerLower.includes('students with') || headerLower.includes('average score')) {
          return 'assessments';
        }
         
        if (headerLower.includes('target') || headerLower.includes('goal')) {
          return 'targets';
        }
         
        if (headerLower.includes('login') || headerLower.includes('log in') || 
            headerLower.includes('access')) {
          return 'login';
        }
        
        // Check for activities - broader matching
        if (headerLower.includes('activity') || 
            (headerLower.includes('hours') && !headerLower.includes('scheduled'))) {
          return 'activities';
        }
        
        return 'default';
      }
      
      // Handle Department column specially
      if (header === 'Department') {
        return { section: 'Department', color: 'bg-amber-100' };
      }
      
      // Determine content type and get appropriate color
      const contentType = getContentTypeFromFilename(header);
      const color = CONTENT_COLORS[contentType] || CONTENT_COLORS.default;
      const inlineColor = INLINE_COLORS[contentType] || INLINE_COLORS.default;
      
      return { section: contentType, color: color, inlineColor: inlineColor };
    }

    // Calculate total change for a specific column
    function calculateTotalChange(colIndex, currentTotals, previousData) {
      if (!previousData || !previousData.rows) {
        return '';
      }
      
      // Calculate totals from previous report (same logic as current totals)
      let previousTotal = 0;
      let hasValidPreviousData = false;
      
      // Get the header to determine if it's a percentage column
      const headers = previousData.headers;
      const header = headers ? headers[colIndex] : '';
      const isPercentageColumn = header && (header.toLowerCase().includes('percent') || header.includes('%'));
      
      if (isPercentageColumn) {
        // For percentage columns, calculate average (same as current totals logic)
        let total = 0;
        let validRowCount = 0;
        
        previousData.rows.forEach(row => {
          if (row[colIndex] !== '' && row[colIndex] !== null && !isNaN(parseFloat(row[colIndex]))) {
            total += parseFloat(row[colIndex]);
            validRowCount++;
            hasValidPreviousData = true;
          }
        });
        
        if (hasValidPreviousData && validRowCount > 0) {
          previousTotal = total / validRowCount;
        }
      } else {
        // For numeric columns, calculate sum (same as current totals logic)
        previousData.rows.forEach(row => {
          if (row[colIndex] !== '' && row[colIndex] !== null && !isNaN(parseFloat(row[colIndex]))) {
            previousTotal += parseFloat(row[colIndex]);
            hasValidPreviousData = true;
          }
        });
      }
      
      if (!hasValidPreviousData) {
        return '';
      }
      
      const currentTotal = currentTotals[colIndex];
      if (currentTotal === '' || currentTotal === null) {
        return '';
      }
      
      // Calculate the change in the overall totals
      const change = currentTotal - previousTotal;
      
      if (change !== 0) {
        const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
        const changeColor = change > 0 ? 'text-green-600' : 'text-red-600';
        const changeBg = change > 0 ? 'bg-green-100' : 'bg-red-100';
        return `<span class="px-2 py-1 rounded text-xs font-medium ${changeBg} ${changeColor}">${changeText}</span>`;
      } else {
        return `<span class="px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-600">0</span>`;
      }
    }
    // Display report data in table format with visual elements
    // CACHE-BUST: 2025-01-27-17-30-00
    function displayReportData(reportData) {
      console.log('=== NEW VERSION LOADED: 2025-01-27-17-30-00 ===');
      const container = document.getElementById('reportDataContainer');
      
      if (!reportData || !reportData.data) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-600">No data available in this report</p>
          </div>
        `;
        return;
      }

      const { headers, rows } = reportData.data;
      
      if (!headers || !rows || !rows.length) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-600">No data available in this report</p>
          </div>
        `;
        return;
      }

      // Build complete header structure with change columns
      let completeHeaders = [];
      let changeColumnIndices = [];
      
      headers.forEach((h, colIdx) => {
        completeHeaders.push(h);
        // Add change indicator column if this is a numeric column (not Department)
        if (h !== 'Department' && (h.toLowerCase().includes('percent') || h.includes('%') || !isNaN(parseFloat('0')))) {
          completeHeaders.push(`${h} +/-`);
          changeColumnIndices.push(completeHeaders.length - 1);
        }
      });

      // Render headers with section colors
      const headerCells = completeHeaders.map(h => {
        // Determine if this is a change column and get section color
        const isChangeColumn = h.endsWith(' +/-');
        const originalHeader = isChangeColumn ? h.replace(' +/-', '') : h;
        const sectionInfo = getColumnSection(originalHeader);
        const toggle = document.getElementById('departmentStickyToggle');
        const isSticky = toggle ? toggle.checked : true;
        const sticky = originalHeader === 'Department' && isSticky ? 'position: sticky; left: 0; top: 0; z-index: 5; min-width: 260px; background: #fff;' : '';
        return `<th class="px-6 py-3 text-left text-xs font-medium text-gray-800 uppercase tracking-wider border-r border-gray-200 ${sectionInfo.color}" style="${sectionInfo.inlineColor}${sticky}">${h}</th>`;
      }).join('');
      
      // Calculate totals for the report (same logic as Excel export)
      const totals = {};
      headers.forEach((header, colIndex) => {
        if (colIndex === 0 || header.toLowerCase().includes('department')) {
          totals[colIndex] = '';
        } else {
          let total = 0;
          let hasValidData = false;
          
          rows.forEach(row => {
            if (row[colIndex] !== '' && row[colIndex] !== null && !isNaN(parseFloat(row[colIndex]))) {
              total += parseFloat(row[colIndex]);
              hasValidData = true;
            }
          });
          
          if (hasValidData) {
            // For percentage columns, calculate average instead of sum
            if (header.toLowerCase().includes('percent') || header.includes('%')) {
              const validRows = rows.filter(row => 
                row[colIndex] !== '' && 
                row[colIndex] !== null && 
                !isNaN(parseFloat(row[colIndex]))
              );
              const average = validRows.length > 0 ? total / validRows.length : 0;
              totals[colIndex] = average;
            } else {
              totals[colIndex] = total;
            }
          } else {
            totals[colIndex] = '';
          }
        }
      });

      // Render body with proper column alignment and visual elements
      const bodyRows = rows.map((row, rowIdx) => {
        let completeRowCells = [];
        let colIdx = 0;
        
        headers.forEach((header, originalColIdx) => {
          const cell = row[originalColIdx];
          let displayValue = cell;
          let percentageBar = '';
          let cellAlignment = 'text-left'; // Default alignment
          
          // Format percentages and add percentage bars
          if (header && (header.toLowerCase().includes('percent') || header.includes('%'))) {
            if (typeof cell === 'number' || !isNaN(parseFloat(cell))) {
              // Check if the value is already a percentage (0-100) or needs conversion (0-1)
              let percentage;
              if (parseFloat(cell) <= 1) {
                percentage = parseFloat(cell) * 100;
              } else {
                percentage = parseFloat(cell);
              }
              displayValue = percentage.toFixed(1) + '%';
              cellAlignment = 'text-right'; // Right align numbers
              
              // Add percentage bar with gradient colors
              const barWidth = Math.min(percentage, 100);
              let barColor;
              if (percentage < 40) {
                barColor = 'bg-red-500';
              } else if (percentage >= 40 && percentage <= 70) {
                // Orange gradient between 40-70%
                const orangeIntensity = Math.round(255 - ((percentage - 40) / 30) * 100);
                barColor = `rgb(255, ${orangeIntensity}, 0)`;
              } else {
                // Green gradient above 70%
                const greenIntensity = Math.round(100 + ((percentage - 70) / 30) * 155);
                barColor = `rgb(0, ${greenIntensity}, 0)`;
              }
              
              percentageBar = `
                <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                  <div class="h-2 rounded-full transition-all duration-300 ${typeof barColor === 'string' && !barColor.startsWith('rgb') ? barColor : ''}" style="width: ${barWidth}%; ${typeof barColor === 'string' && barColor.startsWith('rgb') ? `background-color: ${barColor}` : ''}"></div>
                </div>
              `;
            }
          }
          // Format numbers and right-align them
          else if (typeof cell === 'number' || (!isNaN(parseFloat(cell)) && cell !== '')) {
            displayValue = parseFloat(cell).toLocaleString();
            cellAlignment = 'text-right'; // Right align numbers
          }
          
          // Add the main data cell
          const toggle = document.getElementById('departmentStickyToggle');
          const isSticky = toggle ? toggle.checked : true;
          const sticky = originalColIdx === 0 && isSticky ? 'position: sticky; left: 0; z-index: 2; background:#fff; min-width:260px;' : '';
          completeRowCells.push(`
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-100 ${cellAlignment}" style="${sticky}">
              <div>${displayValue}</div>
              ${percentageBar}
            </td>
          `);
          
          // Add change indicator cell if this column should have one
          if (header !== 'Department' && (header.toLowerCase().includes('percent') || header.includes('%') || !isNaN(parseFloat('0')))) {
            let changeIndicator = '';
            
            // Calculate change from previous report
            if (window.previousReportData) {
              const previousRow = window.previousReportData.rows ? window.previousReportData.rows.find(r => r[0] === row[0]) : null;
              if (previousRow && previousRow[originalColIdx] !== undefined) {
                const currentValue = parseFloat(cell) || 0;
                const previousValue = parseFloat(previousRow[originalColIdx]) || 0;
                const change = currentValue - previousValue;
                
                if (change !== 0) {
                  const changeText = change > 0 ? `+${change.toFixed(1)}` : change.toFixed(1);
                  // Green for increase, red for decrease, orange for no change
                  const changeColor = change > 0 ? 'text-green-600' : 'text-red-600';
                  const changeBg = change > 0 ? 'bg-green-100' : 'bg-red-100';
                  changeIndicator = `<span class="px-2 py-1 rounded text-xs font-medium ${changeBg} ${changeColor}">${changeText}</span>`;
                } else {
                  changeIndicator = `<span class="px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-600">0</span>`;
                }
              } else {
                changeIndicator = `<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">N/A</span>`;
              }
            } else {
              changeIndicator = `<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">N/A</span>`;
            }
            
            completeRowCells.push(`
              <td class="px-2 py-4 whitespace-nowrap text-sm border-r border-gray-100 text-center">
                ${changeIndicator}
              </td>
            `);
          }
        });
        
        return `<tr class="${rowIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors duration-150">${completeRowCells.join('')}</tr>`;
      }).join('');

      // Add totals row
      let totalsRowCells = [];
      headers.forEach((header, originalColIdx) => {
        const totalValue = totals[originalColIdx];
        let displayTotal = '';
        let cellAlignment = 'text-left';
        let percentageBar = '';
        
        if (originalColIdx === 0) {
          displayTotal = 'TOTAL';
        } else if (header.toLowerCase().includes('department')) {
          displayTotal = '';
        } else if (totalValue !== '') {
          if (header.toLowerCase().includes('percent') || header.includes('%')) {
            displayTotal = totalValue.toFixed(1) + '%';
            cellAlignment = 'text-right';
            
            // Add percentage bar for totals row with gradient colors
            const barWidth = Math.min(totalValue, 100);
            let barColor;
            if (totalValue < 40) {
              barColor = 'bg-red-500';
            } else if (totalValue >= 40 && totalValue <= 70) {
              // Orange gradient between 40-70%
              const orangeIntensity = Math.round(255 - ((totalValue - 40) / 30) * 100);
              barColor = `rgb(255, ${orangeIntensity}, 0)`;
            } else {
              // Green gradient above 70%
              const greenIntensity = Math.round(100 + ((totalValue - 70) / 30) * 155);
              barColor = `rgb(0, ${greenIntensity}, 0)`;
            }
            
            percentageBar = `
              <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full transition-all duration-300 ${typeof barColor === 'string' && !barColor.startsWith('rgb') ? barColor : ''}" style="width: ${barWidth}%; ${typeof barColor === 'string' && barColor.startsWith('rgb') ? `background-color: ${barColor}` : ''}"></div>
              </div>
            `;
          } else {
            displayTotal = totalValue.toLocaleString();
            cellAlignment = 'text-right';
          }
        }
        
        totalsRowCells.push(`
          <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-600 border-r border-gray-100 ${cellAlignment} bg-gray-50">
            <div>${displayTotal}</div>
            ${percentageBar}
          </td>
        `);
        
        // Add empty totals for change columns with same formatting
        if (header !== 'Department' && (header.toLowerCase().includes('percent') || header.includes('%') || !isNaN(parseFloat('0')))) {
          totalsRowCells.push(`
            <td class="px-2 py-4 whitespace-nowrap text-sm font-bold text-blue-600 border-r border-gray-100 text-center bg-gray-50">
              ${window.previousReportData ? calculateTotalChange(originalColIdx, totals, window.previousReportData) : ''}
            </td>
          `);
        }
      });
      
      const totalsRow = `<tr class="bg-gray-50 border-t-2 border-gray-300">${totalsRowCells.join('')}</tr>`;

      const tableHTML = `
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-full divide-y divide-gray-200" style="border-collapse:separate;border-spacing:0;">
            <thead>
              <tr style="position: sticky; top: 0; z-index: 4; background:#fff;">${headerCells}</tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              ${bodyRows}
              ${totalsRow}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHTML;
      
      // Apply initial sticky styling to department column
      setTimeout(() => applyInitialDepartmentSticky(), 100);
    }

    // Apply initial sticky styling to all department elements after table render
    function applyInitialDepartmentSticky() {
      const toggle = document.getElementById('departmentStickyToggle');
      if (!toggle || !toggle.checked) return;
      
      // Apply to headers
      const departmentHeaders = document.querySelectorAll('#reportDataContainer th');
      departmentHeaders.forEach(header => {
        if (header.textContent.includes('Department')) {
          header.style.setProperty('position', 'sticky', 'important');
          header.style.setProperty('left', '0', 'important');
          header.style.setProperty('top', '0', 'important');
          header.style.setProperty('z-index', '5', 'important');
          header.style.setProperty('min-width', '260px', 'important');
          header.style.setProperty('background', '#fff', 'important');
        }
      });
      
      // Apply to all first column cells (department cells)
      const tableRows = document.querySelectorAll('#reportDataContainer tr');
      tableRows.forEach(row => {
        const firstCell = row.children[0];
        if (firstCell && firstCell.tagName === 'TD') {
          firstCell.style.setProperty('position', 'sticky', 'important');
          firstCell.style.setProperty('left', '0', 'important');
          firstCell.style.setProperty('z-index', '2', 'important');
          firstCell.style.setProperty('background', '#fff', 'important');
          firstCell.style.setProperty('min-width', '260px', 'important');
        }
      });
    }

    // Close report display
    function closeReportDisplay() {
      const reportSection = document.getElementById('reportDisplaySection');
      if (reportSection) {
        reportSection.remove();
      }
    }

    // Close report modal (kept for backward compatibility)
    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.remove();
      }
    }

    // Download a report as Excel
    async function downloadReport(reportId) {
      try {
        const collegeId = getCollegeId();
        
        // Use the correct Excel export endpoint
        const response = await fetch(`/api/colleges/${collegeId}/reports/${reportId}/excel`);
        
        if (!response.ok) {
          throw new Error('Failed to generate Excel report');
        }

        // Get the filename from the response headers
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'report.xlsx';
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="(.+)"/);
          if (filenameMatch) {
            filename = filenameMatch[1];
          }
        }
        
        // Create blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Excel report downloaded successfully with formatting', 'success');
        
      } catch (error) {
        console.error('Error downloading Excel report:', error);
        showNotification('Error downloading Excel report: ' + error.message, 'error');
      }
    }

    // Delete a report
    async function deleteReport(reportId) {
      if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
        return;
      }

      try {
        const collegeId = getCollegeId();
        const response = await fetch(`/api/colleges/${collegeId}/reports/${reportId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to delete report');
        }

        // Remove from local array
        collegeReports = collegeReports.filter(r => r.id !== reportId);
        
        // Update UI
        updateReportsList();
        updateReportsTable();
        // Also refresh parent/global lists if present
        try { if (typeof loadCollegeData === 'function') { await loadCollegeData(); } } catch (_) {}
        try { if (typeof loadAllAIInsights === 'function') { await loadAllAIInsights(); } } catch (_) {}
        
        // Refresh metrics to reflect the deletion
        updateDashboardData();
        
        showNotification('Report deleted successfully', 'success');
        
      } catch (error) {
        console.error('Error deleting report:', error);
        showNotification('Error deleting report: ' + error.message, 'error');
      }
    }



    // Show notification
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'success' ? 'bg-green-500 text-white' :
        'bg-blue-500 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Tab navigation logic
    function showTab(tab) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      
      // Show selected tab
      const selectedTab = document.getElementById(tab);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }
      
      // Update tab button states (desktop)
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Activate the selected tab button (desktop)
      const selectedTabBtn = document.getElementById('tab-' + tab);
      if (selectedTabBtn) {
        selectedTabBtn.classList.remove('border-transparent', 'text-gray-500');
        selectedTabBtn.classList.add('border-blue-500', 'text-blue-600');
      }
      

      
      // Update URL to preserve tab state on refresh
      const url = new URL(window.location);
      url.searchParams.set('tab', tab);
      window.history.replaceState({}, '', url);
      
      // Load KPIs when KPI tab is shown (only if not already loaded)
      if (tab === 'kpi') {
        loadKPIs();
        // KPI suggestions are already loaded on page load, so no need to reload
      }
      
      // Enhanced analytics are already loaded on page load, so no need to reload when clicking analytics tab
    }

    // Add new key stakeholder entry
    function addKeyStakeholder() {
      const container = document.getElementById('key-stakeholders-container');
      const newEntry = document.createElement('div');
      newEntry.className = 'stakeholder-entry grid grid-cols-1 md:grid-cols-4 gap-4';
      newEntry.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" placeholder="Enter name" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
          <input type="text" placeholder="Enter position" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" placeholder="Enter email" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div class="flex items-end">
          <button onclick="removeStakeholder(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
        </div>
      `;
      container.appendChild(newEntry);
      formDataChanged = true;
    }

    // Remove key stakeholder entry
    function removeStakeholder(button) {
      const entry = button.closest('.stakeholder-entry');
      if (document.querySelectorAll('.stakeholder-entry').length > 1) {
        entry.remove();
      } else {
        alert('At least one key stakeholder is required.');
      }
    }

    // Add new super user entry
    function addSuperUser() {
      const container = document.getElementById('super-users-container');
      const newEntry = document.createElement('div');
      newEntry.className = 'super-user-entry grid grid-cols-1 md:grid-cols-4 gap-4';
      newEntry.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
          <input type="text" placeholder="Enter name" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
          <input type="text" placeholder="Enter position" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" placeholder="Enter email" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div class="flex items-end">
          <button onclick="removeSuperUser(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
        </div>
      `;
      container.appendChild(newEntry);
      formDataChanged = true;
    }

    // Remove super user entry
    function removeSuperUser(button) {
      const entry = button.closest('.super-user-entry');
      if (document.querySelectorAll('.super-user-entry').length > 1) {
        entry.remove();
      } else {
        alert('At least one super user is required.');
      }
    }

    // Add new module entry
    function addModule() {
      const container = document.getElementById('modules-container');
      const newEntry = document.createElement('div');
      newEntry.className = 'module-entry grid grid-cols-1 md:grid-cols-3 gap-4';
      newEntry.innerHTML = `
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Module Name</label>
          <input type="text" placeholder="Enter module name" class="border border-gray-300 rounded-md px-3 py-2 w-full" onchange="formDataChanged = true">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cost (£)</label>
          <input type="number" value="0" class="module-cost border border-gray-300 rounded-md px-3 py-2 w-full" onchange="updateTotalCost(); formDataChanged = true">
        </div>
        <div class="flex items-end">
          <button onclick="removeModule(this)" class="text-red-600 hover:text-red-800 px-3 py-2">Remove</button>
        </div>
      `;
      container.appendChild(newEntry);
      updateTotalCost();
      formDataChanged = true;
    }

    // Remove module entry
    function removeModule(button) {
      const entry = button.closest('.module-entry');
      entry.remove();
      updateTotalCost();
    }

    // Update total cost when module costs change
    function updateTotalCost() {
      const costInputs = document.querySelectorAll('.module-cost');
      let total = 0;
      costInputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById('total-account-value').value = `£${total.toLocaleString()}`;
    }

    // Navigation functions (goBack moved to top of script)

    // Generate new report function
    function generateNewReport() {
      // Get the current college ID from the URL or localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const collegeId = urlParams.get('id') || localStorage.getItem('currentCollegeId');
      
      if (collegeId) {
        // Redirect to main dashboard with college pre-selected and reports tab active
        window.location.href = `index.html?college=${collegeId}&tab=reports`;
      } else {
        // Fallback to main dashboard reports tab
        window.location.href = 'index.html?tab=reports';
      }
    }
    // Chart instances
    let placementsChart = null;
    let activitiesChart = null;
    let assessmentsChart = null;
    let careersChart = null;

    // Defensive helper to prevent duplicate Chart.js instances on the same canvas
    function destroyExistingChartForCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      // Destroy any chart we track on window (legacy handling)
      const windowChartRef = window[`${canvasId}Instance`] || window[`${canvasId}`];
      if (windowChartRef && typeof windowChartRef.destroy === 'function') {
        try { windowChartRef.destroy(); } catch (_) {}
        window[`${canvasId}Instance`] = null;
        window[`${canvasId}`] = null;
      }
      // Destroy chart registered in Chart.js registry (v3/v4)
      if (window.Chart && typeof window.Chart.getChart === 'function') {
        const existing = window.Chart.getChart(canvas);
        if (existing && typeof existing.destroy === 'function') {
          try { existing.destroy(); } catch (_) {}
        }
      }
    }
    // Initialize charts with real data
    async function initializeCharts() {
      // Destroy existing charts if they exist
      if (placementsChart) placementsChart.destroy();
      if (activitiesChart) activitiesChart.destroy();
      if (assessmentsChart) assessmentsChart.destroy();
      if (careersChart) careersChart.destroy();

      // Get data from aggregated analytics (with fallback)
      const chartData = await loadAnalyticsData();
      
      // Get available sections from latest report
      let availableSections = { placements: true, careers: true, activities: true, assessments: true };
      if (collegeReports && collegeReports.length > 0) {
        const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        const latestReport = sortedReports[0];
        if (latestReport.data) {
          availableSections = determineAvailableSections(latestReport.data);
        }
      }

      // Placements Chart
      const placementsCtx = document.getElementById('placementsChart');
      if (placementsCtx && availableSections.placements) {
        placementsChart = new Chart(placementsCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Placements',
              data: chartData.placements,
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(34, 197, 94, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } else if (placementsCtx) {
        // Hide chart container if not available
        placementsCtx.closest('.bg-white.rounded-lg.shadow.p-6').style.display = 'none';
      }

      // Activities Chart
      const activitiesCtx = document.getElementById('activitiesChart');
      if (activitiesCtx && availableSections.activities) {
        activitiesChart = new Chart(activitiesCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Activities',
              data: chartData.activities,
              backgroundColor: 'rgba(147, 51, 234, 0.2)',
              borderColor: 'rgba(147, 51, 234, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(147, 51, 234, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } else if (activitiesCtx) {
        // Hide chart container if not available
        activitiesCtx.closest('.bg-white.rounded-lg.shadow.p-6').style.display = 'none';
      }

      // Assessments Chart
      const assessmentsCtx = document.getElementById('assessmentsChart');
      if (assessmentsCtx && availableSections.assessments) {
        assessmentsChart = new Chart(assessmentsCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
              data: chartData.assessments,
              backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'bottom' }
            },
            layout: {
              padding: {
                top: 10,
                bottom: 10
              }
            }
          }
        });
      } else if (assessmentsCtx) {
        // Hide chart container if not available
        assessmentsCtx.closest('.bg-white.rounded-lg.shadow.p-6').style.display = 'none';
      }

      // Careers Chart
      const careersCtx = document.getElementById('careersChart');
      if (careersCtx && availableSections.careers) {
        careersChart = new Chart(careersCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Career Guidance Sessions',
              data: chartData.careers,
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(59, 130, 246, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
      } else if (careersCtx) {
        // Hide chart container if not available
        careersCtx.closest('.bg-white.rounded-lg.shadow.p-6').style.display = 'none';
      }

      // Update analytics grid layout based on visible charts
      updateAnalyticsGridLayout(availableSections);
    }

    // Update analytics grid layout based on available sections
    function updateAnalyticsGridLayout(availableSections) {
      const analyticsGrid = document.querySelector('#analytics .grid.grid-cols-1.md\\:grid-cols-2.gap-8');
      if (!analyticsGrid) return;

      const visibleCharts = Object.values(availableSections).filter(Boolean).length;
      
      if (visibleCharts === 1) {
        analyticsGrid.className = 'grid grid-cols-1 gap-8 mb-12';
      } else if (visibleCharts === 2) {
        analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-8 mb-12';
      } else if (visibleCharts === 3) {
        analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-3 gap-8 mb-12';
      } else {
        analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-8 mb-12';
      }
    }

    // Load analytics data from aggregated service
    async function loadAnalyticsData() {
      try {
        const collegeId = getCollegeId();
        const response = await fetch(`/api/analytics/${collegeId}?limit=7`);
        const result = await response.json();
        
        if (!result.success) {
          console.log('Analytics not available, falling back to report processing');
          return generateChartDataFromReports();
        }
        
        return result.data;
      } catch (error) {
        console.error('Error loading analytics:', error);
        console.log('Falling back to report processing');
        return generateChartDataFromReports();
      }
    }

    // Generate chart data from reports (fallback method)
    function generateChartDataFromReports() {
      if (!collegeReports || collegeReports.length === 0) {
        // Return default data if no reports
        return {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
          placements: [0, 0, 0, 0, 0, 0, 0],
          activities: [0, 0, 0, 0, 0, 0, 0],
          assessments: [0, 0],
          careers: [0, 0, 0, 0, 0, 0, 0]
        };
      }

      // Sort reports by date (newest first)
      const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      // Take the last 7 reports for chart data
      const recentReports = sortedReports.slice(0, 7).reverse();
      
      const labels = recentReports.map(report => {
        const date = new Date(report.createdAt);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });

      const placements = recentReports.map(report => {
        if (!report.data || !report.data.rows) return 0;
        return calculateTotalFromReport(report.data, 'placement');
      });

      const activities = recentReports.map(report => {
        if (!report.data || !report.data.rows) return 0;
        return calculateTotalFromReport(report.data, 'activity');
      });

      const careers = recentReports.map(report => {
        if (!report.data || !report.data.rows) return 0;
        return Math.round(calculateTotalFromReport(report.data, 'student') * 0.15);
      });

      // Get latest report for assessments
      const latestReport = sortedReports[0];
      let completedAssessments = 0;
      let pendingAssessments = 0;
      
      if (latestReport && latestReport.data && latestReport.data.rows) {
        const totalStudents = calculateTotalFromReport(latestReport.data, 'student');
        const studentsWithoutAssessments = calculateTotalFromReport(latestReport.data, 'assessment');
        completedAssessments = totalStudents - studentsWithoutAssessments;
        pendingAssessments = studentsWithoutAssessments;
      }

      return {
        labels,
        placements,
        activities,
        assessments: [completedAssessments, pendingAssessments],
        careers
      };
    }

    // Helper function to calculate totals from report data
    function calculateTotalFromReport(reportData, type) {
      if (!reportData.rows) return 0;
      
      const headers = reportData.headers;
      let total = 0;

      reportData.rows.forEach(row => {
        if (!row[0] || row[0].toLowerCase().includes('total')) return;

        if (type === 'placement') {
          const index = headers.findIndex(h => h.toLowerCase().includes('placement') && !h.toLowerCase().includes('percent'));
          if (index >= 0 && row[index]) {
            total += parseFloat(row[index]) || 0;
          }
        } else if (type === 'activity') {
          const index = headers.findIndex(h => h.toLowerCase().includes('students with activities'));
          if (index >= 0 && row[index]) {
            total += parseFloat(row[index]) || 0;
          }
        } else if (type === 'student') {
          const index = headers.findIndex(h => h.toLowerCase().includes('total') && h.toLowerCase().includes('student'));
          if (index >= 0 && row[index]) {
            total += parseFloat(row[index]) || 0;
          }
        } else if (type === 'assessment') {
          const index = headers.findIndex(h => h.toLowerCase().includes('students without assessments'));
          if (index >= 0 && row[index]) {
            total += parseFloat(row[index]) || 0;
          }
        }
      });

      return total;
    }

    // Enhanced Analytics Functions
    async function loadEnhancedAnalytics() {
      try {
        const collegeId = getCollegeId();
        console.log('Loading enhanced analytics for college:', collegeId);
        
        const response = await fetch(`/api/enhanced-analytics/${collegeId}`, {
          credentials: 'include'
        });
        const result = await response.json();
        
        console.log('Enhanced analytics response:', result);
        
        if (result.success && result.data) {
          return result.data;
        } else {
          console.error('Enhanced analytics error:', result.error);
          return null;
        }
      } catch (error) {
        console.error('Error loading enhanced analytics:', error);
        return null;
      }
    }

    async function loadGapAnalysis() {
      try {
        const collegeId = getCollegeId();
        const response = await fetch(`/api/enhanced-analytics/${collegeId}/gap-analysis`, {
          credentials: 'include'
        });
        const result = await response.json();
        
        if (result.success && result.data) {
          return result.data;
        } else {
          console.error('Gap analysis error:', result.error);
          return null;
        }
      } catch (error) {
        console.error('Error loading gap analysis:', error);
        return null;
      }
    }

    function updatePerformanceCards(performanceData) {
      console.log('updatePerformanceCards called with:', performanceData);
      if (!performanceData) {
        console.log('No performance data provided');
        return;
      }
      
      const totalStudentsEl = document.getElementById('totalStudents');
      const placementRateEl = document.getElementById('placementRate');
      const enrichmentActivitiesEl = document.getElementById('enrichmentActivitiesParticipation');
      const employerActivitiesEl = document.getElementById('employerActivitiesParticipation');
      const assessmentRateEl = document.getElementById('assessmentRate');
      
      // Get card containers
      const placementCard = placementRateEl ? placementRateEl.closest('.mobile-analytics-card') : null;
      const enrichmentActivitiesCard = enrichmentActivitiesEl ? enrichmentActivitiesEl.closest('.mobile-analytics-card') : null;
      const employerActivitiesCard = employerActivitiesEl ? employerActivitiesEl.closest('.mobile-analytics-card') : null;
      const assessmentCard = assessmentRateEl ? assessmentRateEl.closest('.mobile-analytics-card') : null;
      
      console.log('Performance card elements found:', {
        totalStudents: !!totalStudentsEl,
        placementRate: !!placementRateEl,
        enrichmentActivities: !!enrichmentActivitiesEl,
        employerActivities: !!employerActivitiesEl,
        assessmentRate: !!assessmentRateEl
      });
      
      // Always show total students
      if (totalStudentsEl) totalStudentsEl.textContent =
        typeof performanceData.totalStudents === 'number' && performanceData.totalStudents > 0
          ? performanceData.totalStudents
          : 'No data yet';
      
      // Conditionally show/hide placement rate card
      if (placementRateEl && placementCard) {
        if (performanceData.availableSections.placements && performanceData.percentWithPlacements !== null) {
          placementRateEl.textContent = `${performanceData.percentWithPlacements.toFixed(1)}%`;
        } else {
          placementRateEl.textContent = 'No data yet';
        }
        placementCard.style.display = 'block';
      }
      
      // Conditionally show/hide enrichment activities card
      if (enrichmentActivitiesEl && enrichmentActivitiesCard) {
        if (performanceData.availableSections.activities && performanceData.percentStudentsWithActivitiesEnrichment !== null) {
          enrichmentActivitiesEl.textContent = `${performanceData.percentStudentsWithActivitiesEnrichment.toFixed(1)}%`;
        } else if (performanceData.availableSections.activities && performanceData.percentStudentsWithActivities !== null) {
          // Fallback to general activities if no separate enrichment data
          enrichmentActivitiesEl.textContent = `${performanceData.percentStudentsWithActivities.toFixed(1)}%`;
        } else {
          enrichmentActivitiesEl.textContent = 'No data yet';
        }
        enrichmentActivitiesCard.style.display = 'block';
      }
      
      // Conditionally show/hide employer activities card
      if (employerActivitiesEl && employerActivitiesCard) {
        if (performanceData.availableSections.activities && performanceData.percentStudentsWithActivitiesEmployer !== null && performanceData.percentStudentsWithActivitiesEmployer > 0) {
          employerActivitiesEl.textContent = `${performanceData.percentStudentsWithActivitiesEmployer.toFixed(1)}%`;
        } else if (performanceData.availableSections.activities && performanceData.percentStudentsWithActivities !== null) {
          // fallback to general activities if employer split isn't available
          employerActivitiesEl.textContent = `${performanceData.percentStudentsWithActivities.toFixed(1)}%`;
        } else {
          employerActivitiesEl.textContent = 'No data yet';
        }
        employerActivitiesCard.style.display = 'block';
      }
      
      // Conditionally show/hide assessment rate card
      if (assessmentRateEl && assessmentCard) {
        if (performanceData.availableSections.assessments && performanceData.assessmentCompletionRate !== null) {
          assessmentRateEl.textContent = `${performanceData.assessmentCompletionRate.toFixed(1)}%`;
        } else {
          assessmentRateEl.textContent = 'No data yet';
        }
        assessmentCard.style.display = 'block';
      }
      
      console.log('Performance cards updated with values:', {
        totalStudents: performanceData.totalStudents || 0,
        placementRate: performanceData.availableSections.placements ? `${performanceData.percentWithPlacements?.toFixed(1) || 0}%` : 'Hidden (no data)',
        enrichmentActivities: performanceData.availableSections.activities ? `${performanceData.percentStudentsWithActivitiesEnrichment?.toFixed(1) || performanceData.percentStudentsWithActivities?.toFixed(1) || 0}%` : 'Hidden (no data)',
        employerActivities: performanceData.availableSections.activities ? `${performanceData.percentStudentsWithActivitiesEmployer?.toFixed(1) || 0}%` : 'Hidden (no data)',
        assessmentRate: performanceData.availableSections.assessments ? `${performanceData.assessmentCompletionRate?.toFixed(1) || 0}%` : 'Hidden (no data)'
      });
    }

    // Helper functions for ranking display
    function getRankingColor(ranking, totalColleges) {
      if (!ranking || !totalColleges) return 'text-gray-500';
      
      const percentage = (ranking / totalColleges) * 100;
      if (percentage <= 25) return 'text-green-600'; // Top 25%
      if (percentage <= 50) return 'text-blue-600';  // Top 50%
      if (percentage <= 75) return 'text-yellow-600'; // Top 75%
      return 'text-red-600'; // Bottom 25%
    }
    
    function getRankingLabel(ranking, totalColleges) {
      if (!ranking || !totalColleges) return 'N/A';
      
      const percentage = (ranking / totalColleges) * 100;
      if (percentage <= 25) return 'Top 25%';
      if (percentage <= 50) return 'Top 50%';
      if (percentage <= 75) return 'Top 75%';
      return 'Bottom 25%';
    }
    
    function getPerformanceLevelColor(quartile) {
      if (!quartile || quartile === 'N/A') return 'text-gray-500';
      
      switch (parseInt(quartile)) {
        case 1: return 'text-green-600'; // Top 25%
        case 2: return 'text-blue-600';  // 25-50%
        case 3: return 'text-yellow-600'; // 50-75%
        case 4: return 'text-red-600';   // Bottom 25%
        default: return 'text-gray-500';
      }
    }
    
    function getPerformanceLevelLabel(quartile) {
      if (!quartile || quartile === 'N/A') return 'N/A';
      
      switch (parseInt(quartile)) {
        case 1: return 'Top 25%';
        case 2: return 'Above Average';
        case 3: return 'Below Average';
        case 4: return 'Bottom 25%';
        default: return 'N/A';
      }
    }

    function renderPeerBenchmarking(peerData) {
      console.log('renderPeerBenchmarking called with:', peerData);
      const container = document.getElementById('peerBenchmarkingContainer');
      console.log('Peer benchmarking container found:', !!container);
      if (!peerData || !container) {
        console.log('Missing peer data or container');
        return;
      }

      const ranking = (peerData.rankings && (peerData.rankings.placement || peerData.rankings.placement === 0)) ? peerData.rankings.placement : 'N/A';
      const totalColleges = peerData.totalColleges || 0;
      const quartile = (peerData.quartiles && (peerData.quartiles.placement || peerData.quartiles.placement === 0)) ? peerData.quartiles.placement : 'N/A';
      const similarCollegesCount = peerData.similarCollegesCount || 0;

      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="text-center">
              <div class="text-2xl font-bold ${getRankingColor(ranking, totalColleges)}">${ranking}</div>
              <div class="text-sm text-gray-600">Overall Ranking</div>
              <div class="text-xs text-gray-500">based on placement rate</div>
              <div class="text-xs ${getRankingColor(ranking, totalColleges)} font-medium mt-1">${getRankingLabel(ranking, totalColleges)}</div>
            </div>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <div class="text-center">
              <div class="text-2xl font-bold ${getPerformanceLevelColor(quartile)}">${quartile}</div>
              <div class="text-sm text-gray-600">Performance Level</div>
              <div class="text-xs text-gray-500">1 = Top 25%</div>
              <div class="text-xs ${getPerformanceLevelColor(quartile)} font-medium mt-1">${getPerformanceLevelLabel(quartile)}</div>
            </div>
          </div>
          <div class="bg-purple-50 rounded-lg p-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-purple-600">${similarCollegesCount}</div>
              <div class="text-sm text-gray-600">Similar Colleges</div>
              <div class="text-xs text-gray-500">for comparison</div>
            </div>
          </div>
          <div class="bg-orange-50 rounded-lg p-4">
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-600">${(peerData.overallAverages && typeof peerData.overallAverages.placementRate === 'number') ? peerData.overallAverages.placementRate.toFixed(1) : 'N/A'}%</div>
              <div class="text-sm text-gray-600">Peer Average</div>
              <div class="text-xs text-gray-500">placement rate</div>
            </div>
          </div>
        </div>
        
        <!-- Detailed Rankings Breakdown -->
        <div class="bg-blue-50 rounded-lg p-4 mb-4">
          <h4 class="font-semibold text-blue-900 mb-3 flex items-center">
            <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Detailed Rankings
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
             ${(peerData.availableSections && peerData.availableSections.placements) ? `
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <div class="text-center">
                <div class="text-lg font-bold ${getRankingColor(peerData.rankings?.placement, peerData.totalColleges)}">${peerData.rankings?.placement || 'N/A'}</div>
                <div class="text-sm text-gray-600">Placement Ranking</div>
                <div class="text-xs text-gray-500">out of ${peerData.totalColleges} colleges</div>
                <div class="text-xs ${getRankingColor(peerData.rankings?.placement, peerData.totalColleges)} font-medium mt-1">${getRankingLabel(peerData.rankings?.placement, peerData.totalColleges)}</div>
              </div>
            </div>
            ` : ''}
             ${(peerData.availableSections && peerData.availableSections.activities) ? `
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <div class="text-center">
                <div class="text-lg font-bold ${getRankingColor(peerData.rankings?.activity, peerData.totalColleges)}">${peerData.rankings?.activity || 'N/A'}</div>
                <div class="text-sm text-gray-600">Activity Ranking</div>
                <div class="text-xs text-gray-500">out of ${peerData.totalColleges} colleges</div>
                <div class="text-xs ${getRankingColor(peerData.rankings?.activity, peerData.totalColleges)} font-medium mt-1">${getRankingLabel(peerData.rankings?.activity, peerData.totalColleges)}</div>
              </div>
            </div>
            ` : ''}
             ${(peerData.availableSections && peerData.availableSections.assessments) ? `
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <div class="text-center">
                <div class="text-lg font-bold ${getRankingColor(peerData.rankings?.assessment, peerData.totalColleges)}">${peerData.rankings?.assessment || 'N/A'}</div>
                <div class="text-sm text-gray-600">Assessment Ranking</div>
                <div class="text-xs text-gray-500">out of ${peerData.totalColleges} colleges</div>
                <div class="text-xs ${getRankingColor(peerData.rankings?.assessment, peerData.totalColleges)} font-medium mt-1">${getRankingLabel(peerData.rankings?.assessment, peerData.totalColleges)}</div>
              </div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold text-gray-900 mb-3">Performance Comparison</h4>
          <div class="space-y-3">
             ${(peerData.availableSections && peerData.availableSections.placements) ? `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Placement Rate vs Peers:</span>
              <span class="text-sm font-medium ${peerData.performanceGap?.placement >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${peerData.performanceGap?.placement >= 0 ? '+' : ''}${peerData.performanceGap?.placement?.toFixed(1) || 0}%
              </span>
            </div>
            ` : ''}
             ${(peerData.availableSections && peerData.availableSections.activities) ? `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Activity Participation vs Peers:</span>
              <span class="text-sm font-medium ${peerData.performanceGap?.activity >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${peerData.performanceGap?.activity >= 0 ? '+' : ''}${peerData.performanceGap?.activity?.toFixed(1) || 0}%
              </span>
            </div>
            ` : ''}
             ${(peerData.availableSections && peerData.availableSections.assessments) ? `
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Assessment Completion vs Peers:</span>
              <span class="text-sm font-medium ${peerData.performanceGap?.assessment >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${peerData.performanceGap?.assessment >= 0 ? '+' : ''}${peerData.performanceGap?.assessment?.toFixed(1) || 0}%
              </span>
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderGapAnalysis(gapData) {
      const container = document.getElementById('gapAnalysisContainer');
      if (!gapData || !container) return;

      const opportunities = gapData.opportunities || [];
      
      if (opportunities.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="text-green-600 text-6xl mb-4">🎉</div>
            <h4 class="text-lg font-semibold text-gray-900 mb-2">Excellent Performance!</h4>
            <p class="text-gray-600">Your college is performing well compared to peers. Keep up the great work!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="space-y-4">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="font-semibold text-red-800 mb-3">Improvement Opportunities</h4>
            <div class="space-y-3">
              ${opportunities.map(opp => `
                <div class="flex items-start space-x-3">
                  <div class="flex-shrink-0">
                    <div class="w-2 h-2 rounded-full ${opp.priority === 'High' ? 'bg-red-500' : 'bg-yellow-500'} mt-2"></div>
                  </div>
                  <div class="flex-1">
                    <div class="flex justify-between items-start">
                      <div>
                        <h5 class="font-medium text-gray-900">${opp.area}</h5>
                        <p class="text-sm text-gray-600">${opp.description}</p>
                      </div>
                      <span class="text-sm font-semibold text-red-600">${opp.gap} gap</span>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-semibold text-blue-800 mb-2">Recommended Actions</h4>
            <ul class="text-sm text-blue-700 space-y-1">
              <li>• Focus resources on high-priority improvement areas</li>
              <li>• Develop targeted training programs for staff</li>
              <li>• Implement best practices from top-performing colleges</li>
              <li>• Set specific improvement targets and timelines</li>
            </ul>
          </div>
        </div>
      `;
    }
    function renderGeminiInsights(aiData) {
      console.log('renderGeminiInsights called with:', aiData);
      const container = document.getElementById('geminiInsightsContainer');
      console.log('Gemini insights container found:', !!container);
      if (!aiData || !container) {
        console.log('Missing AI data or container');
        return;
      }

            const recommendations = aiData.aiRecommendations?.recommendations;
      console.log('Recommendations object:', recommendations);
      
      let sections = {};
      
      if (recommendations && recommendations.sections) {
        sections = recommendations.sections;
        console.log('Using AI recommendations sections:', sections);
        
        // Check if AI recommendations are complete (have all sections)
        const requiredSections = ['immediateActions', 'trainingDevelopment', 'strategicPlanning', 'bestPractices', 'resourceAllocation', 'kpiSuggestions'];
        const hasAllSections = requiredSections.every(section => sections[section] && sections[section].trim() !== '');
        
        if (!hasAllSections) {
          console.log('AI recommendations incomplete, generating fallback recommendations...');
          const fallbackRecommendations = generateFallbackRecommendations(aiData);
          if (fallbackRecommendations) {
            sections = fallbackRecommendations.sections || {};
            console.log('Using fallback recommendations sections:', sections);
          }
        }
      } else {
        console.log('No AI recommendations available, generating fallback recommendations from live data...');
        
        // Generate fallback recommendations based on current performance data
        const fallbackRecommendations = generateFallbackRecommendations(aiData);
        
        if (fallbackRecommendations) {
          console.log('Generated fallback recommendations:', fallbackRecommendations);
          sections = fallbackRecommendations.sections || {};
          console.log('Using fallback recommendations sections:', sections);
        } else {
          container.innerHTML = `
            <div class="text-center py-8">
              <div class="flex justify-center mb-4">
                <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
              </div>
              <h4 class="text-lg font-semibold text-gray-900 mb-2">AI Analysis Unavailable</h4>
              <p class="text-gray-600">Enable OpenAI integration for advanced AI insights and recommendations.</p>
            </div>
          `;
          return;
        }
      }
      
      console.log('Final sections object:', sections);
      console.log('Section keys:', Object.keys(sections));
      console.log('Section values:', Object.values(sections));
      
      // Function to format text and show limited items with toggle
      function formatSectionContent(content, sectionName) {
        if (!content) return 'No recommendations available.';
        
        // Clean up markdown formatting
        let cleanContent = content
          .replace(/\*\*/g, '') // Remove bold markers
          .replace(/\*/g, '') // Remove italic markers
          .replace(/^[-*]\s*/gm, '• ') // Convert dashes to bullets
          .trim();
        
        // Split into individual items
        const items = cleanContent.split(/\n+/).filter(item => item.trim().length > 0);
        
        if (items.length <= 3) {
          // Show all items if 3 or fewer
          return items.map(item => `<div class="mb-2">${item}</div>`).join('');
        } else {
          // Show first 3 items with toggle
          const visibleItems = items.slice(0, 3);
          const hiddenItems = items.slice(3);
          
          return `
            ${visibleItems.map(item => `<div class="mb-2">${item}</div>`).join('')}
            <div id="${sectionName}Hidden" class="hidden">
              ${hiddenItems.map(item => `<div class="mb-2">${item}</div>`).join('')}
            </div>
            <button onclick="toggleMoreSuggestions('${sectionName}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium mt-2">
              Show ${hiddenItems.length} more suggestions →
            </button>
          `;
        }
      }
      
      container.innerHTML = `
        <div class="space-y-6">
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
              Immediate Actions
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.immediateActions, 'immediateActions')}</div>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
              </svg>
              Training & Development
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.trainingDevelopment, 'trainingDevelopment')}</div>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              Strategic Planning
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.strategicPlanning, 'strategicPlanning')}</div>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-purple-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
              Best Practices
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.bestPractices, 'bestPractices')}</div>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-indigo-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
              </svg>
              Resource Allocation
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.resourceAllocation, 'resourceAllocation')}</div>
          </div>
          
          <div class="bg-white rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
              </svg>
              KPI Suggestions
            </h4>
            <div class="text-sm text-gray-700">${formatSectionContent(sections.kpiSuggestions, 'kpiSuggestions')}</div>
            ${sections.kpiSuggestions ? `
              <div class="mt-3">
                <button onclick="showTab('kpi')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  View in KPI Tab →
                </button>
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span class="text-sm text-indigo-700">
                <strong>Powered by ChatGPT:</strong> These recommendations are generated using advanced AI analysis of your performance data and UK FE best practices.
              </span>
            </div>
            <button onclick="toggleAIThoughtProcess()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
              </svg>
              View AI Thought Process
            </button>
          </div>
        </div>
        
        <!-- AI Thought Process Toggle Section -->
        <div id="aiThoughtProcessContainer" class="mt-4 hidden">
          <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
              <svg class="w-5 h-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
              AI Raw Response & Thought Process
            </h4>
            <div id="aiRawResponse" class="text-xs text-gray-700 whitespace-pre-wrap font-mono bg-white p-3 rounded border max-h-96 overflow-y-auto">
              Loading AI response...
            </div>
          </div>
        </div>
      `;
      
      // Store raw response for thought process toggle
      if (recommendations.rawResponse) {
        window.aiRawResponse = recommendations.rawResponse;
        const rawResponseElement = document.getElementById('aiRawResponse');
        if (rawResponseElement) {
          rawResponseElement.textContent = recommendations.rawResponse;
        }
      }
    }
    
    // Toggle AI Thought Process visibility
    function toggleAIThoughtProcess() {
      const container = document.getElementById('aiThoughtProcessContainer');
      const button = document.querySelector('button[onclick="toggleAIThoughtProcess()"]');
      
      if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        button.innerHTML = `
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Hide AI Thought Process
        `;
      } else {
        container.classList.add('hidden');
        button.innerHTML = `
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
          </svg>
          View AI Thought Process
        `;
      }
    }
    
    // Toggle more suggestions visibility
    function toggleMoreSuggestions(sectionName) {
      const hiddenDiv = document.getElementById(sectionName + 'Hidden');
      const button = event.target;
      
      if (hiddenDiv.classList.contains('hidden')) {
        hiddenDiv.classList.remove('hidden');
        button.textContent = 'Show fewer suggestions →';
      } else {
        hiddenDiv.classList.add('hidden');
        button.textContent = 'Show more suggestions →';
      }
    }

    // Toggle department sticky position
    function toggleDepartmentSticky() {
      const toggle = document.getElementById('departmentStickyToggle');
      const isSticky = toggle.checked;
      
      // Update all existing department headers and cells
      const departmentHeaders = document.querySelectorAll('th');
      const departmentCells = document.querySelectorAll('td');
      
      departmentHeaders.forEach(header => {
        if (header.textContent.includes('Department')) {
          if (isSticky) {
            header.style.setProperty('position', 'sticky', 'important');
            header.style.setProperty('left', '0', 'important');
            header.style.setProperty('top', '0', 'important');
            header.style.setProperty('z-index', '5', 'important');
            header.style.setProperty('min-width', '260px', 'important');
            header.style.setProperty('background', '#fff', 'important');
          } else {
            header.style.removeProperty('position');
            header.style.removeProperty('left');
            header.style.removeProperty('top');
            header.style.removeProperty('z-index');
            header.style.removeProperty('min-width');
            header.style.removeProperty('background');
          }
        }
      });
      
      departmentCells.forEach((cell, index) => {
        // Check if this is the first column (department column)
        const row = cell.parentElement;
        const cellIndex = Array.from(row.children).indexOf(cell);
        if (cellIndex === 0) {
          if (isSticky) {
            cell.style.setProperty('position', 'sticky', 'important');
            cell.style.setProperty('left', '0', 'important');
            cell.style.setProperty('z-index', '2', 'important');
            cell.style.setProperty('background', '#fff', 'important');
            cell.style.setProperty('min-width', '260px', 'important');
          } else {
            cell.style.removeProperty('position');
            cell.style.removeProperty('left');
            cell.style.removeProperty('z-index');
            cell.style.removeProperty('background');
            cell.style.removeProperty('min-width');
          }
        }
      });
    }

    // Apply initial sticky styling to all department elements after table render
    function applyInitialDepartmentSticky() {
      const toggle = document.getElementById('departmentStickyToggle');
      if (!toggle || !toggle.checked) return;
      
      // Apply to headers
      const departmentHeaders = document.querySelectorAll('th');
      departmentHeaders.forEach(header => {
        if (header.textContent.includes('Department')) {
          header.style.setProperty('position', 'sticky', 'important');
          header.style.setProperty('left', '0', 'important');
          header.style.setProperty('top', '0', 'important');
          header.style.setProperty('z-index', '5', 'important');
          header.style.setProperty('min-width', '260px', 'important');
          header.style.setProperty('background', '#fff', 'important');
        }
      });
      
      // Apply to all first column cells (department cells)
      const tableRows = document.querySelectorAll('#reportDataContainer tr');
      tableRows.forEach(row => {
        const firstCell = row.children[0];
        if (firstCell && firstCell.tagName === 'TD') {
          firstCell.style.setProperty('position', 'sticky', 'important');
          firstCell.style.setProperty('left', '0', 'important');
          firstCell.style.setProperty('z-index', '2', 'important');
          firstCell.style.setProperty('background', '#fff', 'important');
          firstCell.style.setProperty('min-width', '260px', 'important');
        }
      });
    }

    // Global zoom level variable
    let currentZoomLevel = 100;

    // Adjust zoom level
    function adjustZoom(change) {
      currentZoomLevel = Math.max(50, Math.min(200, currentZoomLevel + change));
      applyZoom();
    }

    // Reset zoom to 100%
    function resetZoom() {
      currentZoomLevel = 100;
      applyZoom();
    }

    // Apply zoom to the report container
    function applyZoom() {
      const reportContainer = document.getElementById('reportDataContainer');
      const zoomDisplay = document.getElementById('zoomLevel');
      
      if (reportContainer) {
        reportContainer.style.transform = `scale(${currentZoomLevel / 100})`;
        reportContainer.style.transformOrigin = 'top left';
        reportContainer.style.width = `${10000 / currentZoomLevel}%`;
      }
      
      if (zoomDisplay) {
        zoomDisplay.textContent = `${currentZoomLevel}%`;
      }
    }

    async function loadAndDisplayEnhancedAnalytics() {
      console.log('=== ENHANCED ANALYTICS FUNCTION CALLED ===');
      try {
        console.log('Starting enhanced analytics load...');
        
        // First, update performance cards with current live data from latest report
        console.log('Updating performance cards with live data...');
        updateAnalyticsWithLiveData();
        
        // Load enhanced analytics data for peer comparison and AI insights
        const enhancedData = await loadEnhancedAnalytics();
        console.log('Enhanced data received:', enhancedData);
        
        if (enhancedData) {
          console.log('Updating chart visibility...');
          updateChartVisibilityForEnhancedAnalytics(enhancedData.performanceData);
          console.log('Rendering peer benchmarking...');
          renderPeerBenchmarking(enhancedData.peerComparison);
          console.log('Rendering Gemini insights...');
          // Guard against missing sections in fallback response
          try { renderGeminiInsights(enhancedData); } catch (e) { console.warn('renderGeminiInsights skipped:', e.message); }
          
          // IMPORTANT: Re-apply live data to ensure performance cards show current data, not cached data
          console.log('Re-applying live data to override any cached data...');
          updateAnalyticsWithLiveData();
        } else {
          console.log('No enhanced data received, showing fallback...');
          showFallbackAnalytics();
          // Even with fallback, ensure charts are updated with live data
          console.log('Updating charts with live data for fallback...');
          const chartData = generateChartDataFromReports();
          const availableSections = { placements: true, careers: true, activities: true, assessments: true };
          updateChartsWithLiveData(chartData, availableSections);
        }

        // Load gap analysis
        console.log('Loading gap analysis...');
        const gapData = await loadGapAnalysis();
        console.log('Gap data received:', gapData);
        
        if (gapData) {
          console.log('Rendering gap analysis...');
          renderGapAnalysis(gapData.gapAnalysis);
        } else {
          console.log('No gap data received, showing fallback...');
          showFallbackGapAnalysis();
        }
      } catch (error) {
        console.error('Error loading enhanced analytics:', error);
        showFallbackAnalytics();
        showFallbackGapAnalysis();
      }
    }

    // Update analytics dashboard with current live data from latest report
    function updateAnalyticsWithLiveData() {
      console.log('updateAnalyticsWithLiveData called');
      
      if (!collegeReports || collegeReports.length === 0) {
        console.log('No college reports available for analytics');
        return;
      }
      
      // Get the latest report by sorting by creation date
      const sortedReports = [...collegeReports].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      const latestReport = sortedReports[0];
      
      console.log('Latest report for analytics:', latestReport.name, latestReport.createdAt);
      
      if (!latestReport.data) {
        console.log('No data in latest report');
        return;
      }
      
      // Calculate totals from the latest report (same logic as main dashboard)
      const totals = calculateTotalsFromReport(latestReport.data);
      console.log('Calculated totals from latest report:', totals);
      
      // Determine available sections
      const availableSections = determineAvailableSections(latestReport.data);
      console.log('Available sections:', availableSections);
      
      // Create performance data object for analytics dashboard
      const performanceData = {
        totalStudents: totals.totalStudents,
        percentWithPlacements: totals.totalStudents > 0 ? (totals.studentsWithPlacements / totals.totalStudents) * 100 : 0,
        percentStudentsWithActivities: totals.totalStudents > 0 ? (totals.studentsWithActivities / totals.totalStudents) * 100 : 0,
        percentStudentsWithActivitiesEnrichment: totals.totalStudents > 0 ? (totals.studentsWithActivitiesEnrichment / totals.totalStudents) * 100 : 0,
        percentStudentsWithActivitiesEmployer: totals.totalStudents > 0 ? (totals.studentsWithActivitiesEmployer / totals.totalStudents) * 100 : 0,
        assessmentCompletionRate: totals.totalStudents > 0 ? (((totals.studentsWithAssessments > 0 ? totals.studentsWithAssessments : (totals.totalStudents - totals.studentsWithoutAssessments)) / totals.totalStudents) * 100) : 0,
        availableSections: availableSections
      };
      
      console.log('=== LIVE DATA CALCULATION ===');
      console.log('Total Students:', totals.totalStudents);
      console.log('Students with Activities:', totals.studentsWithActivities);
      console.log('Students with Activities Enrichment:', totals.studentsWithActivitiesEnrichment);
      console.log('Students with Activities Employer:', totals.studentsWithActivitiesEmployer);
      console.log('Calculated Activity Percentage:', performanceData.percentStudentsWithActivities);
      console.log('Calculated Enrichment Percentage:', performanceData.percentStudentsWithActivitiesEnrichment);
      console.log('Calculated Employer Percentage:', performanceData.percentStudentsWithActivitiesEmployer);
      console.log('Performance data for analytics:', performanceData);
      
      // Update the performance cards with live data
      updatePerformanceCards(performanceData);
      
      // Generate and update charts with live data
      console.log('Generating chart data from live reports...');
      const chartData = generateChartDataFromReports();
      console.log('Chart data generated:', chartData);
      
      // Update charts with live data
      updateChartsWithLiveData(chartData, availableSections);
    }

    // Update charts with live data from reports
    function updateChartsWithLiveData(chartData, availableSections) {
      console.log('updateChartsWithLiveData called with:', chartData, availableSections);
      
      // Update placements chart
      const placementsCtx = document.getElementById('placementsChart');
      if (placementsCtx && availableSections.placements) {
        destroyExistingChartForCanvas('placementsChart');
        
        window.placementsChart = new Chart(placementsCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Placements',
              data: chartData.placements,
              backgroundColor: 'rgba(34, 197, 94, 0.2)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(34, 197, 94, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
        console.log('Placements chart updated with live data');
      }

      // Update activities chart
      const activitiesCtx = document.getElementById('activitiesChart');
      if (activitiesCtx && availableSections.activities) {
        destroyExistingChartForCanvas('activitiesChart');
        
        window.activitiesChart = new Chart(activitiesCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Activities',
              data: chartData.activities,
              backgroundColor: 'rgba(251, 191, 36, 0.2)',
              borderColor: 'rgba(251, 191, 36, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(251, 191, 36, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
        console.log('Activities chart updated with live data');
      }

      // Update assessments chart
      const assessmentsCtx = document.getElementById('assessmentsChart');
      if (assessmentsCtx && availableSections.assessments) {
        destroyExistingChartForCanvas('assessmentsChart');
        
        window.assessmentsChart = new Chart(assessmentsCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Completed', 'Pending'],
            datasets: [{
              data: chartData.assessments,
              backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)'],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            layout: {
              padding: {
                top: 10,
                bottom: 10
              }
            }
          }
        });
        console.log('Assessments chart updated with live data');
      }

      // Update careers chart
      const careersCtx = document.getElementById('careersChart');
      if (careersCtx && availableSections.careers) {
        destroyExistingChartForCanvas('careersChart');
        
        window.careersChart = new Chart(careersCtx.getContext('2d'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Career Guidance Sessions',
              data: chartData.careers,
              backgroundColor: 'rgba(59, 130, 246, 0.2)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(59, 130, 246, 1)',
              pointRadius: 4,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        });
        console.log('Careers chart updated with live data');
      }
    }

    // Generate fallback recommendations based on performance data when AI is unavailable
    function generateFallbackRecommendations(aiData) {
      console.log('generateFallbackRecommendations called with:', aiData);
      
      if (!aiData || !aiData.performanceData) {
        console.log('No performance data available for fallback recommendations');
        return null;
      }
      
      const performanceData = aiData.performanceData;
      const peerData = aiData.peerComparison;
      
      console.log('Generating recommendations from performance data:', performanceData);
      
      const recommendations = {
        sections: {
          immediateActions: generateImmediateActions(performanceData, peerData),
          trainingDevelopment: generateTrainingDevelopment(performanceData, peerData),
          strategicPlanning: generateStrategicPlanning(performanceData, peerData),
          bestPractices: generateBestPractices(performanceData, peerData),
          resourceAllocation: generateResourceAllocation(performanceData, peerData),
          kpiSuggestions: generateKPISuggestions(performanceData, peerData)
        }
      };
      
      console.log('Generated fallback recommendations:', recommendations);
      return recommendations;
    }
    
    function generateImmediateActions(performanceData, peerData) {
      const actions = [];
      
      if (performanceData.percentWithPlacements < 50) {
        actions.push('• Focus on increasing student placement opportunities');
        actions.push('• Review and improve placement support processes');
        actions.push('• Strengthen employer partnerships for better placement rates');
      }
      
      if (performanceData.percentStudentsWithActivities < 30) {
        actions.push('• Develop more engaging activity programs');
        actions.push('• Increase promotion of available activities to students');
        actions.push('• Create incentives for activity participation');
      }
      
      if (performanceData.assessmentCompletionRate < 60) {
        actions.push('• Implement assessment completion tracking systems');
        actions.push('• Provide additional support for students struggling with assessments');
        actions.push('• Review assessment requirements and deadlines');
      }
      
      return actions.length > 0 ? actions.join('\n') : '• Monitor current performance metrics and identify improvement opportunities';
    }
    
    function generateTrainingDevelopment(performanceData, peerData) {
      const training = [];
      
      training.push('• Provide staff training on data analysis and reporting tools');
      training.push('• Develop training programs for student engagement strategies');
      training.push('• Create professional development opportunities for teaching staff');
      training.push('• Implement regular training sessions on best practices');
      
      return training.join('\n');
    }
    
    function generateStrategicPlanning(performanceData, peerData) {
      const planning = [];
      
      if (peerData && peerData.performanceGap) {
        if (peerData.performanceGap.placement < 0) {
          planning.push('• Develop strategic plan to improve placement rates');
        }
        if (peerData.performanceGap.activity < 0) {
          planning.push('• Create comprehensive activity engagement strategy');
        }
        if (peerData.performanceGap.assessment < 0) {
          planning.push('• Implement assessment improvement initiatives');
        }
      }
      
      planning.push('• Set quarterly performance targets and review progress');
      planning.push('• Establish key performance indicators for each department');
      planning.push('• Create long-term improvement roadmap');
      
      return planning.join('\n');
    }
    
    function generateBestPractices(performanceData, peerData) {
      const practices = [];
      
      practices.push('• Implement regular performance reviews and feedback sessions');
      practices.push('• Establish clear communication channels between departments');
      practices.push('• Create standardized processes for data collection and reporting');
      practices.push('• Develop student feedback mechanisms for continuous improvement');
      practices.push('• Foster collaboration between academic and support staff');
      
      return practices.join('\n');
    }
    
    function generateResourceAllocation(performanceData, peerData) {
      const resources = [];
      
      resources.push('• Allocate budget for staff training and development programs');
      resources.push('• Invest in technology and tools for better data management');
      resources.push('• Provide resources for student support and engagement activities');
      resources.push('• Allocate time for regular performance monitoring and analysis');
      resources.push('• Invest in marketing and promotion of college programs');
      
      return resources.join('\n');
    }
    
    function generateKPISuggestions(performanceData, peerData) {
      const kpis = [];
      
      // Generate specific KPI targets based on current performance
      const currentPlacement = performanceData.percentWithPlacements || 0;
      const currentActivity = performanceData.percentStudentsWithActivities || 0;
      const currentAssessment = performanceData.assessmentCompletionRate || 0;
      
      kpis.push(`• Increase student placement rate from ${currentPlacement.toFixed(1)}% to ${Math.min(currentPlacement + 15, 100).toFixed(1)}% by end of academic year`);
      kpis.push(`• Improve activity participation from ${currentActivity.toFixed(1)}% to ${Math.min(currentActivity + 10, 100).toFixed(1)}% within 6 months`);
      kpis.push(`• Achieve ${Math.min(currentAssessment + 20, 100).toFixed(1)}% assessment completion rate by next term`);
      kpis.push('• Implement student satisfaction surveys with 80% response rate target');
      kpis.push('• Establish employer partnership growth target of 25% increase');
      
      return kpis.join('\n');
    }

    function showFallbackAnalytics() {
      const container = document.getElementById('geminiInsightsContainer');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="flex justify-center mb-4">
              <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
              </svg>
            </div>
            <h4 class="text-lg font-semibold text-gray-900 mb-2">AI Analysis Unavailable</h4>
            <p class="text-gray-600">Unable to load AI insights. Please check your connection and try again.</p>
            <button onclick="loadAndDisplayEnhancedAnalytics()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
              Retry
            </button>
          </div>
        `;
      }
    }
    function updateChartVisibilityForEnhancedAnalytics(performanceData) {
      console.log('updateChartVisibilityForEnhancedAnalytics called with:', performanceData);
      
      // Get chart containers
      const placementsChartContainer = document.querySelector('#placementsChart').closest('.bg-white.rounded-lg.shadow.p-6');
      const activitiesChartContainer = document.querySelector('#activitiesChart').closest('.bg-white.rounded-lg.shadow.p-6');
      const assessmentsChartContainer = document.querySelector('#assessmentsChart').closest('.bg-white.rounded-lg.shadow.p-6');
      const careersChartContainer = document.querySelector('#careersChart').closest('.bg-white.rounded-lg.shadow.p-6');
      
      // Show/hide placements chart
      if (placementsChartContainer) {
        if (performanceData.availableSections.placements) {
          placementsChartContainer.style.display = 'block';
          console.log('Placements chart shown - data available');
        } else {
          placementsChartContainer.style.display = 'none';
          console.log('Placements chart hidden - no data available');
        }
      }
      
      // Show/hide activities chart
      if (activitiesChartContainer) {
        if (performanceData.availableSections.activities) {
          activitiesChartContainer.style.display = 'block';
          console.log('Activities chart shown - data available');
        } else {
          activitiesChartContainer.style.display = 'none';
          console.log('Activities chart hidden - no data available');
        }
      }
      
      // Show/hide assessments chart
      if (assessmentsChartContainer) {
        if (performanceData.availableSections.assessments) {
          assessmentsChartContainer.style.display = 'block';
          console.log('Assessments chart shown - data available');
        } else {
          assessmentsChartContainer.style.display = 'none';
          console.log('Assessments chart hidden - no data available');
        }
      }
      
      // Show/hide careers chart
      if (careersChartContainer) {
        if (performanceData.availableSections.careers) {
          careersChartContainer.style.display = 'block';
          console.log('Careers chart shown - data available');
        } else {
          careersChartContainer.style.display = 'none';
          console.log('Careers chart hidden - no data available');
        }
      }
      
      // Update analytics grid layout based on visible charts
      const analyticsGrid = document.querySelector('#analytics .grid.grid-cols-1.md\\:grid-cols-2.gap-8');
      if (analyticsGrid) {
        const visibleCharts = document.querySelectorAll('#analytics .bg-white.rounded-lg.shadow.p-6[style*="display: block"], #analytics .bg-white.rounded-lg.shadow.p-6:not([style*="display: none"])').length;
        
        if (visibleCharts === 1) {
          analyticsGrid.className = 'grid grid-cols-1 gap-8 mb-12';
        } else if (visibleCharts === 2) {
          analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-8 mb-12';
        } else if (visibleCharts === 3) {
          analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-3 gap-8 mb-12';
        } else {
          analyticsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-8 mb-12';
        }
      }
    }

    function showFallbackGapAnalysis() {
      const container = document.getElementById('gapAnalysisContainer');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="flex justify-center mb-4">
              <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
            </div>
            <h4 class="text-lg font-semibold text-gray-900 mb-2">Gap Analysis Unavailable</h4>
            <p class="text-gray-600">Unable to load gap analysis. Please check your connection and try again.</p>
            <button onclick="loadAndDisplayEnhancedAnalytics()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
              Retry
            </button>
          </div>
        `;
      }
    }

    // Debug function for troubleshooting
    function debugGlobalState() {
      console.log('=== DEBUG GLOBAL STATE ===');
      console.log('College Data:', collegeData);
      console.log('Account Manager Data:', accountManagerData);
      console.log('College Reports:', collegeReports);
      console.log('All Colleges:', allColleges);
      console.log('All Account Managers:', allAccountManagers);
      console.log('Current User:', currentUser);
      console.log('========================');
    }

    // Save college details function
    async function saveCollegeDetails() {
      if (!collegeData) {
        showNotification('No college data to save', 'error');
        return;
      }

      try {
        // Gather all form data including dynamic sections
        const updatedData = {
          name: document.getElementById('collegeName').value,
          numberOfProviders: document.getElementById('numberOfProviders').value,
          reportFrequency: document.getElementById('reportFrequency').value,
          template: (document.getElementById('collegeTemplate') || {}).value || 'standard',
          dataTransferMethod: document.getElementById('dataTransferMethod').value,
          misContactName: document.getElementById('misContactName').value,
          misContactEmail: document.getElementById('misContactEmail').value,
          renewalDate: document.getElementById('renewalDate').value,
          accountManagerId: document.getElementById('accountManager').value || null,
          status: document.getElementById('status').value,
          ofstedRating: document.getElementById('ofstedRating').value,
          engagementLevel: document.getElementById('engagementLevel').value,
          collegeSystem: (document.getElementById('collegeSystem') || {}).value || '',
          initialConcerns: (document.getElementById('initialConcerns') || {}).value || ''
        };

        // Collect modules data
        const moduleEntries = document.querySelectorAll('.module-entry');
        const modules = [];
        moduleEntries.forEach(entry => {
          const nameInput = entry.querySelector('input[type="text"]');
          const costInput = entry.querySelector('.module-cost');
          if (nameInput && costInput && nameInput.value.trim()) {
            modules.push({
              name: nameInput.value.trim(),
              cost: parseFloat(costInput.value) || 0
            });
          }
        });
        updatedData.modules = modules;

        // Collect key stakeholders data
        const stakeholderEntries = document.querySelectorAll('#key-stakeholders-container .stakeholder-entry');
        const keyStakeholders = [];
        stakeholderEntries.forEach(entry => {
          const inputs = entry.querySelectorAll('input');
          const nameInput = inputs[0]; // First input is name
          const positionInput = inputs[1]; // Second input is position
          const emailInput = inputs[2]; // Third input is email
          if (nameInput && nameInput.value.trim()) {
            keyStakeholders.push({
              name: nameInput.value.trim(),
              position: positionInput ? positionInput.value.trim() : '',
              email: emailInput ? emailInput.value.trim() : ''
            });
          }
        });
        updatedData.keyStakeholders = keyStakeholders;

        // Collect super users data
        const superUserEntries = document.querySelectorAll('#super-users-container .super-user-entry');
        const superUsers = [];
        superUserEntries.forEach(entry => {
          const inputs = entry.querySelectorAll('input');
          const nameInput = inputs[0]; // First input is name
          const positionInput = inputs[1]; // Second input is position
          const emailInput = inputs[2]; // Third input is email
          if (nameInput && nameInput.value.trim()) {
            superUsers.push({
              name: nameInput.value.trim(),
              position: positionInput ? positionInput.value.trim() : '',
              email: emailInput ? emailInput.value.trim() : ''
            });
          }
        });
        updatedData.superUsers = superUsers;

        // Collect SWOT analysis data
        updatedData.swotStrengths = document.getElementById('swotStrengths').value;
        updatedData.swotWeaknesses = document.getElementById('swotWeaknesses').value;
        updatedData.swotOpportunities = document.getElementById('swotOpportunities').value;
        updatedData.swotThreats = document.getElementById('swotThreats').value;

        console.log('Saving college data:', updatedData);

        // Save to backend
        const response = await fetch(`/api/colleges/${collegeData.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedData)
        });

        const result = await response.json();
        
        if (result.success) {
          showNotification('College details saved successfully', 'success');
          collegeData = { ...collegeData, ...updatedData };
          formDataChanged = false;
          // Reload college data from server to ensure consistency
          await loadCollegeData();
          // Force refresh the displays
          updateKeyStakeholdersDisplay(true);
          updateSuperUsersDisplay(true);
          // Trigger global event for dashboards to refresh
          window.dispatchEvent(new Event('collegeDataUpdated'));
        } else {
          throw new Error(result.error || 'Failed to save college details');
        }
      } catch (error) {
        console.error('Error saving college details:', error);
        showNotification('Error saving college details: ' + error.message, 'error');
      }
    }

    // Filter functions
    function applyFilters() {
      const dateRange = document.getElementById('dateRangeFilter').value;
      const searchTerm = document.getElementById('searchReportsFilter').value.toLowerCase();
      const sortBy = document.getElementById('sortReportsFilter').value;
      
      let filteredReports = [...collegeReports];
      
      // Apply date filter
      if (dateRange) {
        const daysAgo = parseInt(dateRange);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
        
        filteredReports = filteredReports.filter(report => {
          const reportDate = new Date(report.createdAt);
          return reportDate >= cutoffDate;
        });
      }
      
      // Apply search filter
      if (searchTerm) {
        filteredReports = filteredReports.filter(report => 
          report.name.toLowerCase().includes(searchTerm) ||
          report.summary.toLowerCase().includes(searchTerm)
        );
      }
      
      // Apply sorting
      filteredReports.sort((a, b) => {
        switch (sortBy) {
          case 'date-desc':
            return new Date(b.createdAt) - new Date(a.createdAt);
          case 'date-asc':
            return new Date(a.createdAt) - new Date(b.createdAt);
          case 'name-asc':
            return a.name.localeCompare(b.name);
          default:
            return new Date(b.createdAt) - new Date(a.createdAt);
        }
      });
      
      // Update the display
      updateReportsTableWithData(filteredReports);
    }
    
    function clearFilters() {
      document.getElementById('dateRangeFilter').value = '';
      document.getElementById('searchReportsFilter').value = '';
      document.getElementById('sortReportsFilter').value = 'date-desc';
      updateReportsTableWithData(collegeReports);
    }
    
    // Update reports table with filtered data
    function updateReportsTableWithData(reports = null) {
      const reportsToShow = reports || collegeReports;
      
      // Update desktop table view
      const reportsTableBody = document.getElementById('reportsTableBody');
      if (reportsTableBody) {
        if (!reportsToShow.length) {
          reportsTableBody.innerHTML = `
            <tr>
              <td colspan="4" class="px-6 py-4 text-center text-gray-500">No reports found</td>
            </tr>
          `;
        } else {
          reportsTableBody.innerHTML = reportsToShow.map(report => `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(report.createdAt).toLocaleString()}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${report.name}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${report.summary}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <button onclick="viewReport('${report.id}')" class="text-blue-600 hover:underline mr-2">View</button>
                <button onclick="openExcelEditor('${report.id}')" class="text-purple-600 hover:underline mr-2">Open in Excel Editor</button>
                <button onclick="downloadReport('${report.id}')" class="text-green-600 hover:underline mr-2">Download Excel</button>
                <button onclick="deleteReport('${report.id}')" class="text-red-600 hover:underline">Delete</button>
              </td>
            </tr>
          `).join('');
        }
      }

      // Update mobile card view
      const reportsCardBody = document.getElementById('reportsCardBody');
      if (reportsCardBody) {
        if (!reportsToShow.length) {
          reportsCardBody.innerHTML = `
            <div class="text-center text-gray-500 py-8">No reports found</div>
          `;
        } else {
          reportsCardBody.innerHTML = reportsToShow.map(report => `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900 text-lg">${report.name}</h4>
                  <p class="text-sm text-gray-600 mt-1">${new Date(report.createdAt).toLocaleString()}</p>
                </div>
              </div>
              <p class="text-gray-700 mb-4 text-sm">${report.summary}</p>
              <div class="flex flex-wrap gap-2">
                <button onclick="viewReport('${report.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600 transition-colors duration-200">
                  View
                </button>
                <button onclick="openExcelEditor('${report.id}')" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition-colors duration-200">
                  Excel Editor
                </button>
                <button onclick="downloadReport('${report.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600 transition-colors duration-200">
                  Download Excel
                </button>
                <button onclick="deleteReport('${report.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition-colors duration-200">
                  Delete
                </button>
              </div>
            </div>
          `).join('');
        }
      }
    }

    // Excel-like editor navigation
    function openExcelEditor(reportId) {
      const urlParams = new URLSearchParams(window.location.search);
      const collegeId = urlParams.get('id');
      if (!collegeId || !reportId) return;
      // Revert to x-spreadsheet editor for stability
      window.open(`report-editor-xs.html?collegeId=${collegeId}&reportId=${reportId}`, '_blank');
    }

    // Chart.js initialization
    window.onload = function() {
      // Force clear AI insights state on every page load for debugging
      sessionStorage.removeItem('aiInsightsLoaded');
      aiInsightsLoaded = false;
      console.log('Page loaded - cleared AI insights cache');
      
      // Detect mobile and optimize
      detectMobile();
      optimizeForMobile();
      
      // Add resize listener for mobile detection
      window.addEventListener('resize', () => {
        const wasMobile = isMobile;
        detectMobile();
        if (wasMobile !== isMobile) {
          optimizeForMobile();
        }
      });
      
      // Check for tab parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const tabParam = urlParams.get('tab');
      
      // Show the specified tab or default to overview
      const tabToShow = tabParam && ['overview', 'reports', 'details', 'analytics', 'kpi'].includes(tabParam) ? tabParam : 'overview';
      showTab(tabToShow);
      
      // Update URL to preserve the current tab
      if (tabParam) {
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('tab', tabParam);
        window.history.replaceState({}, '', newUrl);
      }
      
      updateTotalCost(); // Initialize total cost
      
      // Load college data from backend
      loadCollegeData();
      
          // Load all AI insights on page load, regardless of which tab is active
    console.log('Page loaded - will load all AI insights after college data loads');
  }

      // Load all AI insights on page load
    async function loadAllAIInsights() {
      // Force reload by clearing the flag
      aiInsightsLoaded = false;
      sessionStorage.removeItem('aiInsightsLoaded');
      
      console.log('Loading all AI insights...');
      try {
        // Load enhanced analytics (includes AI insights)
        await loadAndDisplayEnhancedAnalytics();
        
        // Don't auto-load KPI suggestions - only load when user clicks "Auto-Generate KPIs"
        console.log('Enhanced analytics loaded successfully');
        aiInsightsLoaded = true;
        sessionStorage.setItem('aiInsightsLoaded', 'true');
      } catch (error) {
        console.error('Error loading AI insights:', error);
      }
    }

  // Refresh AI insights manually
  async function refreshAIInsights() {
    console.log('Refreshing AI insights...');
    aiInsightsLoaded = false; // Reset the flag to allow reloading
    
    // Show loading state
    const peerContainer = document.getElementById('peerBenchmarkingContainer');
    const gapContainer = document.getElementById('gapAnalysisContainer');
    const insightsContainer = document.getElementById('geminiInsightsContainer');
    
    if (peerContainer) {
      peerContainer.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
          <p class="mt-2 text-gray-600">Refreshing peer comparison data...</p>
        </div>
      `;
    }
    
    if (gapContainer) {
      gapContainer.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
          <p class="mt-2 text-gray-600">Refreshing gap analysis...</p>
        </div>
      `;
    }
    
    if (insightsContainer) {
      insightsContainer.innerHTML = `
        <div class="text-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
          <p class="mt-2 text-gray-600">Refreshing AI insights...</p>
        </div>
      `;
    }
    
    try {
      await loadAndDisplayEnhancedAnalytics();
      aiInsightsLoaded = true;
      sessionStorage.setItem('aiInsightsLoaded', 'true');
      showNotification('AI insights refreshed successfully!', 'success');
    } catch (error) {
      console.error('Error refreshing AI insights:', error);
      showNotification('Error refreshing AI insights: ' + error.message, 'error');
    }
  }
  // KPI Tab Logic
    const kpiStatuses = [
      { value: 'on_target', label: 'On Target', color: 'bg-green-400' },
      { value: 'needs_support', label: 'Needs Support', color: 'bg-yellow-400' },
      { value: 'at_risk', label: 'At Risk', color: 'bg-red-400' }
    ];

    let kpiData = []; // Store KPI data
    let deletedKPIs = []; // Store recently deleted KPIs for undo functionality
    let undoTimeouts = new Map(); // Store undo timeout IDs
    let aiInsightsLoaded = sessionStorage.getItem('aiInsightsLoaded') === 'true'; // Track if AI insights have been loaded

    // Load KPIs from backend
    async function loadKPIs() {
      try {
        const collegeId = getCollegeId();
        if (!collegeId) {
          console.error('No college ID available for loading KPIs');
          return;
        }

        console.log('Loading KPIs for college:', collegeId);
        
        const response = await fetch(`/api/colleges/${collegeId}/kpis`, {
          credentials: 'include'
        });
        const result = await response.json();
        
        console.log('KPIs response:', result);
        
        if (result.success) {
          kpiData = result.kpis || [];
          console.log('Loaded KPI data:', kpiData);
          renderKPIs();
        } else {
          console.error('Failed to load KPIs:', result.error);
          showNotification('Failed to load KPIs: ' + result.error, 'error');
          // Add a default empty row if loading fails
          renderKPIs();
        }
      } catch (error) {
        console.error('Error loading KPIs:', error);
        showNotification('Error loading KPIs: ' + error.message, 'error');
        // Add a default empty row if there's an error
        renderKPIs();
      }
    }

    // Save KPIs to backend
    async function saveKPIs() {
      try {
        const collegeId = getCollegeId();
        if (!collegeId) {
          console.error('No college ID available for saving KPIs');
          return;
        }

        // Collect KPI data from the table
        const kpisToSave = collectKPIData();
        
        const response = await fetch(`/api/colleges/${collegeId}/kpis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({ kpis: kpisToSave })
        });
        
        const result = await response.json();
        
        if (result.success) {
          kpiData = result.kpis;
          showNotification('KPIs saved successfully!', 'success');
        } else {
          console.error('Failed to save KPIs:', result.error);
          showNotification('Failed to save KPIs: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error saving KPIs:', error);
        showNotification('Error saving KPIs: ' + error.message, 'error');
      }
    }

    // Collect KPI data from the table
    function collectKPIData() {
      const rows = document.querySelectorAll('#kpiTableBody tr');
      const kpis = [];
      
      rows.forEach((row, index) => {
        const kpiEditor = row.querySelector('.rich-textarea[data-kpi-id]');
        const prioritySelect = row.querySelector('.kpi-priority-select');
        const statusSelect = row.querySelector('.kpi-status-select');
        const notesEditor = row.querySelector('.rich-textarea:not([data-kpi-id])');
        
        if (kpiEditor && prioritySelect && statusSelect && notesEditor) {
          kpis.push({
            id: kpiEditor.dataset.kpiId || null,
            name: kpiEditor.innerHTML.trim(),
            priority: prioritySelect.value,
            status: statusSelect.value,
            notes: notesEditor.innerHTML.trim(),
            completed: row.dataset.completed === 'true',
            completedDate: row.dataset.completedDate || null,
            order: index + 1
          });
        }
      });
      
      return kpis;
    }

    // Load KPI suggestions from AI
    async function loadKPISuggestions() {
      try {
        const collegeId = getCollegeId();
        if (!collegeId) {
          console.error('No college ID available for loading KPI suggestions');
          renderKPISuggestions([]);
          return;
        }

        console.log('Loading KPI suggestions for college:', collegeId);
        
        // Add timeout to prevent infinite loading
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Request timeout')), 15000)
        );
        
        const fetchPromise = fetch(`/api/enhanced-analytics/${collegeId}`, {
          credentials: 'include'
        });
        
        const response = await Promise.race([fetchPromise, timeoutPromise]);
        const result = await response.json();
        
        console.log('Enhanced analytics response:', result);
        
        let kpiSuggestions = [];
        
        // Try to extract KPI suggestions from the response
        if (result.success && result.data?.aiRecommendations) {
          const aiRecs = result.data.aiRecommendations;
          
          // Check different possible locations for KPI suggestions
          if (aiRecs.kpiSuggestions) {
            kpiSuggestions = parseKPISuggestions(aiRecs.kpiSuggestions);
          } else if (aiRecs.recommendations?.sections?.kpiSuggestions) {
            kpiSuggestions = parseKPISuggestions(aiRecs.recommendations.sections.kpiSuggestions);
          } else if (aiRecs.sections?.kpiSuggestions) {
            kpiSuggestions = parseKPISuggestions(aiRecs.sections.kpiSuggestions);
          }
        }
        
        console.log('Parsed KPI suggestions:', kpiSuggestions);
        renderKPISuggestions(kpiSuggestions);
        
      } catch (error) {
        console.error('Error loading KPI suggestions:', error);
        // Show default suggestions on error
        const defaultSuggestions = [
          'Increase student placement rate to 50% by end of academic year',
          'Improve activity participation to 25% within 6 months',
          'Achieve 60% assessment completion rate',
          'Reduce student dropout rate by 10%',
          'Increase employer satisfaction score to 4.5/5',
          'Implement student feedback system with 80% response rate',
          'Develop 10 new industry partnerships',
          'Launch 5 new career development programs',
          'Achieve 90% student satisfaction rate',
          'Increase graduate employment rate to 70%'
        ];
        renderKPISuggestions(defaultSuggestions);
      }
    }

    // Parse KPI suggestions from AI response
    function parseKPISuggestions(suggestionsText) {
      if (!suggestionsText || typeof suggestionsText !== 'string') {
        return [];
      }
      
      console.log('Parsing KPI suggestions from:', suggestionsText);
      
      // Clean up the text
      let cleanText = suggestionsText
        .replace(/\*\*/g, '') // Remove bold markers
        .replace(/\*/g, '') // Remove italic markers
        .trim();
      
      // Split into lines and filter out empty lines
      const lines = cleanText.split('\n').filter(line => line.trim());
      
      const kpiSuggestions = [];
      
      for (const line of lines) {
        // Skip category headers and introductory text
        if (line.includes('Category:') || 
            line.includes('Student Placement Rates and Employer Engagement') ||
            line.includes('Activity Participation and Recording') ||
            line.includes('Staff Training and Navigate Adoption') ||
            line.includes('Here are five specific KPI suggestions') ||
            line.includes('Based on your college') ||
            line.includes('###') ||
            line.length < 20) {
          continue;
        }
        
        // Clean up the line
        let cleanLine = line
          .replace(/^[-*•]\s*/, '') // Remove bullet points
          .replace(/^\d+\.\s*/, '') // Remove numbering
          .replace(/^- KPI:\s*/, '') // Remove "- KPI:" prefix
          .replace(/^- Target:\s*/, '') // Remove "- Target:" prefix
          .replace(/^- Timeframe:\s*/, '') // Remove "- Timeframe:" prefix
          .replace(/\*\*/g, '') // Remove bold markers
          .trim();
        
        // Only add if it looks like a real KPI suggestion
        if (cleanLine.length > 20 && 
            (cleanLine.includes('%') || 
             cleanLine.includes('rate') || 
             cleanLine.includes('increase') || 
             cleanLine.includes('achieve') || 
             cleanLine.includes('target') ||
             cleanLine.includes('goal'))) {
          kpiSuggestions.push(cleanLine);
        }
      }
      
      // Limit to 10 suggestions maximum
      return kpiSuggestions.slice(0, 10);
    }

    // Render KPI suggestions
    function renderKPISuggestions(suggestions) {
      const container = document.getElementById('kpiSuggestionsContainer');
      
      if (!suggestions || suggestions.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4">
            <p class="text-gray-600">No KPI suggestions available. Click "Refresh Suggestions" to generate new ones.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="space-y-3">
          <p class="text-sm text-gray-700 mb-3">Based on your college's performance data, here are suggested KPIs to track:</p>
          <div class="space-y-2">
            ${suggestions.map((suggestion, index) => `
              <div class="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200">
                <div class="flex-shrink-0 w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                  <span class="text-xs font-medium text-blue-600">${index + 1}</span>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-900">${suggestion}</p>
                </div>
                <button onclick="addSuggestedKPI('${suggestion.replace(/'/g, "\\'")}')" 
                        class="flex-shrink-0 text-blue-600 hover:text-blue-800 text-sm font-medium">
                  Add
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Add suggested KPI to the table
    function addSuggestedKPI(suggestion) {
      // Clean the suggestion text before adding
      const cleanSuggestion = suggestion
        .replace(/\*\*/g, '') // Remove bold markers
        .replace(/\*/g, '') // Remove italic markers
        .replace(/^[-*•]\s*/, '') // Remove bullet points
        .trim();
      
      addKpiRow(cleanSuggestion, 'on_target', '', null, 'medium', false, null);
      showNotification('KPI added from suggestions!', 'success');
    }

    // Generate KPIs from AI suggestions
    async function generateKPIsFromAI() {
      try {
        // Show loading state in KPI suggestions container
        const container = document.getElementById('kpiSuggestionsContainer');
        container.innerHTML = `
          <div class="text-center py-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">Generating KPI suggestions...</p>
          </div>
        `;
        
        showNotification('Generating KPIs from AI suggestions...', 'info');
        
        const collegeId = getCollegeId();
        if (!collegeId) {
          showNotification('No college ID available', 'error');
          return;
        }

        // Prefer authenticated endpoint; fall back to debug if needed
        let response = await fetch(`/api/colleges/${collegeId}/generate-kpis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) {
          console.warn('Primary KPI endpoint failed, trying debug endpoint...');
          response = await fetch(`/api/debug/colleges/${collegeId}/generate-kpis`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
        }
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('KPI generation response:', result);
        
        if (result.success && result.kpiSuggestions) {
          const kpiSuggestions = result.kpiSuggestions;
          console.log('Generated KPI suggestions:', kpiSuggestions);
          
          if (kpiSuggestions.length > 0) {
            // Show the suggestions in the container
            renderKPISuggestions(kpiSuggestions);
            
            showNotification(`Generated ${kpiSuggestions.length} KPI suggestions!`, 'success');
          } else {
            throw new Error('No KPI suggestions received from AI');
          }
        } else {
          throw new Error(result.error || 'Failed to generate KPI suggestions');
        }
      } catch (error) {
        console.error('Error generating KPIs from AI:', error);
        showNotification('Error generating KPIs from AI: ' + error.message, 'error');
        
        // Show fallback suggestions on error
        const fallbackSuggestions = [
          'Increase student placement rate to 50% by end of academic year',
          'Improve activity participation to 25% within 6 months',
          'Achieve 60% assessment completion rate by next term',
          'Reduce student dropout rate by 10% within 12 months',
          'Increase employer satisfaction score to 4.5/5 by end of year',
          'Implement student feedback system with 80% response rate',
          'Develop 10 new industry partnerships within 6 months',
          'Launch 5 new career development programs by next term'
        ];
        
        renderKPISuggestions(fallbackSuggestions);
      }
    }

    // Simple OpenAI test function - DISABLED FOR PRODUCTION
    /*
    async function testOpenAI() {
      try {
        showNotification('Testing OpenAI API...', 'info');
        
        // Show test results in a simple popup
        const testResults = document.createElement('div');
        testResults.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        testResults.innerHTML = `
          <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">OpenAI Test Results</h3>
            <div id="testResultsContent">
              <div class="text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Testing OpenAI API...</p>
              </div>
            </div>
            <div class="mt-4 flex justify-end">
              <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                Close
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(testResults);

        // Test the API
        const response = await fetch('/api/debug/openai', {
          credentials: 'include'
        });
        const result = await response.json();
        
        // Update the test results
        const content = document.getElementById('testResultsContent');
        content.innerHTML = `
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>API Key Configured:</span>
              <span class="${result.hasApiKey ? 'text-green-600' : 'text-red-600'} font-semibold">
                ${result.hasApiKey ? '✅ Yes' : '❌ No'}
              </span>
            </div>
            <div class="flex justify-between">
              <span>AI Analysis Enabled:</span>
              <span class="${result.enabled ? 'text-green-600' : 'text-red-600'} font-semibold">
                ${result.enabled ? '✅ Yes' : '❌ No'}
              </span>
            </div>
            <div class="flex justify-between">
              <span>OpenAI Available:</span>
              <span class="${result.isOpenAIAvailable ? 'text-green-600' : 'text-red-600'} font-semibold">
                ${result.isOpenAIAvailable ? '✅ Yes' : '❌ No'}
              </span>
            </div>
            <div class="flex justify-between">
              <span>Model:</span>
              <span class="font-semibold">${result.model || 'Not set'}</span>
            </div>
            ${result.testSuccess !== undefined ? `
            <div class="flex justify-between">
              <span>Test API Call:</span>
              <span class="${result.testSuccess ? 'text-green-600' : 'text-red-600'} font-semibold">
                ${result.testSuccess ? '✅ Success' : '❌ Failed'}
              </span>
            </div>
            ${result.testError ? `
            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs">
              <strong>Error:</strong> ${result.testError}
            </div>
            ` : ''}
            ` : ''}
            ${!result.hasApiKey ? `
            <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs">
              <strong>To fix:</strong> Add your OpenAI API key to the environment variables in cPanel Node.js settings.
            </div>
            ` : ''}
          </div>
        `;
        
        if (result.testSuccess) {
          showNotification('OpenAI API is working! ✅', 'success');
        } else if (result.hasApiKey) {
          showNotification('OpenAI API key found but test failed. Check the error above.', 'warning');
        } else {
          showNotification('OpenAI API key not configured. Add it to cPanel settings.', 'error');
        }
        
             } catch (error) {
         console.error('Error testing OpenAI:', error);
         showNotification('Error testing OpenAI: ' + error.message, 'error');
       }
     }
     */

    // Refresh KPI suggestions
    async function refreshKPISuggestions() {
      const container = document.getElementById('kpiSuggestionsContainer');
      container.innerHTML = `
        <div class="text-center py-4">
          <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto"></div>
          <p class="mt-2 text-gray-600">Refreshing KPI suggestions...</p>
        </div>
      `;
      
      await loadKPISuggestions();
    }

    // Render KPIs in the table
    function renderKPIs() {
      const tbody = document.getElementById('kpiTableBody');
      tbody.innerHTML = '';
      
      if (kpiData.length === 0) {
        // Add a default empty row if no KPIs exist
        addKpiRow();
      } else {
        // Sort by order and render existing KPIs
        const sortedKPIs = [...kpiData].sort((a, b) => a.order - b.order);
        sortedKPIs.forEach(kpi => {
          addKpiRow(
            kpi.name, 
            kpi.status, 
            kpi.notes, 
            kpi.id, 
            kpi.priority || 'medium',
            kpi.completed || false,
            kpi.completedDate || null
          );
        });
      }
    }

    function addKpiRow(kpi = '', status = 'on_target', notes = '', kpiId = null, priority = 'medium', completed = false, completedDate = null) {
      const tbody = document.getElementById('kpiTableBody');
      const row = document.createElement('tr');
      const color = kpiStatuses.find(s => s.value === status).color;
      const uniqueId = kpiId || 'temp-' + Date.now();
      const rowNumber = tbody.children.length + 1;
      
      // Add completed class if KPI is completed
      const completedClass = completed ? 'bg-green-50 border-l-4 border-l-green-500' : '';
      
      row.innerHTML = `
        <td class="px-4 py-2 align-top kpi-number" data-label="Number">
          <div class="kpi-number">${rowNumber}</div>
        </td>
        <td class="px-4 py-2 align-top" data-label="Priority">
          <select class="border rounded px-2 py-1 kpi-priority-select w-full text-sm font-medium" onchange="updateKpiPriority(this)">
            <option value="high" ${priority === 'high' ? 'selected' : ''}>High</option>
            <option value="medium" ${priority === 'medium' ? 'selected' : ''}>Medium</option>
            <option value="low" ${priority === 'low' ? 'selected' : ''}>Low</option>
          </select>
        </td>
        <td class="px-4 py-2 align-top" data-label="KPI">
          <div class="rich-text-container">
            <div
              id="${uniqueId}-kpi"
              class="rich-textarea w-full"
              contenteditable="true"
              data-kpi-id="${kpiId || ''}"
              data-placeholder="Enter KPI name..."
              oninput="handleRichTextInput(this)"
              onkeydown="handleRichTextKeydown(event, this)"
              onfocus="handleRichTextFocus(this)"
              onblur="handleRichTextBlur(this)"
              onpaste="handleRichTextPaste(event, this)"
              oncontextmenu="showFloatingToolbar(event, this)"
            >${kpi}</div>
          </div>
        </td>
        <td class="px-4 py-2 align-top" data-label="Progress">
          <select class="border rounded px-2 py-1 kpi-status-select ${color} w-full">
            ${kpiStatuses.map(s => `<option value="${s.value}" ${s.value === status ? 'selected' : ''}>${s.label}</option>`).join('')}
          </select>
        </td>
        <td class="px-4 py-2 align-top" data-label="Notes">
          <div class="rich-text-container">
            <div
              id="${uniqueId}-notes"
              class="rich-textarea w-full"
              contenteditable="true"
              data-placeholder="Add notes..."
              oninput="handleRichTextInput(this)"
              onkeydown="handleRichTextKeydown(event, this)"
              onfocus="handleRichTextFocus(this)"
              onblur="handleRichTextBlur(this)"
              onpaste="handleRichTextPaste(event, this)"
              oncontextmenu="showFloatingToolbar(event, this)"
            >${notes}</div>
          </div>
        </td>
        <td class="px-4 py-2 align-top" data-label="Status">
          ${completed ? 
            `<div class="text-center">
              <span class="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                Completed
              </span>
              <div class="text-xs text-gray-500 mt-2">${completedDate ? new Date(completedDate).toLocaleDateString() : ''}</div>
              <button onclick="markKpiIncomplete(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-xs font-medium hover:bg-gray-600 touch-button mt-2 w-full">
                Mark Incomplete
              </button>
            </div>` :
            `<button onclick="markKpiCompleted(this)" class="bg-green-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-600 touch-button shadow-sm transition-colors duration-200 w-full">
              Mark Complete
            </button>`
          }
        </td>
        <td class="px-4 py-2 align-top" data-label="Actions">
          <button onclick="deleteKpiRow(this)" class="text-red-500 hover:underline touch-button">Delete</button>
        </td>
      `;
      
      // Add completed class to row if completed
      if (completed) {
        row.classList.add('bg-green-50', 'border-l-4', 'border-l-green-500');
      }
      tbody.appendChild(row);
      
      const select = row.querySelector('.kpi-status-select');
      select.addEventListener('change', function() {
        kpiStatuses.forEach(s => this.classList.remove(s.color));
        const color = kpiStatuses.find(s => s.value === this.value).color;
        this.classList.add(color);
      });
      
      // Apply initial colors immediately
      applyInitialColors(row);
      
      // Initialize rich text areas
      const kpiEditor = document.getElementById(`${uniqueId}-kpi`);
      const notesEditor = document.getElementById(`${uniqueId}-notes`);
      if (kpiEditor) initializeRichTextarea(kpiEditor);
      if (notesEditor) initializeRichTextarea(notesEditor);
      
      updateKpiNumbers();
    }

    // Apply initial colors to priority and status selects
    function applyInitialColors(row) {
      // Apply priority color
      const prioritySelect = row.querySelector('.kpi-priority-select');
      if (prioritySelect) {
        const priority = prioritySelect.value;
        row.classList.remove('priority-high', 'priority-medium', 'priority-low');
        row.classList.add(`priority-${priority}`);
      }
      
      // Apply status color
      const statusSelect = row.querySelector('.kpi-status-select');
      if (statusSelect) {
        const status = statusSelect.value;
        kpiStatuses.forEach(s => statusSelect.classList.remove(s.color));
        const color = kpiStatuses.find(s => s.value === status).color;
        statusSelect.classList.add(color);
      }
    }

    // Update KPI priority and reorder
    function updateKpiPriority(selectElement) {
      const row = selectElement.closest('tr');
      const priority = selectElement.value;
      
      // Add visual indicator for priority
      row.classList.remove('priority-high', 'priority-medium', 'priority-low');
      row.classList.add(`priority-${priority}`);
      
      // Reorder KPIs by priority
      reorderKPIsByPriority();
      
      showNotification(`KPI priority updated to ${priority}`, 'info');
    }

    // Reorder KPIs by priority (High > Medium > Low)
    function reorderKPIsByPriority() {
      const tbody = document.getElementById('kpiTableBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      
      // Sort rows by priority
      rows.sort((a, b) => {
        const priorityA = a.querySelector('.kpi-priority-select').value;
        const priorityB = b.querySelector('.kpi-priority-select').value;
        
        const priorityOrder = { high: 3, medium: 2, low: 1 };
        return priorityOrder[priorityB] - priorityOrder[priorityA];
      });
      
      // Re-append rows in sorted order
      rows.forEach(row => tbody.appendChild(row));
      
      // Update row numbers
      updateKpiNumbers();
    }
    // Mark KPI as completed
    function markKpiCompleted(button) {
      const row = button.closest('tr');
      const completedDate = new Date().toISOString();
      
      // Update the status cell
      const statusCell = row.querySelector('td[data-label="Status"]');
      statusCell.innerHTML = `
        <div class="text-center">
          <span class="inline-flex items-center px-3 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            Completed
          </span>
          <div class="text-xs text-gray-500 mt-2">${new Date(completedDate).toLocaleDateString()}</div>
          <button onclick="markKpiIncomplete(this)" class="bg-gray-500 text-white px-3 py-1 rounded text-xs font-medium hover:bg-gray-600 touch-button mt-2 w-full">
            Mark Incomplete
          </button>
        </div>
      `;
      
      // Add completed styling to row
      row.classList.add('bg-green-50', 'border-l-4', 'border-l-green-500');
      
      // Store completion data
      row.dataset.completed = 'true';
      row.dataset.completedDate = completedDate;
      
      showNotification('KPI marked as completed!', 'success');
    }

    // Mark KPI as incomplete
    function markKpiIncomplete(button) {
      const row = button.closest('tr');
      const kpiEditor = row.querySelector('.rich-textarea[data-kpi-id]');
      const kpiName = kpiEditor ? kpiEditor.innerHTML.trim() : 'this KPI';
      
      // Show confirmation dialog
      if (confirm(`Are you sure you want to mark "${kpiName}" as incomplete? This will remove the completion status and date.`)) {
        // Update the status cell
        const statusCell = row.querySelector('td[data-label="Status"]');
        statusCell.innerHTML = `
          <button onclick="markKpiCompleted(this)" class="bg-green-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-600 touch-button shadow-sm transition-colors duration-200 w-full">
            Mark Complete
          </button>
        `;
        
        // Remove completed styling from row
        row.classList.remove('bg-green-50', 'border-l-4', 'border-l-green-500');
        
        // Clear completion data
        row.dataset.completed = 'false';
        row.dataset.completedDate = '';
        
        showNotification('KPI marked as incomplete!', 'info');
      }
    }

    // Initialize rich textarea
    function initializeRichTextarea(element) {
      if (!element.textContent.trim()) {
        element.classList.add('empty');
      }
      
      // Auto-resize on initialization
      autoResizeContentEditable(element);
    }

    // Handle rich text input
    function handleRichTextInput(element) {
      if (element.textContent.trim()) {
        element.classList.remove('empty');
      } else {
        element.classList.add('empty');
      }
      
      // Auto-resize the contenteditable div
      autoResizeContentEditable(element);
    }

    // Auto-resize contenteditable div
    function autoResizeContentEditable(element) {
      // Force the element to respect CSS max-height with !important
      element.style.setProperty('max-height', '120px', 'important');
      element.style.setProperty('min-height', '40px', 'important');
      element.style.setProperty('max-width', '100%', 'important');
      element.style.setProperty('width', '100%', 'important');
      element.style.setProperty('overflow-y', 'auto', 'important');
      element.style.setProperty('overflow-x', 'hidden', 'important');
      element.style.setProperty('height', 'auto', 'important');
      element.style.setProperty('word-wrap', 'break-word', 'important');
      element.style.setProperty('word-break', 'break-word', 'important');
      element.style.setProperty('box-sizing', 'border-box', 'important');
      
      // Reset height to auto to get the correct scrollHeight
      element.style.setProperty('height', 'auto', 'important');
      
      // Calculate the new height based on content
      const scrollHeight = element.scrollHeight;
      const minHeight = 40; // 40px minimum
      const maxHeight = 120; // 120px maximum
      
      // Set the height within limits
      const newHeight = Math.min(Math.max(scrollHeight, minHeight), maxHeight);
      element.style.setProperty('height', newHeight + 'px', 'important');
      
      // Ensure overflow is set correctly
      if (scrollHeight > maxHeight) {
        element.style.setProperty('overflow-y', 'auto', 'important');
      } else {
        element.style.setProperty('overflow-y', 'hidden', 'important');
      }
      
      // Force a reflow to ensure styles are applied
      element.offsetHeight;
    }

    // Handle rich text focus
    function handleRichTextFocus(element) {
      element.classList.remove('empty');
      if (!element.textContent.trim()) {
        element.textContent = '';
      }
    }

    // Handle rich text blur
    function handleRichTextBlur(element) {
      if (!element.textContent.trim()) {
        element.classList.add('empty');
        element.textContent = element.dataset.placeholder || '';
      }
    }

    // Handle rich text paste
    function handleRichTextPaste(event, element) {
      event.preventDefault();
      
      try {
        // Try to get plain text from clipboard
        const text = event.clipboardData.getData('text/plain');
        
        if (text) {
          // Use modern clipboard API if available
          if (navigator.clipboard && window.getSelection) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              range.deleteContents();
              range.insertNode(document.createTextNode(text));
              range.collapse(false);
            } else {
              // Fallback: append to end
              element.appendChild(document.createTextNode(text));
            }
          } else {
            // Fallback to execCommand (deprecated but still works in some browsers)
            document.execCommand('insertText', false, text);
          }
          
          // Trigger input event to update the element
          element.dispatchEvent(new Event('input', { bubbles: true }));
          
          // Auto-resize after paste
          autoResizeContentEditable(element);
        }
      } catch (error) {
        console.error('Paste error:', error);
        
        // Final fallback: try to paste as plain text
        try {
          const text = event.clipboardData.getData('text/plain') || '';
          if (text) {
            element.textContent += text;
            element.dispatchEvent(new Event('input', { bubbles: true }));
            autoResizeContentEditable(element);
          }
        } catch (fallbackError) {
          console.error('Fallback paste error:', fallbackError);
        }
      }
    }

    // Handle rich text keyboard shortcuts
    function handleRichTextKeydown(event, element) {
      // Ctrl+B: Bold
      if (event.ctrlKey && event.key === 'b') {
        event.preventDefault();
        formatSelectedText('bold');
      }
      // Ctrl+I: Italic
      else if (event.ctrlKey && event.key === 'i') {
        event.preventDefault();
        formatSelectedText('italic');
      }
      // Ctrl+U: Underline
      else if (event.ctrlKey && event.key === 'u') {
        event.preventDefault();
        formatSelectedText('underline');
      }
      // Tab: Navigate to next field
      else if (event.key === 'Tab') {
        event.preventDefault();
        const fields = element.closest('tr').querySelectorAll('.rich-textarea, select, button');
        const currentIndex = Array.from(fields).indexOf(element);
        const nextField = fields[currentIndex + 1];
        if (nextField) {
          nextField.focus();
          if (nextField.classList.contains('rich-textarea')) {
            nextField.classList.remove('empty');
          }
        }
      }
    }

    // Format selected text with actual HTML styling
    function formatSelectedText(format) {
      const toolbar = document.getElementById('floating-toolbar');
      if (!toolbar) return;
      
      const elementId = toolbar.dataset.targetElement;
      const element = document.getElementById(elementId);
      if (!element) return;
      
      element.focus();
      
      switch (format) {
        case 'bold':
          document.execCommand('bold', false, null);
          break;
        case 'italic':
          document.execCommand('italic', false, null);
          break;
        case 'underline':
          document.execCommand('underline', false, null);
          break;
        case 'highlight-yellow':
          document.execCommand('backColor', false, 'yellow');
          break;
        case 'highlight-green':
          document.execCommand('backColor', false, '#90EE90');
          break;
        case 'highlight-blue':
          document.execCommand('backColor', false, '#87CEEB');
          break;
        case 'highlight-pink':
          document.execCommand('backColor', false, '#FFB6C1');
          break;
        case 'highlight-orange':
          document.execCommand('backColor', false, '#FFA500');
          break;
        case 'bullet-dot':
          document.execCommand('insertUnorderedList', false, null);
          break;
        case 'bullet-dash':
          // Insert custom dash bullet
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const text = range.toString();
            if (text) {
              range.deleteContents();
              const listItem = document.createElement('li');
              listItem.style.listStyleType = 'none';
              listItem.innerHTML = '– ' + text;
              range.insertNode(listItem);
            }
          }
          break;
        case 'bullet-arrow':
          // Insert custom arrow bullet
          const selection2 = window.getSelection();
          if (selection2.rangeCount > 0) {
            const range = selection2.getRangeAt(0);
            const text = range.toString();
            if (text) {
              range.deleteContents();
              const listItem = document.createElement('li');
              listItem.style.listStyleType = 'none';
              listItem.innerHTML = '→ ' + text;
              range.insertNode(listItem);
            }
          }
          break;
        case 'bullet-star':
          // Insert custom star bullet
          const selection3 = window.getSelection();
          if (selection3.rangeCount > 0) {
            const range = selection3.getRangeAt(0);
            const text = range.toString();
            if (text) {
              range.deleteContents();
              const listItem = document.createElement('li');
              listItem.style.listStyleType = 'none';
              listItem.innerHTML = '★ ' + text;
              range.insertNode(listItem);
            }
          }
          break;
        case 'bullet-check':
          // Insert custom check bullet
          const selection4 = window.getSelection();
          if (selection4.rangeCount > 0) {
            const range = selection4.getRangeAt(0);
            const text = range.toString();
            if (text) {
              range.deleteContents();
              const listItem = document.createElement('li');
              listItem.style.listStyleType = 'none';
              listItem.innerHTML = '✓ ' + text;
              range.insertNode(listItem);
            }
          }
          break;
        case 'clear':
          // Remove formatting but keep text
          const selection5 = window.getSelection();
          if (selection5.rangeCount > 0) {
            const range = selection5.getRangeAt(0);
            const text = range.toString();
            range.deleteContents();
            range.insertNode(document.createTextNode(text));
          }
          break;
      }
      
      // Hide sub-menus
      const highlightMenu = document.getElementById('highlight-menu');
      const bulletMenu = document.getElementById('bullet-menu');
      if (highlightMenu) highlightMenu.classList.add('hidden');
      if (bulletMenu) bulletMenu.classList.add('hidden');
      
      // Auto-resize after formatting
      const formattedElement = document.getElementById(elementId);
      if (formattedElement) {
        autoResizeContentEditable(formattedElement);
      }
      
      hideFloatingToolbar();
    }

    // Update collectKPIData to work with contenteditable divs
    function collectKPIData() {
      const rows = document.querySelectorAll('#kpiTableBody tr');
      const kpis = [];
      
      rows.forEach((row, index) => {
        const kpiEditor = row.querySelector('.rich-textarea[data-kpi-id]');
        const statusSelect = row.querySelector('.kpi-status-select');
        const notesEditor = row.querySelector('.rich-textarea:not([data-kpi-id])');
        
        if (kpiEditor && statusSelect && notesEditor) {
          kpis.push({
            id: kpiEditor.dataset.kpiId || null,
            name: kpiEditor.innerHTML.trim(),
            status: statusSelect.value,
            notes: notesEditor.innerHTML.trim(),
            order: index + 1
          });
        }
      });
      
      return kpis;
    }

    // Update renderKPIs to work with contenteditable divs
    function renderKPIs() {
      const tbody = document.getElementById('kpiTableBody');
      tbody.innerHTML = '';
      
      if (kpiData.length === 0) {
        // Add a default empty row if no KPIs exist
        addKpiRow();
      } else {
        // Sort by order and render existing KPIs
        const sortedKPIs = [...kpiData].sort((a, b) => a.order - b.order);
        sortedKPIs.forEach(kpi => {
          addKpiRow(
            kpi.name, 
            kpi.status, 
            kpi.notes, 
            kpi.id, 
            kpi.priority || 'medium',
            kpi.completed || false,
            kpi.completedDate || null
          );
        });
      }
    }

    function deleteKpiRow(button) {
      const row = button.closest('tr');
      const kpiEditor = row.querySelector('.rich-textarea[data-kpi-id]');
      const prioritySelect = row.querySelector('.kpi-priority-select');
      const statusSelect = row.querySelector('.kpi-status-select');
      const notesEditor = row.querySelector('.rich-textarea:not([data-kpi-id])');
      const kpiId = kpiEditor ? kpiEditor.dataset.kpiId : null;
      
      // Store the deleted KPI data for undo functionality
      const deletedKPI = {
        id: kpiId,
        name: kpiEditor ? kpiEditor.innerHTML.trim() : '',
        priority: prioritySelect ? prioritySelect.value : 'medium',
        status: statusSelect ? statusSelect.value : 'on_target',
        notes: notesEditor ? notesEditor.innerHTML.trim() : '',
        completed: row.dataset.completed === 'true',
        completedDate: row.dataset.completedDate || null,
        order: Array.from(row.parentNode.children).indexOf(row) + 1,
        timestamp: Date.now()
      };
      
      // Add to deleted KPIs array
      deletedKPIs.push(deletedKPI);
      
      // Remove the row from the table
      row.remove();
      updateKpiNumbers();
      
      // Show undo notification
      showUndoNotification(deletedKPI);
      
      // If the KPI has an ID, delete from backend after a delay
      if (kpiId) {
        setTimeout(() => {
          deleteKPIFromBackend(kpiId);
        }, 5000); // 5 second delay before permanent deletion
      }
    }

    function showUndoNotification(deletedKPI) {
      // Create undo notification
      const notification = document.createElement('div');
      notification.id = `undo-notification-${deletedKPI.timestamp}`;
      notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-lg z-50 flex items-center space-x-2';
      notification.innerHTML = `
        <span>KPI "${deletedKPI.name}" deleted</span>
        <button onclick="undoDeleteKPI(${deletedKPI.timestamp})" class="bg-white text-blue-500 px-2 py-1 rounded text-sm hover:bg-gray-100">Undo</button>
        <button onclick="dismissUndoNotification(${deletedKPI.timestamp})" class="text-white hover:text-gray-200">×</button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-dismiss after 5 seconds
      const timeoutId = setTimeout(() => {
        dismissUndoNotification(deletedKPI.timestamp);
      }, 5000);
      
      undoTimeouts.set(deletedKPI.timestamp, timeoutId);
    }

    function undoDeleteKPI(timestamp) {
      // Find the deleted KPI
      const deletedKPIIndex = deletedKPIs.findIndex(kpi => kpi.timestamp === timestamp);
      if (deletedKPIIndex === -1) return;
      
      const deletedKPI = deletedKPIs[deletedKPIIndex];
      
      // Remove from deleted KPIs array
      deletedKPIs.splice(deletedKPIIndex, 1);
      
      // Clear the timeout
      const timeoutId = undoTimeouts.get(timestamp);
      if (timeoutId) {
        clearTimeout(timeoutId);
        undoTimeouts.delete(timestamp);
      }
      
      // Dismiss the notification
      dismissUndoNotification(timestamp);
      
      // Restore the KPI row
      addKpiRow(
        deletedKPI.name, 
        deletedKPI.status, 
        deletedKPI.notes, 
        deletedKPI.id,
        deletedKPI.priority || 'medium',
        deletedKPI.completed || false,
        deletedKPI.completedDate || null
      );
      
      showNotification('KPI restored successfully!', 'success');
    }

    function dismissUndoNotification(timestamp) {
      const notification = document.getElementById(`undo-notification-${timestamp}`);
      if (notification) {
        notification.remove();
      }
      
      // Clear the timeout
      const timeoutId = undoTimeouts.get(timestamp);
      if (timeoutId) {
        clearTimeout(timeoutId);
        undoTimeouts.delete(timestamp);
      }
    }

    async function deleteKPIFromBackend(kpiId) {
      try {
        const response = await fetch(`/api/kpis/${kpiId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        const result = await response.json();
        
        if (!result.success) {
          console.error('Failed to delete KPI:', result.error);
          showNotification('Failed to delete KPI: ' + result.error, 'error');
        }
      } catch (error) {
        console.error('Error deleting KPI:', error);
        showNotification('Error deleting KPI: ' + error.message, 'error');
      }
    }

    // ... existing code ...

    // Update showTab function to load KPIs when KPI tab is shown
    function showTab(tabName) {
      const tabs = ['overview', 'reports', 'details', 'analytics', 'kpi'];
      tabs.forEach(tab => {
        document.getElementById(tab).classList.add('hidden');
        document.getElementById('tab-' + tab).classList.remove('border-blue-500', 'text-blue-600');
        document.getElementById('tab-' + tab).classList.add('border-transparent', 'text-gray-500');
      });
      document.getElementById(tabName).classList.remove('hidden');
      document.getElementById('tab-' + tabName).classList.add('border-blue-500', 'text-blue-600');
      document.getElementById('tab-' + tabName).classList.remove('border-transparent', 'text-gray-500');
      
      // Load KPIs when KPI tab is shown
      if (tabName === 'kpi') {
        loadKPIs();
      }
    }

    // ... existing code ...

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
      textarea.style.minHeight = '40px';
    }

    function updateKpiNumbers() {
      const rows = document.querySelectorAll('#kpiTableBody tr');
      rows.forEach((row, idx) => {
        const numCell = row.querySelector('.kpi-number');
        if (numCell) numCell.textContent = idx + 1;
      });
    }

    // Handle keyboard shortcuts for textareas
    function handleTextareaKeydown(event, textarea) {
      // Ctrl+A: Select all
      if (event.ctrlKey && event.key === 'a') {
        event.preventDefault();
        textarea.select();
      }
      // Ctrl+C: Copy (let browser handle this)
      // Ctrl+V: Paste (let browser handle this)
      // Ctrl+X: Cut (let browser handle this)
      // Ctrl+Z: Undo (let browser handle this)
      // Ctrl+Y: Redo (let browser handle this)
      
      // Tab: Move to next field
      if (event.key === 'Tab') {
        event.preventDefault();
        const fields = textarea.closest('tr').querySelectorAll('textarea, select, button');
        const currentIndex = Array.from(fields).indexOf(textarea);
        const nextField = fields[currentIndex + 1];
        if (nextField) {
          nextField.focus();
          if (nextField.tagName === 'TEXTAREA') {
            nextField.select();
          }
        }
      }
      
      // Enter: Add new line (default behavior)
      // Shift+Enter: Add new line (default behavior)
    }

    // Show context menu for textareas
    function showTextareaContextMenu(event, textarea) {
      event.preventDefault();
      
      // Remove existing context menu
      const existingMenu = document.getElementById('textarea-context-menu');
      if (existingMenu) {
        existingMenu.remove();
      }
      
      // Create context menu
      const menu = document.createElement('div');
      menu.id = 'textarea-context-menu';
      menu.className = 'fixed bg-white border border-gray-300 rounded shadow-lg z-50 py-1 min-w-32';
      menu.style.left = event.pageX + 'px';
      menu.style.top = event.pageY + 'px';
      
      menu.innerHTML = `
        <button onclick="selectAllText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Select All</button>
        <button onclick="copyText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Copy</button>
        <button onclick="cutText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Cut</button>
        <button onclick="pasteText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Paste</button>
        <hr class="my-1">
        <button onclick="undoText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Undo</button>
        <button onclick="redoText('${textarea.id || 'temp-id'}')" class="w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">Redo</button>
      `;
      
      document.body.appendChild(menu);
      
      // Add temporary ID to textarea if it doesn't have one
      if (!textarea.id) {
        textarea.id = 'temp-id-' + Date.now();
        menu.innerHTML = menu.innerHTML.replace(/temp-id/g, textarea.id);
      }
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        });
      }, 100);
    }

    // Text editing functions
    function selectAllText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        textarea.select();
        textarea.focus();
      }
    }

    function copyText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        textarea.select();
        document.execCommand('copy');
        textarea.focus();
      }
    }
    function cutText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        textarea.select();
        document.execCommand('cut');
        textarea.focus();
        autoResizeTextarea(textarea);
      }
    }

    function pasteText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        textarea.focus();
        
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.readText) {
          navigator.clipboard.readText().then(text => {
            if (textarea.tagName === 'TEXTAREA') {
              // Handle regular textarea
              const start = textarea.selectionStart;
              const end = textarea.selectionEnd;
              const value = textarea.value;
              textarea.value = value.substring(0, start) + text + value.substring(end);
              textarea.selectionStart = textarea.selectionEnd = start + text.length;
              autoResizeTextarea(textarea);
            } else if (textarea.classList.contains('rich-textarea')) {
              // Handle contenteditable div
              const selection = window.getSelection();
              if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                range.collapse(false);
              } else {
                textarea.appendChild(document.createTextNode(text));
              }
              textarea.dispatchEvent(new Event('input', { bubbles: true }));
              autoResizeContentEditable(textarea);
            }
          }).catch(err => {
            console.error('Failed to paste text:', err);
            // Fallback: try to trigger paste event
            textarea.dispatchEvent(new ClipboardEvent('paste', {
              clipboardData: new DataTransfer()
            }));
          });
        } else {
          // Fallback for older browsers
          try {
            document.execCommand('paste');
            if (textarea.tagName === 'TEXTAREA') {
              autoResizeTextarea(textarea);
            } else if (textarea.classList.contains('rich-textarea')) {
              autoResizeContentEditable(textarea);
            }
          } catch (fallbackError) {
            console.error('Fallback paste failed:', fallbackError);
          }
        }
      }
    }

    function undoText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        document.execCommand('undo');
        textarea.focus();
        autoResizeTextarea(textarea);
      }
    }

    function redoText(textareaId) {
      const textarea = document.getElementById(textareaId);
      if (textarea) {
        document.execCommand('redo');
        textarea.focus();
        autoResizeTextarea(textarea);
      }
    }

    // Show floating toolbar (only on right-click)
    function showFloatingToolbar(event, element) {
      event.preventDefault();
      
      // Remove existing toolbar
      hideFloatingToolbar();
      
      // Create floating toolbar
      const toolbar = document.createElement('div');
      toolbar.id = 'floating-toolbar';
      toolbar.className = 'fixed bg-white border border-gray-300 rounded shadow-lg z-50 py-1 px-2 flex gap-1 flex-wrap';
      
      toolbar.innerHTML = `
        <button onclick="formatSelectedText('bold')" class="format-btn" title="Bold (Ctrl+B)">
          <strong>B</strong>
        </button>
        <button onclick="formatSelectedText('italic')" class="format-btn" title="Italic (Ctrl+I)">
          <em>I</em>
        </button>
        <button onclick="formatSelectedText('underline')" class="format-btn" title="Underline (Ctrl+U)">
          <u>U</u>
        </button>
        <div class="relative">
          <button onclick="toggleHighlightMenu()" class="format-btn" title="Highlight Colors">
            <span style="background-color: yellow;">H</span>
          </button>
          <div id="highlight-menu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded shadow-lg p-1 z-50">
            <button onclick="formatSelectedText('highlight-yellow')" class="format-btn w-full mb-1" title="Yellow Highlight">
              <span style="background-color: yellow;">Yellow</span>
            </button>
            <button onclick="formatSelectedText('highlight-green')" class="format-btn w-full mb-1" title="Green Highlight">
              <span style="background-color: #90EE90;">Green</span>
            </button>
            <button onclick="formatSelectedText('highlight-blue')" class="format-btn w-full mb-1" title="Blue Highlight">
              <span style="background-color: #87CEEB;">Blue</span>
            </button>
            <button onclick="formatSelectedText('highlight-pink')" class="format-btn w-full mb-1" title="Pink Highlight">
              <span style="background-color: #FFB6C1;">Pink</span>
            </button>
            <button onclick="formatSelectedText('highlight-orange')" class="format-btn w-full" title="Orange Highlight">
              <span style="background-color: #FFA500;">Orange</span>
            </button>
          </div>
        </div>
        <div class="relative">
          <button onclick="toggleBulletMenu()" class="format-btn" title="Bullet Points">
            •
          </button>
          <div id="bullet-menu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded shadow-lg p-1 z-50">
            <button onclick="formatSelectedText('bullet-dot')" class="format-btn w-full mb-1" title="Dot Bullet">
              •
            </button>
            <button onclick="formatSelectedText('bullet-dash')" class="format-btn w-full mb-1" title="Dash Bullet">
              –
            </button>
            <button onclick="formatSelectedText('bullet-arrow')" class="format-btn w-full mb-1" title="Arrow Bullet">
              →
            </button>
            <button onclick="formatSelectedText('bullet-star')" class="format-btn w-full mb-1" title="Star Bullet">
              ★
            </button>
            <button onclick="formatSelectedText('bullet-check')" class="format-btn w-full" title="Check Bullet">
              ✓
            </button>
          </div>
        </div>
        <button onclick="formatSelectedText('clear')" class="format-btn text-red-500" title="Clear Formatting">
          Clear
        </button>
      `;
      
      document.body.appendChild(toolbar);
      
      // Position toolbar near mouse cursor
      toolbar.style.left = (event.pageX + 10) + 'px';
      toolbar.style.top = (event.pageY - 40) + 'px';
      
      // Store reference to current element
      toolbar.dataset.targetElement = element.id;
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        hideFloatingToolbar();
      }, 5000);
    }

    // Toggle highlight menu
    function toggleHighlightMenu() {
      const highlightMenu = document.getElementById('highlight-menu');
      const bulletMenu = document.getElementById('bullet-menu');
      
      if (bulletMenu) bulletMenu.classList.add('hidden');
      
      if (highlightMenu) {
        highlightMenu.classList.toggle('hidden');
      }
    }

    // Toggle bullet menu
    function toggleBulletMenu() {
      const bulletMenu = document.getElementById('bullet-menu');
      const highlightMenu = document.getElementById('highlight-menu');
      
      if (highlightMenu) highlightMenu.classList.add('hidden');
      
      if (bulletMenu) {
        bulletMenu.classList.toggle('hidden');
      }
    }

    // Hide floating toolbar
    function hideFloatingToolbar() {
      const toolbar = document.getElementById('floating-toolbar');
      if (toolbar) {
        toolbar.remove();
      }
    }

    // Format selected text with actual HTML styling

    // Test paste functionality
    function testPasteFunctionality() {
      console.log('Testing paste functionality...');
      
      // Test if clipboard API is available
      if (navigator.clipboard) {
        console.log('✅ Clipboard API available');
      } else {
        console.log('⚠️ Clipboard API not available');
      }
      
      // Test if execCommand is available
      if (document.execCommand) {
        console.log('✅ execCommand available');
      } else {
        console.log('⚠️ execCommand not available');
      }
      
      // Test if we can access clipboard data
      try {
        const testEvent = new ClipboardEvent('paste', {
          clipboardData: new DataTransfer()
        });
        console.log('✅ Clipboard events supported');
      } catch (error) {
        console.log('⚠️ Clipboard events not supported:', error);
      }
    }

    // Call test function on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Uncomment the next line to test paste functionality
      // testPasteFunctionality();
    });


  </script>
</body>
</html> 