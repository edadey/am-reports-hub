<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Report Viewer</title>
  <style>
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:#111827; }
    .topbar { display:flex; align-items:center; gap:8px; padding:12px; border-bottom:1px solid #e5e7eb; }
    .topbar .title { font-weight:600; color:#111827; margin-right:auto; }
    .btn { padding:8px 12px; border-radius:6px; font-size:14px; cursor:pointer; border:1px solid #d1d5db; background:#fff; }
    .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .status { margin-left:12px; color:#6b7280; font-size:13px; }
    .container { padding:16px; }
    table { border-collapse:separate; border-spacing:0; width:100%; }
    th, td { border:1px solid #e5e7eb; padding:8px; font-size:13px; }
    th { position:sticky; top:0; background:#f9fafb; z-index:2; }
    .header { font-weight:600; text-align:center; }
    .chip { display:inline-block; padding:2px 6px; border-radius:10px; font-size:11px; font-weight:600; }
    .chip.green { background:#dcfce7; color:#166534; }
    .chip.red { background:#fee2e2; color:#991b1b; }
    .chip.orange { background:#ffedd5; color:#9a3412; }
    .percent-bar { height:8px; background:#e5e7eb; border-radius:4px; overflow:hidden; }
    .percent-bar > .fill { height:100%; background:#3b82f6; }
    .totals { background:#f8fafc; font-weight:600; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Report Viewer</div>
    <button id="btnDownload" class="btn">Download Excel</button>
    <button id="btnBaseline" class="btn">Use as Baseline</button>
    <button id="btnBack" class="btn">Back</button>
    <span id="status" class="status"></span>
  </div>
  <div class="container">
    <div id="content">Loading...</div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);
  const collegeId = qs.get('collegeId');
  const reportId = qs.get('reportId');
  const statusEl = document.getElementById('status');
  const contentEl = document.getElementById('content');

  function setStatus(msg, type='info'){
    statusEl.textContent = msg;
    statusEl.style.color = type==='error' ? '#b91c1c' : (type==='success' ? '#065f46' : '#6b7280');
  }

  // Map Tailwind classes (saved from preview) to viewer hex colours
  const classToHex = {
    'bg-blue-100': '#DBEAFE', 'bg-blue-200': '#BFDBFE',
    'bg-purple-100': '#F3E8FF', 'bg-yellow-100': '#FEF3C7',
    'bg-green-100': '#DCFCE7', 'bg-green-200': '#BBF7D0',
    'bg-pink-100': '#FCE7F3', 'bg-indigo-100': '#E0E7FF',
    'bg-gray-100': '#F3F4F6', 'bg-amber-100': '#FEF3C7',
    'bg-teal-100': '#CCFBF1', 'bg-cyan-100': '#E0F7FA',
    'bg-orange-100': '#FED7AA', 'bg-red-100': '#FEE2E2',
    'bg-lime-100': '#ECFCCB'
  };
  function baseHeaderKey(h){
    return String(h||'')
      .replace(/\s*\+\/\-\s*$/, '')
      .replace(/\s*\[[^\]]+\]\s*$/, '')
      .trim();
  }
  function sectionColor(header, meta) {
    const key = String(header||'');
    const base = baseHeaderKey(key);
    const h = key.toLowerCase();
    const hb = base.toLowerCase();
    const hexMeta = meta?.headerHexColors?.[key] || meta?.headerHexColors?.[base];
    const clsMeta = meta?.headerColorClasses?.[key] || meta?.headerColorClasses?.[base];
    // 1) Use saved exact hex from preview if present
    if (hexMeta && /^#?[0-9A-Fa-f]{6,8}$/.test(hexMeta)) {
      const clean = hexMeta.startsWith('#') ? hexMeta : ('#'+hexMeta);
      const hex6 = clean.length === 9 ? ('#'+clean.slice(3)) : clean; // strip alpha if provided
      return { bg: hex6, fg:'#111827' };
    }
    // 2) Use saved class from preview
    if (clsMeta && classToHex[clsMeta]) return { bg: classToHex[clsMeta], fg:'#111827' };
    // 3) Canonical heuristics matching UI colours (check exact and base)
    const has = (needle) => (h.includes(needle) || hb.includes(needle));
    if (/(activities\s*combined\s*kc|activities-combined)/i.test(h) || /(activities\s*combined\s*kc|activities-combined)/i.test(hb)) return { bg:'#ECFCCB', fg:'#365314' };
    if (/(\(enrichment\)|\(enrichment activity\))/i.test(h) || /(\(enrichment\)|\(enrichment activity\))/i.test(hb) || has('enrichment')) return { bg:'#CCFBF1', fg:'#134E4A' };
    if (/(\(employer\s*(engagement|activity)\))/i.test(h) || /(\(employer\s*(engagement|activity)\))/i.test(hb) || (has('employer') && (has('activity') || has('activities')))) return { bg:'#F3E8FF', fg:'#6B21A8' };
    if (/(\(placements\))/i.test(h) || /(\(placements\))/i.test(hb) || has('placement') || has('placed')) return { bg:'#DBEAFE', fg:'#1E40AF' };
    if (/(\(careers\))/i.test(h) || /(\(careers\))/i.test(hb) || has('career') || has('quiz')) return { bg:'#FEF3C7', fg:'#92400E' };
    if (/(\(assessments\))/i.test(h) || /(\(assessments\))/i.test(hb) || has('assessment') || has('score')) return { bg:'#BBF7D0', fg:'#14532D' };
    if (/(\(targets\))/i.test(h) || /(\(targets\))/i.test(hb) || has('target')) return { bg:'#FCE7F3', fg:'#BE185D' };
    if (/(\(login\))/i.test(h) || /(\(login\))/i.test(hb) || has('login')) return { bg:'#E0E7FF', fg:'#3730A3' };
    return { bg:'#F3F4F6', fg:'#374151' };
  }

  function keyExact(h){ return String(h??'').trim().toLowerCase(); }
  function keyNorm(h){ return String(h??'').replace(/\s*\+\/\-\s*$/, '').replace(/\s*\[[^\]]+\]\s*$/, '').trim().toLowerCase(); }
  function buildPrevMaps(prevHeaders){
    const exact={}, norm={};
    (Array.isArray(prevHeaders)?prevHeaders:[]).forEach((ph,i)=>{ exact[keyExact(ph)]=i; const k=keyNorm(ph); if(norm[k]===undefined) norm[k]=i; });
    return {exact,norm};
  }
  function getPrevIdx(header, fallback, maps){
    const ex = maps.exact[keyExact(header)]; if (ex!==undefined) return ex;
    const nm = maps.norm[keyNorm(header)]; if (nm!==undefined) return nm;
    return fallback;
  }
  function parsePercentLike(v){
    const s = String(v??'').trim(); if (!s) return null;
    if (/%\s*$/.test(s)) { const num=parseFloat(s.replace(/%/g,'')); return isNaN(num)?null:num; }
    const num = parseFloat(s); if (isNaN(num)) return null;
    if (num>=0 && num<=1) return num*100; return num;
  }
  function parseNumber(v){ const n = parseFloat(String(v??'').toString().replace(/[,]/g,'')); return isNaN(n)?null:n; }

  function renderTable(headers, rows, previous, meta){
    const prevRows = previous?.rows || previous?.data?.rows || [];
    const prevHeaders = previous?.headers || previous?.data?.headers || [];
    const prevMaps = buildPrevMaps(prevHeaders);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    table.appendChild(thead); table.appendChild(tbody);

    // Header row
    const hr = document.createElement('tr');
    headers.forEach((h,i)=>{
      const th = document.createElement('th');
      th.className='header';
      const sc = sectionColor(h, meta);
      // Use inline important styles to avoid sticky header default overriding
      try {
        th.style.setProperty('background', sc.bg, 'important');
        th.style.setProperty('background-color', sc.bg, 'important');
        th.style.setProperty('border-color', sc.bg, 'important');
        th.style.setProperty('color', sc.fg, 'important');
      } catch (_) {
        th.style.background = sc.bg; th.style.color = sc.fg;
      }
      th.textContent = h;
      hr.appendChild(th);
    });
    thead.appendChild(hr);

    // Body rows
    rows.forEach(row => {
      const tr = document.createElement('tr');
      headers.forEach((h,c)=>{
        const td = document.createElement('td');
        const val = row[c];
        let html = '';
        // Department column
        if (c===0) {
          html = `<strong>${val??''}</strong>`;
        } else {
          const isPercent = String(h).toLowerCase().includes('percent') || String(h).includes('%');
          const disp = (val===undefined||val===null) ? '' : val;
          // Value
          html += `<div>${disp===undefined?'':disp}</div>`;
          // Percent bar
          if (isPercent) {
            const p = parsePercentLike(val);
            if (p!==null) html += `<div class="percent-bar"><div class="fill" style="width:${Math.max(0,Math.min(100,p))}%;"></div></div>`;
          }
          // Delta
          const prevRow = Array.isArray(prevRows) ? prevRows.find(r => r[0]===row[0]) : null;
          if (prevRow) {
            const mapped = getPrevIdx(h, c, prevMaps);
            const prevVal = prevRow[mapped];
            let diff = 0, chipClass='orange', label='0';
            if (isPercent) {
              const cur = parsePercentLike(val); const prv = parsePercentLike(prevVal);
              if (cur!==null && prv!==null) {
                diff = cur - prv;
                if (diff>0.0001) { chipClass='green'; }
                else if (diff<-0.0001) { chipClass='red'; }
                label = (diff>0?'+':'') + diff.toFixed(1) + '%';
              }
            } else {
              const cur = parseNumber(val); const prv = parseNumber(prevVal);
              if (cur!==null && prv!==null) {
                diff = cur - prv;
                if (diff>0) chipClass='green'; else if (diff<0) chipClass='red';
                label = (diff>0?'+':'') + diff;
              }
            }
            html += ` <span class="chip ${chipClass}">${label}</span>`;
          }
        }
        td.innerHTML = html; tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    // Totals row
    const totals = new Array(headers.length).fill('');
    for (let c=1; c<headers.length; c++){
      const h = headers[c];
      const isPercent = String(h).toLowerCase().includes('percent') || String(h).includes('%');
      if (isPercent){
        let sum=0, count=0; rows.forEach(r=>{ const p=parsePercentLike(r[c]); if (p!==null){ sum+=p; count++; }});
        if (count>0) totals[c] = (sum/count).toFixed(1) + '%';
      } else {
        let sum=0; rows.forEach(r=>{ const n=parseNumber(r[c]); if (n!==null) sum+=n; });
        totals[c] = sum;
      }
    }
    const trTot = document.createElement('tr');
    headers.forEach((h,c)=>{
      const td = document.createElement('td');
      if (c===0) { td.innerHTML = '<strong>Totals</strong>'; }
      else {
        const val = totals[c];
        let html = `<strong>${val!==undefined?val:''}</strong>`;
        // Prev totals and delta
        const prevMaps = buildPrevMaps(prevHeaders);
        if (previous) {
          const prevIdx = getPrevIdx(h, c, prevMaps);
          let prevTotal = null;
          const isPercent = String(h).toLowerCase().includes('percent') || String(h).includes('%');
          if (isPercent){
            let sum=0, count=0; prevRows.forEach(r=>{ const p=parsePercentLike(r[prevIdx]); if (p!==null){ sum+=p; count++; }});
            if (count>0) prevTotal = sum/count;
          } else {
            let sum=0; prevRows.forEach(r=>{ const n=parseNumber(r[prevIdx]); if (n!==null) sum+=n; });
            prevTotal = sum;
          }
          if (prevTotal!==null) {
            let diff=0, chipClass='orange', label='0';
            if (isPercent){
              const cur = parsePercentLike(val); if (cur!==null){ diff = cur - prevTotal; }
              if (diff>0.0001) chipClass='green'; else if (diff<-0.0001) chipClass='red';
              label = (diff>0?'+':'') + (diff).toFixed(1) + '%';
            } else {
              const cur = parseNumber(val); if (cur!==null){ diff = cur - prevTotal; }
              if (diff>0) chipClass='green'; else if (diff<0) chipClass='red';
              label = (diff>0?'+':'') + diff;
            }
            html += ` <span class="chip ${chipClass}">${label}</span>`;
          }
        }
        td.innerHTML = html; td.className='totals';
      }
      trTot.appendChild(td);
    });
    tbody.appendChild(trTot);

    contentEl.innerHTML = '';
    contentEl.appendChild(table);
  }

  async function loadAndRender(){
    try{
      if (!collegeId || !reportId) { setStatus('Missing parameters', 'error'); contentEl.textContent='Missing collegeId/reportId'; return; }
      setStatus('Loading report...');
      const res = await fetch(`/api/colleges/${collegeId}/reports/${reportId}`, { credentials:'include' });
      const json = await res.json();
      if (!json.success || !json.report || !json.report.data) throw new Error('Report not found');
      const report = json.report;
      const headers = report.data.headers || []; const rows = report.data.rows || [];
      const meta = report.data?.meta || {};

      // Load previous for deltas
      const templateKey = report.templateKey || report.data?.meta?.templateKey || '';
      let previous = null;
      try {
        const pr = await fetch(`/api/previous-report/${collegeId}?templateKey=${encodeURIComponent(templateKey)}`, { credentials:'include' });
        const pj = await pr.json(); previous = pj.previousData || pj.data || null;
      } catch(_) {}

      renderTable(headers, rows, previous, meta);
      setStatus('Loaded');

      // Enable download handler with current table
      document.getElementById('btnDownload').onclick = async () => {
        try{
          setStatus('Preparing Excel...');
          const payload = { headers, rows, name: report.name||'Report', createdAt: report.createdAt, meta: { templateKey, templateName: report.templateName||report.data?.meta?.templateName||null, headerColorClasses: meta.headerColorClasses||{}, headerHexColors: meta.headerHexColors||{} } };
          const res = await fetch('/api/export-excel', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
          if (!res.ok) throw new Error('Export failed');
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download=(report.name||'report')+'.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          setStatus('Downloaded','success');
        }catch(e){ setStatus('Export failed: '+e.message,'error'); }
      };

      document.getElementById('btnBaseline').onclick = async () => {
        try{
          setStatus('Marking as baseline...');
          const res = await fetch(`/api/colleges/${collegeId}/reports/${reportId}/use-as-previous`, { method:'POST', credentials:'include' });
          const j = await res.json(); if (!j.success) throw new Error(j.error||'Failed');
          setStatus('Marked as baseline','success');
        }catch(e){ setStatus('Baseline failed: '+e.message,'error'); }
      };

      document.getElementById('btnBack').onclick = () => {
        window.location.href = `college-dashboard.html?id=${encodeURIComponent(collegeId)}&tab=reports`;
      };

    }catch(e){
      console.error(e); setStatus('Load failed: '+e.message,'error'); contentEl.textContent = 'Failed to load report.';
    }
  }

  loadAndRender();
</script>
</body>
</html>
